<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />

<title>maps | jckr.github.io/blog</title>

<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="/xmlrpc.php">
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="jckr.github.io/blog &raquo; Feed" href="/feed/" />
<link rel="alternate" type="application/rss+xml" title="jckr.github.io/blog &raquo; Comments Feed" href="/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="jckr.github.io/blog &raquo; maps Tag Feed" href="/tag/maps/feed/" />
<!-- This site uses the Google Analytics by MonsterInsights plugin v7.0.5 - Using Analytics tracking - https://www.monsterinsights.com/ -->
<!-- Note: MonsterInsights is not currently configured on this site. The site owner needs to authenticate with Google Analytics in the MonsterInsights settings panel. -->
<!-- No UA code set -->
<!-- / Google Analytics by MonsterInsights -->
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/localhost:8888\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.10"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='YoutubeShortcodeMargenn-css'  href='/wp-content/plugins/youtube-shortcode/youtube-shortcode.css?ver=4.6.10' type='text/css' media='all' />
<link rel='stylesheet' id='casper-google-fonts-css'  href='//fonts.googleapis.com/css?family=Noto+Serif%3A400%2C700%2C400italic%7COpen+Sans%3A700%2C400&#038;ver=4.6.10' type='text/css' media='all' />
<link rel='stylesheet' id='casper-style-css'  href='/wp-content/themes/casper/style.css?ver=4.6.10' type='text/css' media='all' />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.6.10" />

   	<style type="text/css">
					.blog-title a, .blog-description, .social-icons a { color: #222222; }
		
						                
		
							.main-navigation a { color: ; }
		                                            </style>
    		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
			<style type="text/css">
			.site-title a,
		.site-description {
			color: #222222;
		}
		</style>
	<style type="text/css" id="syntaxhighlighteranchor"></style>
</head>

<body class="archive tag tag-maps tag-237 group-blog">

<header id="masthead" role="banner" class="site-head site-header" style="background-image: url(/wp-content/uploads/2018/04/Screenshot-2018-04-09-19.38.59.png);">
    <nav id="site-navigation" class="main-navigation" role="navigation">
        <div>
            <h1 class="menu-toggle">
                <a class="icon-bars" href="#">
                    <span class="hidden">Menu</span>
                </a>
            </h1>
            <a class="skip-link screen-reader-text" href="#content">Skip to content</a>
            <div class="menu"><ul><li ><a href="/">Home</a></li></ul></div>
        </div>
    </nav><!-- #site-navigation -->

    <div class="vertical-row">
        <div class="vertical">
            <div class="site-head-content inner">
                
                <div class="social-icons">
                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                <h1 class="blog-title"><a class="blog-logo" href='/' rel='home'>jckr.github.io/blog</a></h1>
                <h2 class="blog-description">Just another WordPress site</h2>
            </div>
        </div>
    </div>
</header><!-- #masthead -->

<main id="content" class="content" role="main">

	<section id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			<header class="page-header">
				<h1 class="page-title">
					maps				</h1>
							</header><!-- .page-header -->

						
				
<article id="post-917" class="post-917 post type-post status-publish format-standard hentry category-data-visualization tag-contest tag-maps tag-real-estate tag-tableau">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/06/09/and-tableau-contest-results/" rel="bookmark"><time class="entry-date published" datetime="2011-06-09T18:57:49+00:00">June 9, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/data-visualization/" rel="category tag">data visualization</a>			</span>
		        <h1 class="post-title"><a href="/2011/06/09/and-tableau-contest-results/" rel="bookmark">&#8230; and tableau contest results</a></h1>
         
    </header>
	<section class="post-content">

		<p>have been <a href="http://www.tableausoftware.com/about/blog/2011/06/dozens-vizzes-shine-tableau-interactive-viz-contest-11481">announced</a>. <a href="http://jckr.github.io/blog/blog/2011/06/03/tableau-contest-2011/">My entry</a> got honorary mentions which is the best I could hope for not being based in the US! anyway, the rewards is going through the process, seeing what <a href="http://www.datadrivenconsulting.com/2011/05/the-us-has-3-years-of-oil-in-the-ground-oil-exports-imports-and-consumption/">others</a> <a href="http://vizwiz.blogspot.com/2011/06/tableau-viz-contest-support-my-entry.html">have</a> <a href="http://russiansphinx.blogspot.com/2011/05/prices-of-real-estate-by-moscow.html">done</a>. and learn from the process. </p>
<p>I was pleasantly surprised to see that Agnieszka &#8211; Russian Sphinx chose a subject similar to mine &#8211; real estate, but in Moscow. Here&#8217;s her entry:<br />
<script type="text/javascript" src="http://public.tableausoftware.com/javascripts/api/viz_v1.js"></script><object class="tableauViz" width="654" height="732" style="display:none;"><param name="host_url" value="http%3A%2F%2Fpublic.tableausoftware.com%2F" /><param name="name" value="Moscow_prices&#47;Dashboard1" /><param name="tabs" value="no" /><param name="toolbar" value="yes" /><param name="animate_transition" value="yes" /><param name="display_static_image" value="yes" /><param name="display_spinner" value="yes" /><param name="display_overlay" value="yes" /><param name="host_url" value="http%3A%2F%2Fpublic.tableausoftware.com%2F" /><param name="animate_transition" value="yes" /><param name="display_static_image" value="yes" /><param name="display_spinner" value="yes" /><param name="display_overlay" value="yes" /></object><noscript>Prices of real estate by Moscow Districts in April 2011 (Click district to filter, keep Shift to select more districts. Click in white space to remove filter) <br /><a href="#"><img alt="Prices of real estate by Moscow Districts in April 2011 (Click district to filter, keep Shift to select more districts. Click in white space to remove filter) " src="http:&#47;&#47;public.tableausoftware.com&#47;static&#47;images&#47;Mo&#47;Moscow_prices&#47;Dashboard1&#47;1_rss.png" height="100%" /></a></noscript>
<div style="width:654px;height:22px;padding:0px 10px 0px 0px;color:black;font:normal 8pt verdana,helvetica,arial,sans-serif;">
<div style="float:right; padding-right:8px;"><a href="http://www.tableausoftware.com/public?ref=http://public.tableausoftware.com/views/Moscow_prices/Dashboard1" target="_blank">Powered by Tableau</a></div>
</div>
<p>Now she and I used a different approach to display our map and I didn&#8217;t really comment on how I made mine (let alone how she made hers)<br />
Here&#8217;s my map for the record:<br />
<script type="text/javascript" src="http://public.tableausoftware.com/javascripts/api/viz_v1.js"></script><object class="tableauViz" width="654" height="719" style="display:none;"><param name="host_url" value="http%3A%2F%2Fpublic.tableausoftware.com%2F" /><param name="name" value="contest2011&#47;WMap" /><param name="tabs" value="no" /><param name="toolbar" value="yes" /><param name="animate_transition" value="yes" /><param name="display_static_image" value="yes" /><param name="display_spinner" value="yes" /><param name="display_overlay" value="yes" /></object><noscript>Real-estate transactions in Manhattan Residential buildings, 2003-present <br /><a href="#"><img alt="Real-estate transactions in Manhattan Residential buildings, 2003-present " src="http:&#47;&#47;public.tableausoftware.com&#47;static&#47;images&#47;co&#47;contest2011&#47;WMap&#47;1_rss.png" height="100%" /></a></noscript>
<div style="width:654px;height:22px;padding:0px 10px 0px 0px;color:black;font:normal 8pt verdana,helvetica,arial,sans-serif;">
<div style="float:right; padding-right:8px;"><a href="http://www.tableausoftware.com/public?ref=http://public.tableausoftware.com/views/contest2011/WMap" target="_blank">Powered by Tableau</a></div>
</div>
<p>To create my map, I used the default mapping function of Tableau, where you declare the geographic role of two of your measures &#8211; one as latitude, one as longitude &#8211; and you can plot marks on a map, that can be zoomed, panned etc.<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/06/latitude.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/06/latitude.png" alt="" title="latitude" class="aligncenter size-full wp-image-918" /></a><br />
If one of your dimensions is geographical in nature, like a country, US state, US county name or code, Tableau can calculate latitude and longitude so you don&#8217;t have to provide them. This also works for zip codes. So, if you have a valid US address, you can extract the zip code out of that (before you put your data in Tableau) and Tableau can represent this on a map quite accurately.<br />
In my case, I had tens of thousands of marks, which were available at a much finer level than the zip code (sometimes down to the appartment number) so I thought it would be a pity to aggregate them so. My data came with notions like neighborhood or block numbers, which is specific to the New York administration I suppose, but interesting in my context. That idea of block number sounded like the right level of aggregation for my data.<br />
The problem is, how do I get the latitude and longitude of each of the blocks?<br />
How I did this was to chose one address per block, and then geocode it with python and google maps. <a href="http://www.google.com/search?sourceid=chrome&#038;ie=UTF-8&#038;q=geocoding+python&#038;safe=active">Geocoding </a>is the process of converting addresses, well, in geographical coordinates and while doing it in Python does require coding it is trivial and there are many ready-made examples around which can be reused as is.<br />
then, in my data, I put the coordinates of each block for every record. So any building sale can be associated with a laritude and longitude, which is that of their block.<br />
In another view, I have a simpler map &#8211; by neighborhood. Neighborhoods are another proprietary notion, they are groups of blocks. So, I simply average the latitude and longitude of all the buildings in the neighborhood to position their mark.</p>
<p>While it can be desirable to let users interact with the map, in many cases it is not a safe option. Once you let your users unzoom and/or scrool away from the action, it is not obvious for them to get back.<br />
So Agnieszka has used another nifty technique, that of background images.<br />
Her map is really a static file imported with the background image function which is found in the data menu:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/06/background-image.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/06/background-image.png" alt="" title="background image" class="aligncenter size-full wp-image-919" /></a><br />
Like this, the user can really specify what to use for a map, when does it start, where does it end. The map won&#8217;t move afterwards.<br />
However, by doing so one cannot use geographic coordinates to display marks. One has to obtain, outside of Tableau, the x and y coordinates of each mark on the screen. Then, those x and y coordinates can be made into measures, and assigned respectively to the column and row shelves of the viz. </p>
<p>I&#8217;ll let you figure out which one is best for your next map project. Note that you can generate highly customizable map backgrounds with a service like <a href="http://www.cloudmade.com/">cloudmade</a>.</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-661" class="post-661 post type-post status-publish format-standard hentry category-data-visualization category-protovis tag-exports tag-france tag-maps tag-trade tag-treemaps">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/18/la-france-qui-exporte/" rel="bookmark"><time class="entry-date published" datetime="2011-02-18T20:10:38+00:00">February 18, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/18/la-france-qui-exporte/" rel="bookmark">La france qui exporte</a></h1>
         
    </header>
	<section class="post-content">

		<p>This week, I was made aware of a new set of maps by French ministry of Foreign Trade, called <em>cartographie de la France qui exporte</em> (map of France exports) (<a href="http://www.exporter.gouv.fr/exporter/Pages.aspx?iddoc=1821&#038;pex=1-2-40-926-1821">link</a>). Since I&#8217;m interested in the topic and that I know that French public services have killer cartographers I was eager to see what was so exciting about the first set of online maps on French exports. </p>
<p>I was a little underwhelmed to be honest. Online here meant static pdf files, although this is a dataset that just begs to be explored and manipulated.<br />
On top of that, those where basic choropleth maps with markers such as this one here:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/largemap.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/largemap.png" alt="" title="largemap" width="626" height="631" class="size-full wp-image-662" /></a></p>
<p>Now this map has two problems. First, it&#8217;s a choropleth with a discrete scale, but the values of adjacent areas can vary a lot. So, if you look at this portion of the map, what can be deduced on the values? not much I&#8217;m afraid.<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/choropleth.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/choropleth.png" alt="" title="choropleth" width="123" height="132" class="aligncenter size-full wp-image-663" /></a></p>
<p>Second, it&#8217;s difficult to compare the marks on the map. Which region has the biggest? the smallest? how do two specific regions compare? with this representation, this type of question is even more difficult to answer than with a table.<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/marks-only.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/marks-only.png" alt="" title="marks only" width="313" height="316" class="aligncenter size-full wp-image-664" /></a></p>
<p>Also these charts answer one partial question. So this one, here, shows which region exports most food products. But to where? and how about the imports and balance? now if one given view was the most relevant and could illustrate some important finding, it can be highlighted but here the website gives us collections of many of such maps. As a citizen I&#8217;m leaving no more informed than I was.</p>
<p>Not being the one to criticize without proposing an alternative, I whipped out an <strong>interactive exploratory tool of France trade flows</strong>.<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/franceexport.html" target=”_blank”><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/treemap.png" alt="" title="treemap" width="561" height="443" class="aligncenter size-full wp-image-668" /></a><br />
(The interactive vis is too wide to conveniently fit in a blog, but clicking on the image will open it in a new tab).</p>
<p>I don&#8217;t have access to the same dataset so I can&#8217;t show a strict equivalent. My data comes from <a href="http://comtrade.un.org/">COMTRADE</a>, the UN database of trade flows, and shows all exports and imports to France in 2009. They are not broken down by region or by type of company, but I got the flows by partner country and product category.<br />
The idea is that one can select something on one treemap to update the other. Also, it&#8217;s possible to alternate between a categorical view (where all groups of products and continents look neatly separated) and a view of the balance, which quickly shows which products or which countries get the bulk of French trade. </p>
<hr>
(technical explanation follows for those interested in the code proper)<br />
Now following last week&#8217;s <a href="http://jckr.github.io/blog/?p=426">tutorial</a>, of course it had to be done in <a href="http://www.protovis.org/">protovis</a>.<br />
Actually it illustrates some interesting principles of working with arrays, trees, maps etc. </p>
<p>First, I want to do as much data manipulation as possible in protovis as opposed to manually. So, my source <a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/data.js">data</a> for the treemap is stored as an array of associative arrays, which is probably the preferred form in protovis. This is no different than, for instance, <a href="http://jckr.github.io/blog/?p=534">Protovis&#8217;s barley example</a>.<br />
Now how do you get something of the shape &#8211;</p>
<pre class="brush: jscript; title: ; notranslate" title="">var data=
[{com:&quot;02&quot;,cat:0,cou:4,con:3,imp:0,exp:101421},
{com:&quot;03&quot;,cat:0,cou:4,con:3,imp:9716,exp:0},
{com:&quot;04&quot;,cat:0,cou:4,con:3,imp:0,exp:9272355},
{com:&quot;05&quot;,cat:0,cou:4,con:3,imp:531587,exp:0},
{com:&quot;07&quot;,cat:0,cou:4,con:3,imp:0,exp:83360},
...
{com:&quot;08&quot;,cat:0,cou:4,con:3,imp:0,exp:2779}</pre>
<p>to something shaped like a tree like:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var tree=
{0: {
       02: 101421,
       03: 0,
       04: 9272355,
       05: 0,
       07:83360},
...</pre>
<p>The solution is to use the rollup method. </p>
<p>First, if you look at my individual records, they are of the shape: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{com:&quot;04&quot;,cat:0,cou:4,con:3,imp:0,exp:9272355}</pre>
<p>where com is commodity code, cat is product category, cou is country, con is continent, imp is imports and exp is exports. </p>
<p>For any country + commodity combination, there will be <strong>only one record</strong>.<br />
What I&#8217;m interested to get in the tree I will use for the treemap are <strong>exports</strong>. That is what will determine the size of the leaves of the tree.</p>
<p>So&#8230;<br />
first I am going to nest my array:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var byProduct=pv.nest(data) 
	.key(function(d) {return d.cou;})
	.key(function(d) {return d.cat;})
	.key(function(d) {return d.com;})</pre>
<p>once I have written this I could follow up with a .entries() statement which would return me a nested array, or with rollup() which could give me the tree I need.<br />
Since, again, there is only one record for a combination of country (cou) and commodity (com), I can use any aggregation I want. </p>
<p>I define this function: </p>
<pre class="brush: jscript; title: ; notranslate" title="">function rollup(data) {return pv.sum(data, function(d) {return d.exp;});} </pre>
<p>It returns the sum of all the export values. Since there is just one record, what it does is that it gives me the one export value I need in a tree form. </p>
<p>So the complete statement is:</p>
<pre class="brush: jscript; title: ; notranslate" title="">function rollup(data) {return pv.sum(data, function(d) {return d.exp;});} 

var byProduct=pv.nest(data) 
	.key(function(d) {return d.cou;})
	.key(function(d) {return d.cat;})
	.key(function(d) {return d.com;})
	.rollup(rollup)</pre>
<p>This creates a tree, nested by country, then by product category, then by commodity. The corresponding values are the exports.</p>
<p>now creating my treemap data dynamically saves me a ton of hassle compared to trying to come up with a data file of the right shape and size, not mentioning the calculation errors which creep in each manual manipulation !</p>
<p>Another point of interestingness: how I computed the data to create the bar charts on the side.<br />
For the left treemap (and left bar chart) the user has selected a country. (and for the right ones, it&#8217;s a given product, but let&#8217;s focus on the left side, the reasoning is the same for the other side anyway).</p>
<p>so first I am going to take the tree we made earlier and just look at the selected country. We can do that with a statement like: </p>
<pre class="brush: jscript; title: ; notranslate" title="">myProductTree=byProduct[selCountry];</pre>
<p>(so now we have a tree with just 2 levels, product category and commodity).</p>
<p>Now I can&#8217;t run pv.nest and all that on a tree. I need an array! so I have to use flatten to turn that section of the tree into a bona fide array which I will be able to further process. </p>
<pre class="brush: jscript; title: ; notranslate" title="">catsByCountry = pv.flatten(myProductTree).key(&quot;cat&quot;).key(&quot;com&quot;).key(&quot;exp&quot;).array(); </pre>
<p>Here, note that the arguments: &#8220;cat&#8221;, &#8220;com&#8221;, &#8220;exp&#8221; are completely arbitrary. But, since I&#8217;m recreating the array almost as it originally was, I might as well use the same names for the keys. </p>
<p>So now, I have like a little subset of my original dataset, only the records of the selected country.<br />
I can now proceed to sum exports by categories using a standard rollup method, just as <a href="http://jckr.github.io/blog/?p=502">we&#8217;ve seen here</a>. </p>
<pre class="brush: jscript; title: ; notranslate" title="">catsByCountry = pv.nest(catsByCountry).key(function(d) {return d.cat;}).rollup(rollup);</pre>
<p>Conveniently, the rollup function that I defined earlier sums the records! and here I do need summing, not any aggregation. </p>
<p>The problem is that the rollup() method creates an associative array, and if I need to use that in a bar chart I need a proper array! so, I use pv.values() which does just that, it creates an array out of the values of an associative array. </p>
<pre class="brush: jscript; title: ; notranslate" title="">catsByCountry = pv.values(catsByCountry);</pre>
<p>Now the values can vary a lot in absolute terms depending on the selected country. This is why in the actual bar chart, I use pv.normalize() to have only values from 0 to 1 which are much more convenient to plot. </p>
<pre class="brush: jscript; title: ; notranslate" title="">vis.add(pv.Bar)
	.data(function() pv.normalize(catsByCountry))</pre>
<p>one last thing, to save space in the data set (which means: bandwidth + loading time) I&#8217;ve used short keys in my data file, and I&#8217;ve used codes for countries, commodities and the like. </p>
<p>so I have this: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{com:&quot;04&quot;,cat:0,cou:4,con:3,imp:0,exp:9272355}</pre>
<p>instead of </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{
    com:&quot;CEREALS,CEREAL PREPRTNS.&quot;,
    cat:&quot;Food and live animals&quot;,
    cou:&quot;Algeria&quot;,
    con:&quot;Africa&quot;,
    imp:0,exp:9272355}</pre>
<p>to get the names of the countries, categories etc. I have in my data file variables that associate, say, a country code to its long name, its continent etc.<br />
so I can have to write things like: </p>
<pre class="brush: jscript; title: ; notranslate" title="">countries[&quot;4&quot;].name+&quot; (&quot;+continents[countries[&quot;4&quot;].continent]+&quot;)&quot;</pre>
<p>instead of something simpler, but it&#8217;s a good trade-off because writing those names in full in the original dataset inflates the size of the file to megabytes (there are approx 10.000 records).</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-502" class="post-502 post type-post status-publish format-standard hentry category-charts category-data-visualization category-protovis category-tips tag-aggregation tag-hierarchy tag-maps tag-nesting tag-protovis tag-rollup tag-trees">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/11/working-with-data-in-protovis-part-4-of-5/" rel="bookmark"><time class="entry-date published" datetime="2011-02-11T02:51:39+00:00">February 11, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/charts/" rel="category tag">charts</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/11/working-with-data-in-protovis-part-4-of-5/" rel="bookmark">Working with data in protovis &#8211; part 4 of 5</a></h1>
         
    </header>
	<section class="post-content">

		<p><a href="http://jckr.github.io/blog/?p=494">Previous: array functions in javascript and protovis</a></p>
<h2>Reshaping complex arrays</h2>
<p>This really is what protovis data processing is all about.<br />
In today&#8217;s tutorial, I am going to refer extensively to protovis&#8217;s <a href="http://vis.stanford.edu/protovis/ex/barley.html">Becker&#8217;s Barley</a> example. One reason for that is that it&#8217;s also used in the <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Nest.html">API documentation of the methods</a> we are going to cover, and also because I am posting <a href="http://jckr.github.io/blog/?p=534">a line-by-line explanation of this example</a> that you can refer to.</p>
<p>So far we’ve seen that :</p>
<ul>
<li>Associative arrays are great as data elements, as their various values can be used for various attributes.<br />
For instance, if the current data element is an associative array of this shape: </p>
<pre class="brush: jscript; title: ; notranslate" title="">{ yield: 27.00000, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;University Farm&quot; }</pre>
<p>one could imagine a bar chart where the length of the  bar would come from the yield, their fillStyle color from the variety, the label from the site, etc.</li>
<li>arrays of associative arrays are very practical to manipulate thanks to accessor functions.<br />
An array of the shape:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var barley = [
  { yield: 27.00000, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;University Farm&quot; },
  { yield: 48.86667, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Waseca&quot; },
  { yield: 27.43334, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Morris&quot; },
  { yield: 39.93333, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Crookston&quot; },
  { yield: 32.96667, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Grand Rapids&quot; },
  { yield: 28.96667, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Duluth&quot; },
  { yield: 43.06666, variety: &quot;Glabron&quot;, year: 1931, site: &quot;University Farm&quot; },
  { yield: 55.20000, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Waseca&quot; },
  { yield: 28.76667, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Morris&quot; },
  { yield: 38.13333, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Crookston&quot; },
  { yield: 29.13333, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Grand Rapids&quot; },
  { yield: 29.66667, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Duluth&quot; },
  { yield: 35.13333, variety: &quot;Svansota&quot;, year: 1931, site: &quot;University Farm&quot; },
…
  { yield: 29.33333, variety: &quot;Wisconsin No. 38&quot;, year: 1932, site: &quot;Duluth&quot; }
]</pre>
<p>could be easily sorted according to any of the keys – yield, variety, year, site, etc.</li>
<li>it is easy to access the data of an element’s parent, and in some cases it can greatly simplify the code.</li>
</ul>
<h3>Nesting</h3>
<p>For this last reason, you may want to turn one flat array of associative arrays into an array of arrays of associative arrays. This process is called <strong>nesting</strong>.</p>
<p><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/nesting.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/nesting.png" alt="" title="nesting" width="700" height="250" class="aligncenter size-full wp-image-528" /></a></p>
<h4>Simple nesting</h4>
<p>If you turn a <strong>single array</strong> like the one on the left-hand side to <strong>an array of arrays</strong> like on the right-hand side, you could easily do 3 smaller charts, one next to the other, by creating them inside of panels. You could have some information at this panel level (for instance the variety) and the rest at a lower level. </p>
<p>Fortunately, there are protovis methods that can turn your flat list into a more complex array of arrays. And since protovis methods are meant to be chained, you can even go on and create arrays of arrays of arrays of arrays if needs be.<br />
Even better – combined with the other data processing functions, you don’t only change the structure of your array, but you can also filter and control the order of the elements to show everything that you want and only what you want.</p>
<p>And how complicated can this be?<br />
To do the above, all you have to type is </p>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley).key(function(d) d.variety).entries();</pre>
<p>What this does is that it nests your <em>barley</em> array, according to the <em>variety</em> key. entries() at the end is required to obtain the array of arrays needed.</p>
<p>Here is an example of what can be done with both kinds of data structures in just a few lines of code (which won&#8217;t include the data proper. The long, flat array is stored in the variable barley, as above).<br />
Without nesting:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithoutNesting.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithoutNesting.png" alt="" title="BarleyWithoutNesting" width="606" height="198" class="aligncenter size-full wp-image-594" /></a></p>
<pre class="brush: jscript; title: ; notranslate" title="">var vis = new pv.Panel()
    .width(600)
    .height(200)
;
vis.add(pv.Bar)
	.data(barley)
	.left(function() this.index*5)
	.width(4)
	.bottom(0)
	.height(function(d) d.yield*2)
	.fillStyle(function(d) d.year==1931?&quot;steelBlue&quot;:&quot;Orange&quot;)
;
vis.render();</pre>
<p>As the pv.Bar goes through the array, there is not much it can do to structure it. We can just size the bars according to the value of yield, and color them according to another key (here the year).</p>
<p>Now using nesting:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithNesting2.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithNesting2.png" alt="" title="BarleyWithNesting2" width="711" height="160" class="aligncenter size-full wp-image-598" /></a></p>
<pre class="brush: jscript; highlight: [1,8,15]; title: ; notranslate" title="">barley2=pv.nest(barley).key(function(d) d.variety).entries();
barley2=pv.nest(barley).key(function(d) d.variety).entries();
var vis = new pv.Panel()
    .width(710)
    .height(150)
;
var cell=vis.add(pv.Panel)
	.data(barley2)
	.left(function() this.index*70)
	.width(70)
	.top(0)
	.height(150);
cell.anchor(&quot;top&quot;).add(pv.Label).textAlign(&quot;center&quot;).font(&quot;9px sans-serif&quot;).text(function(d) d.key)
cell.add(pv.Bar)
		.data(function(d) d.values)
		.left(function() 5+this.index%6*10)
		.width(8)
		.bottom(0)
		.height(function(d) d.yield*2)
		.fillStyle(function(d) d.year==1931?&quot;steelBlue&quot;:&quot;Orange&quot;)
		.add(pv.Label).text(function(d) d.site).textAngle(-Math.PI/2)
			.textAlign(&quot;left&quot;).left(function() 15+this.index%6*10).textStyle(&quot;#222&quot;)
	;
vis.render();
</pre>
<p>Here we used the same simple nesting command as above (the original example uses a more complicated one which allows for more refinement in the display). This structure allows us to create first panels, which we can style by displaying the name of the sites for instance, then, within these panels, the corresponding bars.</p>
<p>Doing this with the data in its original form would have been possible, but would have required writing a much longer program. So the whole idea of nesting is to <strong>take some time to plan the data structure once, so that the code is as short and useful as possible</strong>.</p>
<h4>Going further with nesting</h4>
<p>However, it is possible to go beyond that: </p>
<ul>
<li>by nesting further, which can be done by adding other .key() methods:</p>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .key(function(d) d.year)
  .entries();</pre>
</li>
</ul>
<p>And/or</p>
<ul>
<li>by sorting keys or values using the sortKeys() and sortValues() methods, respectively. </p>
<p>For instance, we can change the order in which the variety blocks are displayed with sortKeys():</p>
<table>
<tr>
<td>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .entries();</pre>
</td>
<td>
<pre class="brush: jscript; highlight: [3]; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .sortKeys()
  .entries();</pre>
</td>
</tr>
<tr>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-unsorted.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-unsorted.png" alt="" title="sort-unsorted" width="300" height="250" class="aligncenter size-full wp-image-524" /></a></td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-sorted.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-sorted.png" alt="" title="sort-sorted" width="300" height="250" class="aligncenter size-full wp-image-525" /></a></td>
</tr>
</table>
</li>
</ul>
<p>By using sortKeys without argument, the natural order is used (alphabetical, since our key is a string). But we could provide a comparison function if we wanted a more sophisticated arrangement.</p>
<h4>Nesting and hierarchy</h4>
<p>If you run the double nesting command we discussed above, </p>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .key(function(d) d.year)
  .entries();</pre>
<p>you&#8217;ll get as a result something of the form: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var barley=[
  {key:&quot;Manchuria&quot;, values: [
    {key:&quot;1931&quot;, values: [
      {site:&quot;University farm&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 27},
      {site:&quot;Waseca&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 48.86667},
      {site:&quot;Morris&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 27.43334},
      {site:&quot;Crookston&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 39.93333},
      {site:&quot;Grand Rapids&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 32.96667},
      {site:&quot;Duluth&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 28.96667}
    ]},
    {key:&quot;1932&quot;, values: [  
      {site:&quot;University farm&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 26.9},
      {site:&quot;Waseca&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 33.46667},
      {site:&quot;Morris&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 34.36666},
      {site:&quot;Crookston&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 32.96667},
      {site:&quot;Grand Rapids&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 22.13333},
      {site:&quot;Duluth&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 22.56667}
    ]}
  ]},
  {key: &quot;Glabron&quot;, ...
]
</pre>
<p>and so on and so forth for all the varieties of barley. Now how can we use this structure in a protovis script? why not use multi-dimensional arrays instead, and if so, how would the code change?</p>
<p>Well. You&#8217;d start using this structure by creating a first panel and and passing it the nested structure as data.<br />
Assuming your root panel is called vis, you&#8217;d start likewise:</p>
<pre class="brush: jscript; highlight: [2]; title: ; notranslate" title="">
vis.add(pv.Panel)
    .data(barley)</pre>
<p>now, since barley has been nested first by variety, it is now an array of 10 elements. You are going to create 10 individual panels. At some point you should worry about dimensioning and positioning them. But here we are only focusing on passing data to subsequent elements.</p>
<p>Next, you are going to create another set of panels (or any mark, really, this doesn&#8217;t change anything for the data)</p>
<pre class="brush: jscript; first-line: 3; highlight: [4]; title: ; notranslate" title="">.add(pv.Panel)
    .data(function(d) d.values)</pre>
<p>This is how you drill down to the next level of data, by using an accessor function with the key &#8220;values&#8221;.<br />
Congratulations! you have created 2 panels in each of our 10 individual panels, one per year. </p>
<p>Finally, you are going to create a final mark (let&#8217;s say, a pv.Bar)</p>
<pre class="brush: jscript; first-line: 5; highlight: [6]; title: ; notranslate" title="">.add(pv.Bar)
    .data(function(d) d.values)</pre>
<p>Again, you use an accessor function of the same form. This will create a bar chart with 6 bars.<br />
The data element corresponding to each bar is of the form:
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{site:&quot;University farm&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 26.9}</pre>
<p>So, when you style the chart, you can access these properties with accessor functions, and write for instance:</p>
<pre class="brush: jscript; first-line: 7; title: ; notranslate" title="">    .height(function(d) d.yield)
    .add(pv.Label).text(function(d) d.variety)</pre>
<p>etc.</p>
<p>To sum it up: you can create a hierarchical structure in protovis that corresponds to the shape of your nested array by adding elements and passing data using an accessor function with the key &#8220;values&#8221;.<br />
At the lowest level of your structure you can access all the properties of the original array using accessor functions.</p>
<p>Now, what if instead we used a multi-dimensional, normal array without keys and values? don&#8217;t they have structure and hierarchy, too?<br />
This is not only possible, but also advised when your dataset is getting really big, as you would plague your users with annoying loading times. This changes the structure of the code though. </p>
<p>An equivalent multi-dimensional array would be something like: </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var yields =
[ // this is the level of the variety
  [ // this is the level of the year
    [ 27, 48.86667, 27.43334, 39.93333, 32.96667, 28.96667], 
    [ 26.9, 33.46667, 34.36666, 32.96667, 22.13333, 22.56667]
  ],
  [ 
    [ 43.06666, 55.2, 28.76667, 38.13333, 29.13333, 29.66667],
    [ 36.8, 37.73333, 35.13333, 26.16667, 14.43333, 25.86667]
  ],
  [
    [ 35.13333, 47.33333, 25.76667, 40.46667, 29.66667, 25.7],
    [ 27.43334, 38.5, 35.03333, 20.63333, 16.63333, 22.23333]
  ],
  [
    [ 39.9, 50.23333, 26.13333, 41.33333, 23.03333, 26.3],
    [ 26.8, 37.4, 38.83333, 32.06666, 32.23333, 22.46667]
  ],
  [
    [ 36.56666, 63.8333, 43.76667, 46.93333, 29.76667, 33.93333],
    [ 29.06667, 49.2333, 46.63333, 41.83333, 20.63333, 30.6]
  ],
  [
    [ 43.26667, 58.1, 28.7, 45.66667, 32.16667, 33.6],
    [ 26.43334, 42.2, 43.53334, 34.33333, 19.46667, 22.7]
  ],
  [
    [ 36.6, 65.7667, 30.36667, 48.56666, 24.93334, 28.1],
    [ 25.56667, 44.7, 47, 30.53333, 19.9, 22.5]
  ],
  [
    [ 32.76667, 48.56666, 29.86667, 41.6, 34.7, 32],
    [ 28.06667, 36.03333, 43.2, 25.23333, 26.76667, 31.36667]
  ],
  [
    [ 24.66667, 46.76667, 22.6, 44.1, 19.7, 33.06666],
    [ 30, 41.26667, 44.23333, 32.13333, 15.23333, 27.36667]
  ],
  [
    [ 39.3, 58.8, 29.46667, 49.86667, 34.46667, 31.6],
    [ 38, 58.16667, 47.16667, 35.9, 20.66667, 29.33333]
  ]
]</pre>
<p>and that&#8217;s the whole lot. It is indeed shorter. now this array is only the yields, you may want to create an array of the possible values of varieties, sites and years for good measure.</p>
<pre class="brush: jscript; title: ; notranslate" title="">var varieties=[&quot;Manchuria&quot;, &quot;Glabron&quot;, &quot;Svansota&quot;, &quot;Velvet&quot;, &quot;Trebi&quot;,
     &quot;No. 457&quot;, &quot;No. 462&quot;, &quot;Peatland&quot;, &quot;No. 475&quot;, &quot;Wisconsin No. 38&quot;], 
    sites=[&quot;University Farm&quot;, &quot;Waseca&quot;, &quot;Morris&quot;, &quot;Crookston&quot;, &quot;Grand Rapids&quot;, &quot;Duluth&quot;],
    years=[1931,1932];</pre>
<p>And by the way, it is very possible to create these arrays out of the original array using the map() method or equivalent.</p>
<p>how can we create an equivalent structure?<br />
we start like the above:</p>
<pre class="brush: jscript; title: ; notranslate" title="">vis.add(pv.Panel)
     .data(yields)</pre>
<p>Likewise, our 3-dimensional array is really an array of 10 arrays of 2 arrays of 6 elements. So we are also creating 10 panels. Let&#8217;s continue and create panels for the years:</p>
<pre class="brush: jscript; first-line: 3; highlight: [4]; title: ; notranslate" title="">.add(pv.Panel)
    .data(function(d) d)</pre>
<p>To drill down one level in an array, you have to use this form. you say that you are giving the children of your object what&#8217;s inside the data property of their parent. </p>
<p>So naturally, you follow by</p>
<pre class="brush: jscript; first-line: 5; highlight: [6]; title: ; notranslate" title="">.add(pv.Bar)
    .data(function(d) d)</pre>
<p>now how you style your bars will be slightly different than before. What you passed your first panel was an array of yields. So that&#8217;s what you get now from your data. If you want something else, you&#8217;ll have to get it with this.index for instance.</p>
<pre class="brush: jscript; first-line: 7; title: ; notranslate" title="">    .height(function(d) d) // that's the yield
    .add(pv.Label).text(function() varieties[this.index])</pre>
<p>All in all it&#8217;s trickier to work with arrays. The code is less explicit, and if you change one array even by accident, you&#8217;ll have to check that others are still synchronized. But it could make your vis much faster.</p>
<h3>Aggregating</h3>
<p>Sometimes, what you want out of an array is not a more complex array, but a simpler list of numbers. For instance, what if you could obtain the sum of all the values in the array for such or such property? This is also possible in protovis, and in fact, it looks a lot like what we&#8217;ve done. The difference is that instead of using the method entries(), we will use the method rollup().</p>
<p>Let&#8217;s suppose we have a flat array that looks like this: these are scores of students on 3 exams. </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">var scores=[
{student:&quot;Adam&quot;, exam:1, score: 77},
{student:&quot;Adam&quot;, exam:2, score: 34},
{student:&quot;Adam&quot;, exam:3, score: 85},
{student:&quot;Barbara&quot;, exam:1, score: 92},
{student:&quot;Barbara&quot;, exam:2, score: 68},
{student:&quot;Barbara&quot;, exam:3, score: 97},
{student:&quot;Connor&quot;, exam:1, score: 84},
{student:&quot;Connor&quot;, exam:2, score: 54},
{student:&quot;Connor&quot;, exam:3, score: 37},
{student:&quot;Daniela&quot;, exam:1, score: 61},
{student:&quot;Daniela&quot;, exam:2, score: 58},
{student:&quot;Daniela&quot;, exam:3, score: 64}
]</pre>
<p>Now, we would like to get, in one simple object, the average for each student.<br />
We know we could reshape the array if we wanted by using pv.Nest and entries(): </p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.nest(scores).key(function(d) d.student).entries()</pre>
<p>This would be something of the shape: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">
[{key:&quot;Adam&quot;, values:[
    {exam:1, score: 77, student: &quot;Adam&quot;},
    {exam:2, score: 34, student: &quot;Adam&quot;},
    {exam:3, score: 85, student: &quot;Adam&quot;}
    ]
  },
  {key:&quot;Barbara&quot;, values:[
    {exam:1, score: 92, student: &quot;Barbara&quot;},
    {exam:2, score: 68, student: &quot;Barbara&quot;},
    {exam:3, score: 97, student: &quot;Barbara&quot;}
   ]
  },
etc.
</pre>
<p>Useful, for instance, if we&#8217;d want to chart the progress of each student separately. </p>
<p>Now if instead of using entries() at the end, we use rollup(), we could get this: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{
Adam: 65.33333333333333
Barbara: 85.66666666666667
Connor: 58.333333333333336
Daniela: 61}
</pre>
<p>The exact statement is </p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.nest(scores)
  .key(function(d) d.student)
  .rollup(function(data) pv.mean(data, function(d) d.score))</pre>
<p>To understand how this works, it helps to visualize what the pv.nest would have returned if we had asked for entries.<br />
What rollup does is that it would go through each of the values that correspond to the keys, and return one aggregate value, depending on the function. </p>
<p>For the first student, &#8220;Adam&#8221;, the corresponding values array is like this: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">[
    {exam:1, score: 77, student: &quot;Adam&quot;},
    {exam:2, score: 34, student: &quot;Adam&quot;},
    {exam:3, score: 85, student: &quot;Adam&quot;}
    ]</pre>
<p>so rollup will just look at each element of this array and apply the function.<br />
This is what (data) in &#8220;function(data)&#8221; corresponds to.<br />
Next, we tell protovis what to do with these elements. Here, we are interested in the average, so we take pv.mean (not pv.average, <a href="http://jckr.github.io/blog/?p=494">remember</a>?)<br />
However, we can&#8217;t directly compute the average of an array of associative arrays &#8211; we must tell protovis exactly what to average. This is why we use an accessor function, function(d) d.score.</p>
<p>Of course, pv.mean used in this example can be replaced by just about any function.</p>
<p>In the name of clarity, especially if there is only one property that can be aggregated, you can declare a function outside of the rollup() method. This is useful if you are going to aggregate your array by different dimensions:</p>
<pre class="brush: jscript; title: ; notranslate" title="">function meanScore(data) pv.mean(data, function(d) d.score);
var avgStudent=pv.nest(scores)
  .key(function(d) d.student)
  .rollup(meanScore);
var avgExam=pv.nest(scores)
  .key(function(d) d.exam)
  .rollup(meanScore);</pre>
<h3>Flattening</h3>
<p>Protovis also provides methods that turn a &#8220;nested&#8221; array back into a flat array. And methods that turn a normal array into a tree.<br />
The main advantage of having a flat array is that you can nest it in a different way. This is useful, for instance, if you got your data in a nested form that doesn&#8217;t work for you. Likewise, a tree is easier to reshape in protovis than an array.</p>
<p>To create a flat array out of a nested one, you have to use pv.flatten and specify all the keys of the array and conclude by array().</p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">barley=pv.flatten(barley).key(&quot;variety&quot;).key(&quot;site&quot;).key(&quot;year&quot;).key(&quot;yield&quot;).array()</pre>
<p>It&#8217;s important to note that you need to specify all the keys, not just the keys that correspond to actual nesting. So again, if you start from a flat array, and you do</p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">barley=pv.nest(barley).key(&quot;variety&quot;).entries()</pre>
<p>to reverse this, you&#8217;ll have to enter the full formula, using key four times:</p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">barley=pv.flatten(barley).key(&quot;variety&quot;).key(&quot;site&quot;).key(&quot;year&quot;).key(&quot;yield&quot;).array()</pre>
<p>Finally, pv.tree &#8211; well, I haven&#8217;t seen this method used outside the <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Tree.html">documentation</a>. It&#8217;s not used in any live example, not covered by any question in the forum, and I haven&#8217;t found any trace of it in the internet. So I&#8217;d rather leave you with the explanation in the documentation which is fairly clear than come up with my own. If you find yourself in a situation like in the documentation, where you have a flat array of associative arrays, which have a property that could be interpreted as a hierarchy, then you could use this method to turn your array in something more useful to protovis.</p>
<h3>Putting it all together</h3>
<p>Instead of coming up with a specific new example for this section I refer you to my explanation of the <a href="http://jckr.github.io/blog/?p=534">Becker&#8217;s Barley example</a>.<br />
On the same subject, see a comparison of how to <a href="http://jckr.github.io/blog/?p=550">re-create Becker&#8217;s Barley with protovis and Tableau</a></p>
<p>next: <a href="http://jckr.github.io/blog/?p=623">working with layouts</a></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
			
		
		</main><!-- #main -->
	</section><!-- #primary -->

	<div id="secondary" class="widget-area" role="complementary">
		<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form></aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h1 class="widget-title">Recent Posts</h1>		<ul>
					<li>
				<a href="/2016/08/17/the-big-leagues/">The big leagues</a>
						</li>
					<li>
				<a href="/2016/08/17/creating-a-react-visualization-web-app/">Creating a React visualization web app</a>
						</li>
					<li>
				<a href="/2016/08/13/beyond-rendering/">Beyond rendering</a>
						</li>
					<li>
				<a href="/2016/08/11/react-components/">React components</a>
						</li>
					<li>
				<a href="/2016/08/10/coding-with-react/">Coding with React</a>
						</li>
				</ul>
		</aside>		<aside id="recent-comments-2" class="widget widget_recent_comments"><h1 class="widget-title">Recent Comments</h1><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a href='http://omeraz.wordpress.com/' rel='external nofollow' class='url'>עומר עזריאל</a></span> on <a href="/2016/08/17/the-big-leagues/#comment-567">The big leagues</a></li><li class="recentcomments"><span class="comment-author-link">Carlos Ayres</span> on <a href="/2012/05/28/manipulating-data-like-a-boss-with-d3/#comment-312">Manipulating data like a boss with d3</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://migrate.powertripanalytics.com/game-of-thrones-interactions-among-the-top-30-characters/' rel='external nofollow' class='url'>Game of ThronesInteractions Among the Top 30 Characters &#8211; PowerTrip Analytics</a></span> on <a href="/2013/05/13/making-the-game-of-thrones-visualization/#comment-466">Making the game of thrones visualization</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://abgoswam.wordpress.com/2016/10/08/d3-getting-started/' rel='external nofollow' class='url'>D3 &#8211; Getting Started | abgoswam&#039;s tech blog</a></span> on <a href="/2012/09/04/getting-to-hello-world-with-d3/#comment-419">Getting to &#8220;Hello world&#8221; with d3</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://plus.google.com/+BrotoBhattacharjee' rel='external nofollow' class='url'>Broto Bhattacharjee</a></span> on <a href="/2012/09/04/getting-to-hello-world-with-d3/#comment-418">Getting to &#8220;Hello world&#8221; with d3</a></li></ul></aside><aside id="archives-2" class="widget widget_archive"><h1 class="widget-title">Archives</h1>		<ul>
			<li><a href='/2016/08/'>August 2016</a></li>
	<li><a href='/2015/05/'>May 2015</a></li>
	<li><a href='/2015/02/'>February 2015</a></li>
	<li><a href='/2014/10/'>October 2014</a></li>
	<li><a href='/2013/11/'>November 2013</a></li>
	<li><a href='/2013/05/'>May 2013</a></li>
	<li><a href='/2013/03/'>March 2013</a></li>
	<li><a href='/2013/01/'>January 2013</a></li>
	<li><a href='/2012/12/'>December 2012</a></li>
	<li><a href='/2012/11/'>November 2012</a></li>
	<li><a href='/2012/10/'>October 2012</a></li>
	<li><a href='/2012/09/'>September 2012</a></li>
	<li><a href='/2012/07/'>July 2012</a></li>
	<li><a href='/2012/06/'>June 2012</a></li>
	<li><a href='/2012/05/'>May 2012</a></li>
	<li><a href='/2012/04/'>April 2012</a></li>
	<li><a href='/2012/01/'>January 2012</a></li>
	<li><a href='/2011/11/'>November 2011</a></li>
	<li><a href='/2011/10/'>October 2011</a></li>
	<li><a href='/2011/09/'>September 2011</a></li>
	<li><a href='/2011/08/'>August 2011</a></li>
	<li><a href='/2011/07/'>July 2011</a></li>
	<li><a href='/2011/06/'>June 2011</a></li>
	<li><a href='/2011/05/'>May 2011</a></li>
	<li><a href='/2011/04/'>April 2011</a></li>
	<li><a href='/2011/03/'>March 2011</a></li>
	<li><a href='/2011/02/'>February 2011</a></li>
	<li><a href='/2011/01/'>January 2011</a></li>
	<li><a href='/2010/11/'>November 2010</a></li>
	<li><a href='/2010/04/'>April 2010</a></li>
	<li><a href='/2010/03/'>March 2010</a></li>
	<li><a href='/2010/02/'>February 2010</a></li>
	<li><a href='/2010/01/'>January 2010</a></li>
	<li><a href='/2009/12/'>December 2009</a></li>
	<li><a href='/2009/10/'>October 2009</a></li>
	<li><a href='/2009/09/'>September 2009</a></li>
	<li><a href='/2009/08/'>August 2009</a></li>
	<li><a href='/2009/07/'>July 2009</a></li>
	<li><a href='/2009/06/'>June 2009</a></li>
	<li><a href='/2009/05/'>May 2009</a></li>
	<li><a href='/2008/12/'>December 2008</a></li>
	<li><a href='/2008/11/'>November 2008</a></li>
	<li><a href='/2008/10/'>October 2008</a></li>
		</ul>
		</aside><aside id="categories-2" class="widget widget_categories"><h1 class="widget-title">Categories</h1>		<ul>
	<li class="cat-item cat-item-2"><a href="/category/book-review/" >book review</a>
</li>
	<li class="cat-item cat-item-3"><a href="/category/charts/" >charts</a>
</li>
	<li class="cat-item cat-item-4"><a href="/category/conferences/" >conferences</a>
</li>
	<li class="cat-item cat-item-5"><a href="/category/d3/" >d3</a>
</li>
	<li class="cat-item cat-item-6"><a href="/category/dashboards/" >dashboards</a>
</li>
	<li class="cat-item cat-item-7"><a href="/category/data-publishing/" >data publishing</a>
</li>
	<li class="cat-item cat-item-8"><a href="/category/data-visualization/" >data visualization</a>
</li>
	<li class="cat-item cat-item-9"><a href="/category/francais/" >français</a>
</li>
	<li class="cat-item cat-item-10"><a href="/category/javascript/" >javascript</a>
</li>
	<li class="cat-item cat-item-11"><a href="/category/presentation/" >presentation</a>
</li>
	<li class="cat-item cat-item-12"><a href="/category/protovis/" >protovis</a>
</li>
	<li class="cat-item cat-item-13"><a href="/category/react/" >react</a>
</li>
	<li class="cat-item cat-item-14"><a href="/category/tips/" >tips</a>
</li>
	<li class="cat-item cat-item-1"><a href="/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-15"><a href="/category/web-sites/" >web sites</a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta"><h1 class="widget-title">Meta</h1>			<ul>
						<li><a href="/wp-login.php">Log in</a></li>
			<li><a href="/feed/">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="/comments/feed/">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
			</aside>		<div class="clear">&nbsp;</div>
	</div><!-- #secondary -->
	<footer id="colophon" class="site-footer" role="contentinfo">
	    <a class="subscribe icon-feed" href="/feed/"><span class="tooltip">Subscribe!</span></a>
		<div class="site-info inner">
		    <section class="copyright">
		    			    		<a href="https://github.com/lacymorrow/casper" rel="home">Casper WP</a> by Lacy Morrow		    			    </section>
		</div><!-- .site-info -->
	</footer><!-- #colophon -->
</main><!-- /#content -->

<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.9b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='/wp-content/themes/casper/js/main.js?ver=1.0.0'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.10'></script>
<!--stats_footer_test--></body>
</html>
