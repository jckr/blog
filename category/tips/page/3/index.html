<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />

<title>tips | jckr.github.io/blog | Page 3</title>

<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="/xmlrpc.php">
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="jckr.github.io/blog &raquo; Feed" href="/feed/" />
<link rel="alternate" type="application/rss+xml" title="jckr.github.io/blog &raquo; Comments Feed" href="/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="jckr.github.io/blog &raquo; tips Category Feed" href="/category/tips/feed/" />
<!-- This site uses the Google Analytics by MonsterInsights plugin v7.0.5 - Using Analytics tracking - https://www.monsterinsights.com/ -->
<!-- Note: MonsterInsights is not currently configured on this site. The site owner needs to authenticate with Google Analytics in the MonsterInsights settings panel. -->
<!-- No UA code set -->
<!-- / Google Analytics by MonsterInsights -->
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/localhost:8888\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.10"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='YoutubeShortcodeMargenn-css'  href='/wp-content/plugins/youtube-shortcode/youtube-shortcode.css?ver=4.6.10' type='text/css' media='all' />
<link rel='stylesheet' id='casper-google-fonts-css'  href='//fonts.googleapis.com/css?family=Noto+Serif%3A400%2C700%2C400italic%7COpen+Sans%3A700%2C400&#038;ver=4.6.10' type='text/css' media='all' />
<link rel='stylesheet' id='casper-style-css'  href='/wp-content/themes/casper/style.css?ver=4.6.10' type='text/css' media='all' />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.6.10" />

   	<style type="text/css">
					.blog-title a, .blog-description, .social-icons a { color: #222222; }
		
						                
		
							.main-navigation a { color: ; }
		                                            </style>
    		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
			<style type="text/css">
			.site-title a,
		.site-description {
			color: #222222;
		}
		</style>
	<style type="text/css" id="syntaxhighlighteranchor"></style>
</head>

<body class="archive paged category category-tips category-14 paged-3 category-paged-3 group-blog">

<header id="masthead" role="banner" class="site-head site-header" style="background-image: url(/wp-content/uploads/2018/04/Screenshot-2018-04-09-19.38.59.png);">
    <nav id="site-navigation" class="main-navigation" role="navigation">
        <div>
            <h1 class="menu-toggle">
                <a class="icon-bars" href="#">
                    <span class="hidden">Menu</span>
                </a>
            </h1>
            <a class="skip-link screen-reader-text" href="#content">Skip to content</a>
            <div class="menu"><ul><li ><a href="/">Home</a></li></ul></div>
        </div>
    </nav><!-- #site-navigation -->

    <div class="vertical-row">
        <div class="vertical">
            <div class="site-head-content inner">
                
                <div class="social-icons">
                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                <h1 class="blog-title"><a class="blog-logo" href='/' rel='home'>jckr.github.io/blog</a></h1>
                <h2 class="blog-description">Just another WordPress site</h2>
            </div>
        </div>
    </div>
</header><!-- #masthead -->

<main id="content" class="content" role="main">

	<section id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			<header class="page-header">
				<h1 class="page-title">
					tips				</h1>
							</header><!-- .page-header -->

						
				
<article id="post-1211" class="post-1211 post type-post status-publish format-standard hentry category-d3 category-tips tag-d3 tag-tableau tag-treemaps tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2012/04/19/treemaps-in-tableau-can-be-done/" rel="bookmark"><time class="entry-date published" datetime="2012-04-19T13:16:13+00:00">April 19, 2012</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2012/04/19/treemaps-in-tableau-can-be-done/" rel="bookmark">Treemaps in Tableau? can be done.</a></h1>
         
    </header>
	<section class="post-content">

		Tableau can do many things natively but there are a couple of basic primitives that are not built in because they behave somewhat differently from the overall logic. And <a href="http://www.tableausoftware.com/about/blog/2011/05/alternative-tree-maps-0">treemaps is one of them</a>. Then again treemaps are arguably one of the best way to express complex hierarchical information, i.e. to show the proportions in a large dataset.</p>

Fortunately, thanks to Tableau flexibility there are ways to do that. In the tutorial I'm going to cover 2 cases. First, we'll create a somewhat complex treemap off data which will not change in runtime. Then, we'll create mini-treemaps which can change dynamically.</p>
<h2>A complex treemap</h2>
<script type="text/javascript" src="http://public.tableausoftware.com/javascripts/api/viz_v1.js"></script>
<noscript><a href="#"><img alt="ComplexTM " src="http:&#47;&#47;public.tableausoftware.com&#47;static&#47;images&#47;tr&#47;treemaps&#47;ComplexTM&#47;1_rss.png" style="border: none" /></a></noscript><object class="tableauViz" width="604" height="369" style="display:none;"><param name="host_url" value="http%3A%2F%2Fpublic.tableausoftware.com%2F" /><param name="site_root" value="" /><param name="name" value="treemaps&#47;ComplexTM" /><param name="tabs" value="no" /><param name="toolbar" value="yes" /><param name="static_image" value="http:&#47;&#47;public.tableausoftware.com&#47;static&#47;images&#47;tr&#47;treemaps&#47;ComplexTM&#47;1.png" /><param name="animate_transition" value="yes" /><param name="display_static_image" value="yes" /><param name="display_spinner" value="yes" /><param name="display_overlay" value="yes" /><param name="display_count" value="yes" /></object>
<div style="width:604px;height:22px;padding:0px 10px 0px 0px;color:black;font:normal 8pt verdana,helvetica,arial,sans-serif;"><div style="float:right; padding-right:8px;"><a href="http://www.tableausoftware.com/public?ref=http://public.tableausoftware.com/views/treemaps/ComplexTM" target="_blank">Powered by Tableau</a></div></div>
Before we go in the details the main ideas are deceptively simple.</p>
<ul>
	<li>we use the polygon mark,</li>
	<li>we generate the treemap layout outside of tableau.</li>
</ul>
What we want (and what we'll get) is a dataset that can be directly imported in Tableau and -boom- makes a treemap in a few clicks.</p>

To make this dataset we can use d3. The treemap I am making is directly inspired from the <a href="/category/tips/page/3/mbostock.github.com/d3/ex/treemap.html">d3 treemap example</a>. d3 is already computing all of the node positions so what we'll do is modify the program slightly so that it outputs them in a way that can be directly used in Tableau.</p>

Here is the <a href="http://jckr.github.io/blog/wp-content/uploads/2012/04/treemap.html">modified file</a> which you can download and run on your computer. To work it needs to be in the same folder as a <a href="http://jckr.github.io/blog/wp-content/uploads/2012/04/data.js">data file</a> called data.js which will hold your hiearchical data and which has the same structure as the one linked here.</p>

You can just copy/paste the table that's displayed below the treemap and put it in Tableau or save it in a file for good measure. Here is <a href="http://jckr.github.io/blog/wp-content/uploads/2012/04/data.csv">the output</a> of the data file linked above.</p>

Let's take a look at a few rows :</p>
<table>
<tbody>
<tr>
<td>Id</td>
<td>Path</td>
<td>Top-level category</td>
<td>Name</td>
<td>Value</td>
<td>Corner</td>
<td>x</td>
<td>y</td>
</tr>
<tr>
<td>0</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>AgglomerativeCluster</td>
<td>3938</td>
<td>0</td>
<td>89</td>
<td>167</td>
</tr>
<tr>
<td>0</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>AgglomerativeCluster</td>
<td>3938</td>
<td>1</td>
<td>167</td>
<td>167</td>
</tr>
<tr>
<td>0</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>AgglomerativeCluster</td>
<td>3938</td>
<td>2</td>
<td>167</td>
<td>192</td>
</tr>
<tr>
<td>0</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>AgglomerativeCluster</td>
<td>3938</td>
<td>3</td>
<td>89</td>
<td>192</td>
</tr>
<tr>
<td>1</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>CommunityStructure</td>
<td>3812</td>
<td>0</td>
<td>102</td>
<td>138</td>
</tr>
<tr>
<td>1</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>CommunityStructure</td>
<td>3812</td>
<td>1</td>
<td>167</td>
<td>138</td>
</tr>
<tr>
<td>1</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>CommunityStructure</td>
<td>3812</td>
<td>2</td>
<td>167</td>
<td>167</td>
</tr>
<tr>
<td>1</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>CommunityStructure</td>
<td>3812</td>
<td>3</td>
<td>102</td>
<td>167</td>
</tr>
<tr>
<td>2</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>HierarchicalCluster</td>
<td>6714</td>
<td>0</td>
<td>89</td>
<td>192</td>
</tr>
<tr>
<td>2</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>HierarchicalCluster</td>
<td>6714</td>
<td>1</td>
<td>167</td>
<td>192</td>
</tr>
<tr>
<td>2</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>HierarchicalCluster</td>
<td>6714</td>
<td>2</td>
<td>167</td>
<td>236</td>
</tr>
<tr>
<td>2</td>
<td>flare&gt;analytics&gt;cluster</td>
<td>flare</td>
<td>HierarchicalCluster</td>
<td>6714</td>
<td>3</td>
<td>89</td>
<td>236</td>
</tr>
</tbody>
</table>
I'm creating 4 lines per "leaf" node. So in this example which has 220 nodes, that amounts to 880 lines. Why 4? Because to draw a rectangle in Tableau you really need to define 4 corners. This is why there is a column "Corner" which is worth 0,1,2 and 3. This, we will use to tell Tableau to read our corners in bottom left, bottom right, top right, top left order which produces a nice convex rectangle and not a concave hourglass shape.</p>

Now off to Tableau with this data. <a href="http://jckr.github.io/blog/wp-content/uploads/2012/04/complex.png"><img class="aligncenter size-full wp-image-1212" title="complex" src="http://jckr.github.io/blog/wp-content/uploads/2012/04/complex.png" alt="" width="558" height="477" /></a></p>

Now it's just a matter of doing like this screen. Unsurprisingly the columns and rows are going to be determined by x and y. You want a polygon mark, and you absolutely must use your corner measure in the path. For color, you'll have a choice, you can use the top-level category column (as I have) or the full path which will divide your treemap in finer parts. Finally, level of detail: you must use the Id and not the name in case several of your nodes have the same name. It's quite important at this point to uncheck aggregate measures in Analysis. You do NOT want aggregate measures (though it's quite pretty). To be able to use the name, you must first make a measure out of it. And finally, you'll want to update your infotip slightly.</p>

All of this you can see if you download the tableau file.</p>

And voilà! Treemaps for your Tableau workbooks.</p>

<em>Caveat:</em> the polygon mark doesn't support labels so you can't write on top of the small rectangles what they are but that's not the point of the treemap, which is instead to give an immediate first impression of the relative size of large groups of your data, then allow you to explore them, to that end the infotip function works just fine.</p>
<h2>Simpler but dynamic treemaps</h2>
This is fine and dandy if your data doesn't change but it won't scale if you need to make many treemaps based on selections. What to do? You could use pie charts, but let's not.</p>

To that end I've tried to emulate the <a href="http://www.congressspeaks.com/">Congress speaks</a> visualization by <a href="http://periscopic.com/">Periscopic</a>. I really like it. When you've selected representatives at the end of the process you are taken to a screen which shows the following mini-treemap:</p>

<a href="http://jckr.github.io/blog/wp-content/uploads/2012/04/votingrecord.png"><img class="aligncenter size-full wp-image-1213" title="votingrecord" src="http://jckr.github.io/blog/wp-content/uploads/2012/04/votingrecord.png" alt="" width="246" height="166" /></a></p>

There are just 5 rectangles. But they will change for any representative that we choose. Can this be done with Tableau? Obviously.</p>

Now the Tableau part of this is slightly trickier than above. The idea is that we are going to use formulas to generate the coordinates of all 20 corners of the rectangles, in other words we are going to let Tableau calculate the layout. We can do it because the way that rectangles are going to be arranged is quite predictible. There is one on the left, then 4 stacked on the right one on top of the other. Again, we could compute all of these coordinates outside of Tableau but that would be a hassle and so for a large number of cases it becomes easier and more reliable to do this inside of Tableau.</p>
<h3>Data</h3>
For this I have used completely random data. I have <a href="http://www.kleimo.com/random/name.cfm">generated 20 names</a>, and for each I have generated 5 values in a likely range, number of possible votes, number of votes the representative actually voted, number of times they voted yes, number of times they voted yes with their party, and the same for no. (or nay, technically).</p>

At the end of the day I need 20 records per representative (5 rectangles of 4 corners each), so I can either replicate the line 20 times, or use linked tables. The idea is to get something like this for all of the representatives that can somehow get into Tableau.</p>
<table width="640" border="0" cellspacing="0" cellpadding="0"><colgroup> <col span="10" width="64" /> </colgroup>
<tbody>
<tr>
<td width="64" height="17">Id</td>
<td width="64">representative</td>
<td width="64">corner</td>
<td width="64">rectangle</td>
<td width="64">possible votes</td>
<td width="64">total votes</td>
<td width="64">voted yes</td>
<td width="64">yes with party</td>
<td width="64">voted no</td>
<td width="64">no with party</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">0</td>
<td>no against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">1</td>
<td>no against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">2</td>
<td>no against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">3</td>
<td>no against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">0</td>
<td>no vote</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">1</td>
<td>no vote</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">2</td>
<td>no vote</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">3</td>
<td>no vote</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">0</td>
<td>no with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">1</td>
<td>no with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">2</td>
<td>no with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">3</td>
<td>no with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">0</td>
<td>yes against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">1</td>
<td>yes against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">2</td>
<td>yes against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">3</td>
<td>yes against party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">0</td>
<td>yes with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">1</td>
<td>yes with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">2</td>
<td>yes with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
<tr>
<td align="right" height="17">16</td>
<td>Nelson Thiede</td>
<td align="right">3</td>
<td>yes with party</td>
<td align="right">888</td>
<td align="right">784</td>
<td align="right">320</td>
<td align="right">274</td>
<td align="right">464</td>
<td align="right">373</td>
</tr>
</tbody>
</table>
<h3>In Tableau</h3>
In Tableau we are going to use the same idea as above: polygon mark, disable aggregate measures, and use x and y for columns and rows.</p>

Only, x and y are going to be much more complex. Sorry about that. Well, not that complex but definitely longer.</p>

Here's x:</p>

<pre class="brush: plain; title: ; notranslate" title="">

case [rectangle]
when &quot;no vote&quot; then
     case [corner]
       when 0 then 0
       when 1 then (([possible votes]-[total votes])/[possible votes])
       when 2 then (([possible votes]-[total votes])/[possible votes])
       when 3 then 0
     end
else
     case [corner]
       when 0 then (([possible votes]-[total votes])/[possible votes])
       when 1 then 1
       when 2 then 1
       when 3 then (([possible votes]-[total votes])/[possible votes])
   end
end

</pre>

Depending on the rectangle we are trying to draw we can find ourselves in one of two cases (hence the use of case).</p>

If we draw "no vote" then we are on the left of our vis. The left corners are on the leftmost side of the vis (hence value: 0) and the right corners correspond to the proportion of possible votes which where not cast by this representative, which we can compute as ([possible votes]-[total votes])/[possible votes].</p>

In the other case, we are drawing one of the 4 stacked rectangles, so the right corners are on the rightmost side of the vis (hence value: 1) and the left corners correspond to the value we just computed.</p>

And now, y:</p>

<pre class="brush: plain; title: ; notranslate" title="">
case [rectangle]
when &quot;no vote&quot; then
case [corner]
when 0 then 0
when 1 then 0
when 2 then 1
when 3 then 1
end
when &quot;yes against party&quot; then
case [corner]
when 0 then 0
when 1 then 0
when 2 then (([voted yes]-[yes with party])/[total votes])
when 3 then (([voted yes]-[yes with party])/[total votes])
end
when &quot;yes with party&quot; then
case [corner]
when 0 then (([voted yes]-[yes with party])/[total votes])
when 1 then (([voted yes]-[yes with party])/[total votes])
when 2 then ((2*[voted yes]-[yes with party])/[total votes])
when 3 then ((2*[voted yes]-[yes with party])/[total votes])
end
when &quot;no with party&quot; then
case [corner]
when 0 then ((2*[voted yes]-[yes with party])/[total votes])
when 1 then ((2*[voted yes]-[yes with party])/[total votes])
when 2 then ((2*[voted yes]+[no with party]-[yes with party])/[total votes])
when 3 then ((2*[voted yes]+[no with party]-[yes with party])/[total votes])
end
when &quot;no against party&quot; then
case [corner]
when 0 then ((2*[voted yes]+[no with party]-[yes with party])/[total votes])
when 1 then ((2*[voted yes]+[no with party]-[yes with party])/[total votes])
when 2 then 1
when 3 then 1
end
end
</pre>

y is longer but this is the same general idea. For the "no vote" rectangle, the corners are either to the top or bottom of the vis. But for the other, we can predict where the rectangle will start and when it will end, as a proportion of the [possible votes] field. The values we want are going to be correspond to these proportions, plus that of all the rectangles below so we can achieve that stacked effect (as opposed to have all rectangles superimposed at the bottom of the vis). This is why I am entering the rectangles in stacking order. Each time, the bottom corners get the value of the top corners of the previous rectangle.</p>

Here is the final result:</p>

&nbsp;
<script type="text/javascript" src="http://public.tableausoftware.com/javascripts/api/viz_v1.js"></script>
<noscript><a href="#"><img alt="mini TM " src="http:&#47;&#47;public.tableausoftware.com&#47;static&#47;images&#47;B5&#47;B5PW2XJWX&#47;1_rss.png" style="border: none" /></a></noscript>
<object class="tableauViz" width="404" height="269" style="display:none;">
<param name="host_url" value="http%3A%2F%2Fpublic.tableausoftware.com%2F" />
<param name="path" value="shared&#47;B5PW2XJWX" />
<param name="toolbar" value="yes" />
<param name="static_image" value="http:&#47;&#47;public.tableausoftware.com&#47;static&#47;images&#47;B5&#47;B5PW2XJWX&#47;1.png" />
<param name="animate_transition" value="yes" />
<param name="display_static_image" value="yes" />
<param name="display_spinner" value="yes" />
<param name="display_overlay" value="yes" />
<param name="display_count" value="yes" />
</object>
<div style="width:404px;height:22px;padding:0px 10px 0px 0px;color:black;font:normal 8pt verdana,helvetica,arial,sans-serif;"><div style="float:right; padding-right:8px;"><a href="http://www.tableausoftware.com/public?ref=http://public.tableausoftware.com/shared/B5PW2XJWX" target="_blank">Powered by Tableau</a></div></div>	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1165" class="post-1165 post type-post status-publish format-standard hentry category-d3 category-tips tag-ajax tag-d3 tag-database tag-mysql tag-php tag-tutorial tag-xhr">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2012/01/02/using-d3-with-a-mysql-database/" rel="bookmark"><time class="entry-date published" datetime="2012-01-02T20:15:59+00:00">January 2, 2012</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2012/01/02/using-d3-with-a-mysql-database/" rel="bookmark">Using d3 with a mySql database</a></h1>
         
    </header>
	<section class="post-content">

		<p>Creating visualizations from static files is fine and dandy but sometimes you need to be able to access dynamic data. And some other times, you may want to somehow record interactions from your users. One way to do that is by interacting with a mySql database.</p>
<p>Without further ado here is the demo:</p>
<p><iframe src="http://jckr.github.io/blog/stuff/sql_map/sqlmap.html" scrolling="no" width="542px" height="680px"></iframe></p>
<h3>How does it work?</h3>
<p>There are several parts to that.</p>
<p>First, one <a href="http://jckr.github.io/blog/stuff/sql_map/sqlmap.html">html file</a> which holds everything together. By the way, for the styling I used Twitter&#8217;s <a href="http://twitter.github.com/bootstrap/">bootstrap</a> which makes it easy for all elements to find their place, and look at those purty buttons.</p>
<p>Second, one <a href="http://jckr.github.io/blog/stuff/sql_map/sqlmap.js">javascript file</a> which contains the visualization proper.  If you have some familiarity with <a href="http://www.d3-js.org/">d3</a>, there is really nothing scary in this script. I&#8217;ll go back to the parts where the script interacts with databases in detail.</p>
<p>Here&#8217;s what the rest does at a high level.</p>
<ol>
<li>We give some behaviors to the buttons</li>
<li>Then we create a grid of small squares. All of these squares are positionned and given a class name, so that the square with class &#8220;r32&#8221; and &#8220;c17&#8221; is the 18th square from the left and 33th from the top (the class names start at 0).</li>
<li>We catch the clicks on each square with a &#8220;clickme&#8221; function. In d3 logic, what is passed to that function is the underlying data of the element, in this case a 2-dimensional array with the x and y coordinates of the square which is being clicked on. In turn, the clickme function is going to update the data of the square, and those of the 4 surrounding squares (the one to the top, the bottom, the left and the right) by either increasing or decreasing the elevation of the terrain they represent</li>
</ol>
<p>When it gets interesting is how the data is initialized and how it is updated.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.text(&quot;mapread.php&quot;, function(txt) {
	d3.selectAll(&quot;#loading&quot;).remove();
	txt.split(&quot;\n&quot;).forEach(function(line,i) {
		line.split(&quot;,&quot;).forEach(function(d,j) {
			data[i][j]=parseFloat(d);
			d3.selectAll(&quot;.r&quot;+i+&quot;.c&quot;+j).style(&quot;fill&quot;,function() {return cScale(data[i][j]);});
		})
	});
})</pre>
<p>What&#8217;s really interesting here is the first line. We are asking d3 to go fetch a text file sitting at mapread.php, then do something with this file. The second part of the line, function(txt), calls a function with the contents of this text as argument.</p>
<p>The second line just removes the loading message box. Then, d3 splits the text in lines, and each line being a string of comma-separated values, it splits that too and feeds a variable, data, with the result of all of this splitting. Then, it formats the squares by coloring them according to the retrieved values.</p>
<p>At this stage you may think: but shouldn&#8217;t you load the data <em>before </em>drawing the scene? Well, what happens here is that loading the data takes much more time than drawing the scene, so it makes more sense to draw it first as an empty shell, load the data and then update the scene.</p>
<p>And as you may have guessed, this mapread.php is no ordinary text file, but a dynamically-generated file from a mySql database. I won&#8217;t cover setting up a mySql database. Tutorials on the subject abound, there are ISPs that offer free mySql hosting, and if you can also install a local server on your computer, for instance <a href="http://www.easyphp.org/">EasyPHP</a> for windows users. And, if your ISP limits the number of mySql databases you can have, you don&#8217;t need to create a new one, just creating a new table within one will be fine. All you have to do really is find your mySql credentials.</p>
<p>Next, you want to create a PHP file that goes like this:</p>
<pre class="brush: php; title: ; notranslate" title="">&lt;?php
$username=&quot;username&quot;; //replace with your mySql username
$password=&quot;password&quot;;  //replace with your mySql password
$dsn=&quot;database&quot;;  //replace with your mySql database name
$host=&quot;host&quot;;  //replace with the name of the machine your mySql runs on
$link=mysql_connect($host,$username,$password);
?&gt;</pre>
<p>You can call this: mysqlConfig.php or whatever, this  is a convenience file so you don&#8217;t have to type in your credentials each time you need to connect to your mySql database.</p>
<p>Next, here is the script that reads the database and outputs a text file:</p>
<pre class="brush: php; title: ; notranslate" title="">

&lt;?php
// load in mysql server configuration (connection string, user/pw, etc)
include 'mysqlConfig.php';
// connect to the database
@mysql_select_db($dsn) or die( &quot;Unable to select database&quot;);

// reads the map db

$query=&quot;SELECT `height` FROM `v_map` ORDER BY `row`, `col`&quot;;
mysql_query($query);

$result = mysql_query($query,$link) or die('Errant query: '.$query);

// outputs the db as lines of text.
header('Content-type: text/plain; charset=us-ascii');
$i=0;
$line=&quot;&quot;;

if(mysql_num_rows($result)) {
 while($value = mysql_fetch_assoc($result)) {

$line=$line.$value[&quot;height&quot;];
 $i=$i+1;
 if ($i==52) {
 $i=0;
 echo $line.&quot;\n&quot;;
 $line=&quot;&quot;;}
 else {$line=$line.&quot;,&quot;;}
 }
}
mysql_close();
?&gt;
</pre>
<p>And by the way, I am by no means a php expert. I hadn&#8217;t written a line of php in almost 10 years, so there may well be more effective ways to do that but the above works. The more interesting part is that we write an sql query which we store in $query and then we execute this query. Then, we loop over the results and echo the output.</p>
<p>Back to our javascript file, we also interact with another php file when we update the data.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
function update(r,c,v) {
	if(r&gt;=0 &amp;&amp; r&lt;y &amp;&amp; c&gt;=0 &amp;&amp; c&lt;x) {
		data[r]=d3.max([d3.min([100,data[r]+v*build]),0]);
		d3.selectAll(&quot;.r&quot;+r+&quot;.c&quot;+c).style(&quot;fill&quot;,function() {return cScale(data[r]);});
		d3.text(&quot;mapupdate.php?height=&quot;+data[r]+&quot;&amp;col=&quot;+c+&quot;&amp;row=&quot;+r,function() {console.log(&quot;cell on row &quot;+r+&quot; and col&quot;+c+&quot; updated to &quot;+data[r]);});
	}
}</pre>
<p>Here the last line is the interesting one. What it does is that, again, it attempts to fetch a text file from a url. In fact, there is no text there but just accessing this url will trigger an interaction with the database. (I guess it would be good practice to actually get some text in return, but hey).</p>
<p>The program tries to read an url of the form mapupdate.php?height=20&amp;col=10&amp;row=32. By calling this url, we are actually passing these parameters to a php file, which will read them and use them to construct a query to the mySql database.</p>
<p>Here goes:</p>
<pre class="brush: php; title: ; notranslate" title="">&lt;?php

// load in mysql server configuration (connection string, user/pw, etc)
include 'mysqlConfig.php';
// connect to the database
@mysql_select_db($dsn) or die( &quot;Unable to select database&quot;);

// updates the map db

$query=&quot;UPDATE `v_map` SET `height`=&quot;.$_GET[&quot;height&quot;].&quot; WHERE `col`= &quot;.$_GET[&quot;col&quot;].&quot; and `row`= &quot;.$_GET[&quot;row&quot;];
mysql_query($query);
mysql_close();
?&gt;</pre>
<p>Here, the line that starts with $query is doing just that. The dot &#8220;.&#8221; is PHP concatenation operator, and the $_GET variable returns an associative array with the parameters passed to the script.</p>
<p>For the sake of completeness, I had two other php scripts, one to initiate the table to begin with, and one to reset it if something went wrong. Those are just plain SQL queries so no need to reproduce them here.</p>
<p>And voilà! now all of you can interact with this terrain builder, create islands, forests, mountains etc. The graphics are kind of crude, because when I was looking for an example I decided to recreate one of my earliest attempts in creative coding. In 1990 upon the release of <a href="http://en.wikipedia.org/wiki/Powermonger">Powermonger</a> I was so fascinated by the algorithmically-generated maps the game used as copy protection that I tried to code my own terrain generator, that was a time where 320x240x16 resolution was considered generous. Only here, it&#8217;s your clicks that replace the algorithm!</p>
<p>I hope you enjoy the tutorial and working with persistant data with d3!</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1026" class="post-1026 post type-post status-publish format-standard hentry category-d3 category-protovis category-tips tag-color tag-color-palettes tag-d3 tag-hsl tag-linear tag-logarithmic tag-ordinal tag-power tag-protovis tag-quantitative tag-rgb tag-scales tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/08/11/d3-scales-and-color/" rel="bookmark"><time class="entry-date published" datetime="2011-08-11T12:03:21+00:00">August 11, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/08/11/d3-scales-and-color/" rel="bookmark">d3: scales, and color.</a></h1>
         
    </header>
	<section class="post-content">

		<p>In <a href="http://mbostock.github.com/protovis/docs/scale.html">protovis</a>, scales were super-useful in just about everything. That much hasn&#8217;t changed in d3, even though <a href="https://github.com/mbostock/d3/wiki/Scales">d3.scale</a> is a bit different from pv.Scale. (do note that <strong>d3.scale</strong> is in lowercase for starters).</p>
<h2>Scales: the main idea</h2>
<p>Simply put: scales transform a number in a certain interval (called the <em>domain</em>) into a number in another interval (called the <em>range</em>).<br />
<img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3scale1.png" alt="an example of how scales work" /><br />
For instance, let&#8217;s suppose you <em>know</em> your data is always over 20 and always below 80. You would like to plot it, say, in a bar chart, which can be only 120 pixels tall.<br />
You could, obviously, do the math:</p>
<pre class="brush: jscript; title: ; notranslate" title="">.attr(&quot;height&quot;, function(d) {return (d-20)*2;})</pre>
<p>But what if you suddenly have more or less space? or your data changes? you&#8217;d have to go back to the entrails of your code and make the change. This is very error prone. So instead, you can use a scale: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var y=d3.scale.linear().domain(20,80).range(0,120);
...
.attr(&quot;height&quot;, y)</pre>
<p>this is much simpler, elegant, and easy to maintain. Oh, and the latter notation is equivalent to
<pre class="brush: jscript; title: ; notranslate" title="">.attr(&quot;height&quot;, function(d) {return y(d);})</pre>
<p>&#8230; only more legible and shorter.<br />
And, there are tons of possibility with scales. </p>
<h2>Fun with scales</h2>
<p>In d3, quantitative scales can be of several types: </p>
<ul>
<li>linear scales (including <em>quantize</em> and <em>quantile</em> scales,</li>
<li>logarithmic scales,</li>
<li>power scales (including <em>square root</em> scales)</li>
</ul>
<p>While they behave differently, they have a lot in common. </p>
<h3>Domain and range</h3>
<p>For all scales, with the exception of quantize and quantile scales which are a bit different, domain and range work the same.<br />
First, note that <strong>unlike in protovis</strong>, domain and range take an array as argument. Compare:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var y=pv.Scale.linear().range(20,60).domain(0,120);
var y=d3.scale.linear().range([20,60]).domain([0,120]);</pre>
<p>This is because <strong>contrary to protovis</strong>, where domain could be a whole dataset, in d3, domain contains the bounds of the interval that is going to be transformed.<br />
Typically, this is two numbers. If this is more, we are talking about a polypoint scale: there are as many segments in the intervals as there are numbers in the domain (minus one). The range must have as many numbers, and so as many segments. When using the scale, if a number is in the n-th segment of the domain, it is transformed into a number in the n-th segment of the range.<br />
<img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3scaleMultipoint.png" alt="illustration of a multipoint scale" /><br />
With this example, 30 finds itself in the first segment of the domain. So it&#8217;s transformed to a value in the first segment of the range. 60, however, is in the 2nd segment, so it&#8217;s transformed into a value in the 2nd segment of the range.<br />
Also, bounds of domain and range need not be numbers, as long as they can be converted to numbers. One useful examples are colors. Color names can be used as range, for instance, to create <em>color ramps</em>:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var ramp=d3.scale.linear().domain([0,100]).range([&quot;red&quot;,&quot;blue&quot;]);</pre>
<p>This will transform any value betwen 0 and 100 into the corresponding color between red and blue.</p>
<h3>Clamping</h3>
<p>What happends if the scale is asked to process a number outside of the domain? That&#8217;s what clamping controls. If it is set, then the bounds of the range are the minimum and maximum value that can be returned by the scale. Else, the same transformation applies to all numbers, whether they fall within the domain or not.<br />
<img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3clamping.png" alt="Clamping example" /><br />
Here, with clamping, the result of the linear transformation is 120, but without it, it&#8217;s 160. </p>
<pre class="brush: jscript; title: ; notranslate" title="">var clamp=d3.scale.linear().domain([20,80]).range([0,120]);
clamp(100); // 160
clamp.clamp(true);
clamp(100); // 120</pre>
<h3>Scales and nice numbers</h3>
<p>More often than not, the bounds of the domain and/or those of the ranges will be calculated. So, chances are they won&#8217;t be round numbers, or numbers a human would like. Scales, however, come with a bunch of method to address that. d3 keeps in mind that scales are often used to position marks along an axis.</p>
<h4>.nice()</h4>
<p>When applied to a scale, the nice method expends the domain to &#8220;nicer&#8221; numbers. You wouldn&#8217;t want your axis to start at -2.347 and end at 7.431, right?<br />
So, there. </p>
<pre class="brush: jscript; title: ; notranslate" title="">var data=[-2.347, 4, 5.23,-1.234,6.234,7.431]; // or whatever.
var y=d3.scale.linear().range([0,120]);
y.domain([d3.min(data), d3.max(data)]); // domain takes bounds as arguments, not all numbers
y.domain() // [-2.347, 7.431];
y.nice() // [-3, 8]</pre>
<h4>.ticks(n)</h4>
<p>Given a domain, and a number n (which, <strong>contrary to protovis, is mandatory in d3</strong>), the ticks method will split your domain in (more or less) n convenient, human-readable values, and return an array of these values. This is especially useful to label axes. Passing these values to the scale allows them to position ticks nicely on an axis. </p>
<pre class="brush: jscript; title: ; notranslate" title="">var y=d3.scale.linear([20,80]).range([0,120]);
...
var ticks=axis.selectAll(&quot;line&quot;)
  .data(y.ticks(4)) // 20, 40, 60 and 80
  .enter().append(&quot;svg:line&quot;);
ticks
  .attr(&quot;x1&quot;,0).attr(&quot;x2&quot;,5)
  .attr(&quot;y1&quot;,y).attr(&quot;y2&quot;,y) // short and simple. 
  .attr(&quot;stroke&quot;,&quot;black&quot;);</pre>
<h4>.rangeRound()</h4>
<p>If used instead of .range(), this will guarantee that the output of the scales are integers, which is better to position marks on the screen with pixel precision than numbers with decimals. </p>
<h4>.invert()</h4>
<p>The invert function turns the scale upside down: for one given number in the range, it returns which number of the domain would have been transformed into that number.<br />
For instance: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var y=d3.scale.linear([20,80]).range([0,120]);
y(50); // 60
y.invert(60); // 50</pre>
<p>That&#8217;s quite useful, for instance, when a user mouses over a chart, and you would like to know to what value the mouse coordinates correspond. </p>
<h3>Power scales and log scales</h3>
<p>The <em>linear</em>scale is a function of the form y=ax+b which works for both ends of the domain and range. In the example we&#8217;ve used most often until now, this function is really f(x): y=2x-40.<br />
Power and logarithm scales work the same, only we are looking for a function of the form y=ax<sup>k</sup>+b, or y=a.log(x)+b.<br />
For the power scales, you can specify an exponent (k) with the .exponent() method. For instance, if we specify an exponent of 2, here is what the scale would look like:<br />
<img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3scalePower.png" alt="an example of a power scale" /><br />
The equation is now f(x): y=x²/50-8. So 20 still becomes 0 and 80 still becomes 120, but other than that the values at the beginning of the domain would be lower than with the linear scale, and those at the end of the scale will be higher.<br />
For convenience, d3 includes a d3.scale.sqrt() (the square root scale) so you never have to type d3.scale.pow.exponent(0.5) in full.<br />
Also note that if you are using a log scale, you <strong>cannot</strong> have 0 in the domain. </p>
<h3>Quantize and quantile</h3>
<p>quantize and quantile are specific linear scales.<br />
quantize works with a discrete, rather than continuous, range: in other terms, the output of quantize can only take a certain number of values.<br />
For instance: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var q=d3.scale.quantize().domain([0,10]).range([0,2,8]); 
q(0); // 0
q(3); // 0
q(3.33); // 0
q(3.34); // 2
q(5); // 2
q(6.66); // 2
q(6.67); // 8
q(8); // 8
q(1000); // 8</pre>
<p>quantile on the other hand matches values in the domain (which, this time, is the full dataset) with their respective quantile. The number of quantiles is specified by the range.<br />
For instance: </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var q=d3.scale.quantile().domain([0,1,5,6,2,4,6,2,4,6,7,8]).range([0,100]);
q.quantiles(); // [4.5], only one quantile - the median
q(0); // 0
q(4); // 0
q(4.499); // 0
q(4.5); // 100 - over the median
q(5); // 100
q(10000); // 100
q.range([0,25,50,75,100]);
q.quantiles(); // [2, 4, 5.6, 6];
q(0); // 0 
q(2); // 25 - greater than the first quantile limit
q(3); // 25
q(4); // 50
q(6); // 100
q(10000); // 100</pre>
<h3>Ordinal scales</h3>
<p>All the scales we&#8217;ve seen so far have been quantitative, but how about ordinal scales?<br />
The big difference is that ordinal scales have <strong>a discrete domain</strong>, in other words, they turn a limited number of values into something else, without caring for what&#8217;s between those values.<br />
Ordinal scales are very useful for positioning marks along an x axis. Let&#8217;s suppose you have 10 bars to position for your bar chart, each corresponding to a category, a month or whatever.<br />
For instance: </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var x=d3.scale.ordinal()
  .domain([&quot;Sunday&quot;,&quot;Monday&quot;,&quot;Tuesday&quot;,&quot;Wednesday&quot;,&quot;Thursday&quot;,&quot;Friday&quot;,&quot;Saturday&quot;]) // 7 items
  .rangeBands([0,120]);
x(&quot;Tuesday&quot;); // 34.285714285714285
</pre>
<p>There are 3 possibilites for range. Two are similar: the .rangePoints() and .rangeBands() methods, which both work with an array of two numbers &#8211; i.e. .rangeBands([0,120]). The last one is to specify all values in the range with .range(). </p>
<h4>rangePoints() and rangeBands()</h4>
<p>With .rangePoints(<em>interval</em>), d3 fits n points within the interval, n being the number of categories in the domain. In that case, the value of the first point is the beginning of the interval, that of the last point is the end of the interval.<br />
With .rangeBands(<em>interval</em>), d3 fit n <em>bands</em> within the interval. Here, the value of the last item in the domain is less than the upper bound of the interval.<br />
Those methods <strong>replace the protovis methods</strong> .split() and .splitBanded().<br />
<img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3ordinalRange.png" alt="difference between rangeBands and rangePoints" /><br />
This chart illustrates the difference between using rangeBands and rangePoints. </p>
<pre class="brush: jscript; title: ; notranslate" title="">var x=d3.scale.ordinal()
  .domain([&quot;Sunday&quot;,&quot;Monday&quot;,&quot;Tuesday&quot;,&quot;Wednesday&quot;,&quot;Thursday&quot;,&quot;Friday&quot;,&quot;Saturday&quot;]);
x.rangePoints([0,120]);
x(&quot;Saturday&quot;); // 120
x.rangeBands([0,120]);
x(&quot;Saturday&quot;); // 102.85714285714286
x(&quot;Saturday&quot;)+x.rangeBand(); // 120</pre>
<h4>the range method</h4>
<p>Finally, we can also use the .range method with several values.<br />
We can specify the domain, or not. Then, if we use such a scale on a value which is not part of the domain (or if the domain is left empty), this value is added to the domain. If there are <em>n</em> values in the range, and more in the domain, then the n+1<sup>th</sup> value of the doamin is matched with the 1st value in the range, etc.</p>
<pre class="brush: jscript; title: ; notranslate" title="">var x=d3.scale.ordinal().range([&quot;hello&quot;, &quot;world&quot;]); 
x.domain(); // [] - empty still.
x(0); // &quot;hello&quot;
x(1); // &quot;world&quot;
x(2); // &quot;hello&quot;
x.domain(); // [0,1,2]
</pre>
<h4>Color palettes</h4>
<p><strong>Unlike in protovis</strong>, which had them under pv.Colors &#8211; i.e. pv.Colors.category10(), in d3, built-in color palettes can be accessed through scales. Well, even in protovis they had been ordinal scales all along, only not called this way.<br />
There are <a href="https://github.com/mbostock/d3/wiki/Ordinal-Scales#category10">4 built-in color palette</a> in protovis: d3.scale.category10(), d3.scale.category20(), d3.scale.category20b(), and d3.scale.category20c().</p>
<p>A palette like d3.scale.category10() works exactly like an ordinal scale. </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var p=d3.scale.category10();
var r=p.range(); // [&quot;#1f77b4&quot;, &quot;#ff7f0e&quot;, &quot;#2ca02c&quot;, &quot;#d62728&quot;, &quot;#9467bd&quot;, 
                      // &quot;#8c564b&quot;, &quot;#e377c2&quot;, &quot;#7f7f7f&quot;, &quot;#bcbd22&quot;, &quot;#17becf&quot;]
var s=d3.scale.ordinal().range(r); 
p.domain(); // [] - empty
s.domain(); // [] - empty, see above
p(0); // &quot;#1f77b4&quot;
p(1); // &quot;#ff7f0e&quot;
p(2); // &quot;#2ca02c&quot;
p.domain(); // [0,1,2];
s(0); // &quot;#1f77b4&quot;
s(1); // &quot;#ff7f0e&quot;
s(2); // &quot;#2ca02c&quot;
s.domain(); // [0,1,2];</pre>
<p>It&#8217;s noteworthy that in d3, color palette return strings, not pv.Color objects like in protovis.<br />
Also: </p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.scale.category10(1); // this doesn't work
d3.scale.category10()(1); // this is the way.</pre>
<h2>Colors</h2>
<p>Compared to protovis, d3.color is simpler. The main reason is that protovis handled color and transparency together with the pv.Color object, whereas in SVG, those two are distinct attributes: you handle the background color of a filled object with <em>fill</em>, its transparency with <em>opacity</em>, the color of the outline with <em>stroke</em> and the transparency of that color with <em>stroke-opacity</em>. </p>
<p>d3 has two color objects: d3_Rgb and d3_Hsl, which describe colors in the two of the most popular color spaces: red/green/blue, and hue/saturation/light. </p>
<p>With d3.color, you can make operations on such objects, like converting colors between various formats, or make colors lighter or darker.</p>
<p>d3.rgb(<em>color</em>), and d3.hsl(<em>color</em>) create such objects.<br />
In this context, <em>color</em> can be (straight from <a href="https://github.com/mbostock/d3/wiki/Colors">the manual</a>):</p>
<ul>
<li>rgb decimal &#8211; &#8220;rgb(255,255,255)&#8221;</li>
<li>hsl decimal &#8211; &#8220;hsl(120,50%,20%)&#8221;</li>
<li>rgb hexadecimal &#8211; &#8220;#ffeeaa&#8221;</li>
<li>rgb shorthand hexadecimal &#8211; &#8220;#fea&#8221;</li>
<li>named &#8211; &#8220;red&#8221;, &#8220;white&#8221;, &#8220;blue&#8221;</li>
</ul>
<p>Once you have that object, you can make it brighter or darker with the appropriate method.<br />
You can use .toString() to get it back in rgb hexadecimal format (or hsl decimal), and .rgb() or .hsl() to convert it to the object in the other color space. </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var c=d3.rgb(&quot;violet&quot;) // d3_Rgb object
c.toString(); // &quot;#ee82ee&quot;
c.darker().toString(); // &quot;#a65ba6&quot;
c.darker(2).toString(); // &quot;#743f74&quot; - even darker
c.brighter().toString();// &quot;ffb9ff&quot;
c.brighter(0.1).toString(); // &quot;#f686f6&quot; - only slightly brighter
c.hsl(); // d3_Hsl object
c.hsl().toString() // &quot;hsl(300, 76, 72)&quot;</pre>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1012" class="post-1012 post type-post status-publish format-standard hentry category-d3 category-protovis category-tips tag-charts tag-d3 tag-javascript tag-protovis tag-selection tag-svg tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/08/09/d3-adding-stuff-and-oh-understanding-selections/" rel="bookmark"><time class="entry-date published" datetime="2011-08-09T14:49:23+00:00">August 9, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/08/09/d3-adding-stuff-and-oh-understanding-selections/" rel="bookmark">d3: adding stuff. And, oh, understanding selections</a></h1>
         
    </header>
	<section class="post-content">

		<h2>From data to graphics</h2>
<p><img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3principle.png" alt="the d3 principle (and also the protovis principle)" /><br />
d3 and protovis are built around the same principle. Take data, put it into an array, and for each element of data a graphical object can be created, whose properties are derived from the data that was provided.</p>
<p>Only d3 and protovis have a slightly different way of adding those graphical elements and getting data. </p>
<p>In protovis, you start from a panel, a protovis-specific object, to which you add various marks. Each time you add a mark, you can either:</p>
<ul>
<li><strong>not</strong> specify data and add just one, </li>
<li> or <strong>specify</strong> data and create as many as there are items in the array you pass as data.</li>
</ul>
<p>.</p>
<h2>How de did it in protovis</h2>
<pre class="brush: jscript; title: ; notranslate" title="">
var vis=new pv.Panel().width(200).height(200); 
vis.add(pv.Panel).top(10).left(10)
  .add(pv.Bar)
    .data([1,4,3,2,5])
    .left(function() {return this.index*20;})
    .width(15)
    .bottom(0)
    .height(function(d) {return d*10;});
vis.render();</pre>
<p><img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/protoBar.png" alt="this simple bar chart in protovis" /><br />
you first create a panel (first line), you may add an element without data (here, another panel, line 2), and add to this panel bars: there would be 5, one for each element in the array in line 4. </p>
<h2>And in d3?</h2>
<p>In d3, you also have a way to add either one object without passing data, or a series of objects &#8211; one per data element. </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var vis=d3.select(&quot;body&quot;).append(&quot;svg:svg&quot;).attr(&quot;width&quot;,200).attr(&quot;height&quot;,200);
var rect=vis.selectAll(&quot;rect&quot;).data([1,4,3,2,5]).enter().append(&quot;svg:rect&quot;);
rect.attr(&quot;height&quot;,function(d) {return d*20;})
  .attr(&quot;width&quot;, 15)
  .attr(&quot;x&quot;,function(d,i) {return i*20;})
  .attr(&quot;y&quot;,function(d) {return 100-20*d;}
  .attr(&quot;fill&quot;,&quot;steelblue&quot;);
</pre>
<p>In the first line, we are creating an svg document which will be the root of our graphical creation. It behaves just as the top-level panel in protovis. </p>
<p>However we are not creating this out of thin air, but rather we are bolting it onto an existing part of the page, here the <body> tag. Essentially, we are looking through the page for a tag named <body> and once we find it (which should be the case often), that&#8217;s where we put the svg document. </p>
<p>Oftentimes, instead of creating our document on <body>, we are going to add it to an existing &lt;div&gt; block, for instance: </p>
<pre class="brush: jscript; title: ; notranslate" title="">
&lt;div id=&quot;chart&quot;&gt;&lt;/div&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
var vis=d3.select(&quot;#chart&quot;).append(&quot;svg:svg&quot;);
...
&lt;/script&gt;
</pre>
<p>Anyway. To <strong>add one element</strong>, regardless of data, what you do is: </p>
<p>The logic is : d3.select(<em>where we would like to put our new object</em>).append(<em>type of new object</em>).</p>
<p>Going back to our code: </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var vis=d3.select(&quot;body&quot;).append(&quot;svg:svg&quot;).attr(&quot;width&quot;,200).attr(&quot;height&quot;,200);
var rect=vis.selectAll(&quot;rect&quot;).data([1,4,3,2,5]).enter().append(&quot;svg:rect&quot;);
rect.attr(&quot;height&quot;,function(d) {return d*20;})
  .attr(&quot;width&quot;, 15)
  .attr(&quot;x&quot;,function(d,i) {return i*20;})
  .attr(&quot;y&quot;,function(d) {return 100-20*d;}
  .attr(&quot;fill&quot;,&quot;steelblue&quot;);
</pre>
<p>On line 2, we see a different construct:</p>
<p><em>an existing selection, or a part of the page</em><br />
.selectAll(<em>something</em>)<br />
.data(<em>an array</em>)<br />
.enter()<br />
.append(<em>an object type</em>)</p>
<p>This sequence of methods (selectAll, data, enter and append) are the way to add a series of elements. If all you need to know is to create a bar chart, just remember that, but if you plan on taking your d3 skills further than where you stopped with protovis, look at the end of the post for a more thorough explanation of the selection process. </p>
<h2>Attributes and accessor functions</h2>
<p>At this stage, we&#8217;ve added our new rectangles, and now we are going to shape and style them. </p>
<pre class="brush: jscript; title: ; notranslate" title="">rect.attr(&quot;height&quot;,function(d) {return d*20;})
  .attr(&quot;width&quot;, 15)
  .attr(&quot;x&quot;,function(d,i) {return i*20;})
  .attr(&quot;y&quot;,function(d) {return 100-20*d;}
  .attr(&quot;fill&quot;,&quot;steelblue&quot;);
</pre>
<p>All the attributes of a graphical element are controlled by the method attr(). You specify the attribute you want to set, and the value you want to give.<br />
In some cases, the value doesn&#8217;t depend on the data. All the bars will be 15 pixels wide, and they will all be of the steelblue color.<br />
In some others, the value do depend on the data. We decide that the height of each bar is 20 times the value of the underlying data, in pixels (so 1 becomes 20, 5 becomes 100 etc.). Like in protovis, once data has been attributed to an element, function(<em>variable name</em>) enables to return a dynamic value in function on that element. By convention, we usually write function(d) {&#8230;;} (d for data) although it could be anything. Those functions are still called <strong>accessor functions</strong>.<br />
so for instance: </p>
<pre class="brush: jscript; title: ; notranslate" title="">.attr(&quot;height&quot;,function(d) {return d*20;})</pre>
<p>means that the height will be 20 times the value of the underlying data element (exactly what we said above).<br />
In protovis, we could position the mark relatively to any corner of its parent, so we had a .top method and a .bottom method. But with SVG, objects are positioned relatively to the top-left corner. So when we specify the y position, it is also relative to the top of the document, not necessarily to the axis (and not in this case).<br />
so &#8211;
<pre class="brush: jscript; title: ; notranslate" title="">.attr(&quot;y&quot;, function(d) {return 100-d*20;})</pre>
<p>if we use scales (see next post), all of this will have no impact whatsoever anyway.<br />
Finally, there is an attribue here which doesn&#8217;t so much depend on the <em>value</em> of the data, but of its <em>rank</em> in the data items: the x position.<br />
for this, we write: function(d,i) {return i*20;}<br />
Here is a <strong>fundamental difference with protovis</strong>. In protovis, when we passed a second argument to such a function, it meant the data of the parent element (grand parent for the third, etc.). But here in d3, the second parameter is the position of the data element in its array. By convention, we write it i (for index).<br />
And since you have to know: there is no easy way to retrieve the data of the parent element. </p>
<h2>Bonus: understanding selections</h2>
<p>To add many elements at once we&#8217;ve used the sequence: selectAll, data, enter, append.<br />
Why use 4 methods for what appears to be one elementary task? If you don&#8217;t care about manipulating nodes individually, for instance for animations, you can just remember the sequence. But if you want to know more, here is what each method does. </p>
<h3>selectAll</h3>
<p><img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3selectAll.png" alt="the selectAll method" /><br />
First, we select a point on which to add your new graphical objects. When you are creating your objects and use the selectAll method, it will return an <em>empty selection</em> but based on that given point. You may also use selectAll in another context, to update your objects for instance. But here, an empty selection is expected. </p>
<h3>data</h3>
<p><img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3data.png" alt="the data method" /><br />
Then, you attribute data. This works quite similarly to protovis: d3 expects an array. d3 takes the concept further (with the concept of <em>data joins</em>) but you need not concern yourself with that until you look at transitions.<br />
Anyway, at this stage you have an empty selection, based on a given point in the page, but with data.</p>
<h3>enter</h3>
<p><img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3enter.png" alt="the enter method" /><br />
The enter method updates the selection with nodes which have data, but no graphical representation. Using enter() is like creating stubs where the graphical elements will be grafted. </p>
<h3>append</h3>
<p><img src="http://jckr.github.io/blog/wp-content/uploads/2011/08/d3append.png" alt="the append method" /><br />
Finally, by appending we actually create the graphical objects. Each is tied to one data element, so it can be further styled (for instance, through &#8220;attr&#8221;) to derive its characteristics from the value of that data.</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-623" class="post-623 post type-post status-publish format-standard hentry category-charts category-data-visualization category-protovis category-tips tag-arc-diagrams tag-force-directed-graphs tag-graphs tag-layouts tag-matrix-diagrams tag-network tag-protovis tag-stacked-areas tag-stacked-bars tag-stacked-columns tag-treemaps tag-trees tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/11/working-with-data-in-protovis-part-5-of-5/" rel="bookmark"><time class="entry-date published" datetime="2011-02-11T20:11:22+00:00">February 11, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/charts/" rel="category tag">charts</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/11/working-with-data-in-protovis-part-5-of-5/" rel="bookmark">Working with data in protovis: part 5 of 5</a></h1>
         
    </header>
	<section class="post-content">

		<p>previous: <a href="http://jckr.github.io/blog/?p=502">reshaping complex arrays (4/5)</a></p>
<h2>Working with layouts</h2>
<p>In this final part, we&#8217;re going to look at how we can shape our data to use the protovis built-in layouts such as stacked areas, treemaps or force-directed graphs.<br />
This is not a tutorial on how to use layouts stricto sensu, and I advise anyone interested to first look at the <a href="http://vis.stanford.edu/protovis/docs/layout.html">protovis documentation</a> to see what can be done with this and to understand the underlying concepts. </p>
<p>But if there is one thing to know about layouts, it&#8217;s that they allow you to <strong>create non-trivial visualizations in even less code than regular protovis</strong>, provided that you <strong>pass them data in a form they can use</strong>, and this is precisely where we come in.</p>
<h3>Three great categories of layouts</h3>
<p>Currently, there are no fewer than 13 types of layouts in Protovis. Fortunately, there are examples for all of them in the gallery.<br />
There are layouts for: </p>
<ul>
<li>Arrays of data</li>
<ul>
<li>
Grids or heatmaps <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Grid.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/heatmap.html">example</a>
</li>
<li>
Stacked areas or streamgraphs <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Stack.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/stack.html">stacked areas</a> <a href="http://vis.stanford.edu/protovis/ex/stream.html">streamgraphs</a>
</li>
</ul>
<li>Networks (nodes and links)</td>
<td>Hierarchized data (trees)</li>
<ul>
<li>
Arc diagrams <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Arc.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/arc.html">example</a></li>
<li>
Force-directed graphs <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Force.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/force.html">example </a>
</li>
<li>
Relationship matrices <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Matrix.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/matrix.html">example</a>
</li>
<li>Rollup network<a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Rollup.html">doc</a> (no example in Protovis 3.2, but there is one in 3.3)</li>
</ul>
<li>Trees and hierarchized data</li>
<ul>
<li>
Dendograms <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Cluster.html">doc </a><a href="http://vis.stanford.edu/protovis/ex/dendrogram.html">example</a>
</li>
<li>
Indented trees <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Indent.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/indent.html">example</a>
</li>
<li>
Packed circles <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Pack.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/pack.html">example</a>
</li>
<li>
Sunbursts and icicles <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Partition.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/sunburst.html">sunbursts</a> <a href="http://vis.stanford.edu/protovis/ex/icicle.html">icicles</a>
</li>
<li>
Node-link trees <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Tree.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/tree.html">example</a></li>
<li>Treemaps <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Treemap.html">doc</a> <a href="http://vis.stanford.edu/protovis/ex/treemap.html">example</a></li>
</ul>
</ul>
<p>In addition, there are layouts like <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Bullet.html">pv.Layout.Bullet</a> which require data to have a certain specific shape but the <a href="http://vis.stanford.edu/protovis/ex/bullet.html">example from the gallery</a> is very explicit. (et tu, <a href="http://vis.stanford.edu/protovis/ex/horizon.html">Horizon</a> layout).</p>
<h3>Arrays of data</h3>
<p>In order to work with this kind of layout, the simplest thing is to put your data in a 2-dimensional array: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var data=[
   [8,3,7,2,5],
   [9,6,1,7,4],
    ...
   [7,4,3,6,8]
];</pre>
<p>For the grid layout, this gives you an array of cells divided in columns (number of elements in each line) and rows (number of lines).<br />
The idea of the grid layout is that your cells are automatically positioned and sized, so afaik the only thing you can do is add a mark such as a pv.Bar which would fill them completely, but which you could still style with fillStyle or strokeStyle. You can&#8217;t really access the underlying data with functions but you can use methods that rely on default values, like adding labels.</p>
<p>For instance, you can use it to generate a QR code: </p>
<table>
<tr>
<td>
<pre class="brush: jscript; title: ; notranslate" title="">var qr=[
&quot;000000000000000000000000000&quot;,
&quot;011111110001010100011111110&quot;,
&quot;010000010101001110010000010&quot;,
&quot;010111010000010100010111010&quot;,
&quot;010111010111011110010111010&quot;,
&quot;010111010010000001010111010&quot;,
&quot;010000010110110010010000010&quot;,
&quot;011111110101010101011111110&quot;,
&quot;000000000011100100000000000&quot;,
&quot;011111011110101110101010100&quot;,
&quot;000010101001010111101000100&quot;,
&quot;010101111001001011111010110&quot;,
&quot;001011000100010101010100010&quot;,
&quot;001100010111011010010101110&quot;,
&quot;010101100110001101001010100&quot;,
&quot;010011010011111111100110110&quot;,
&quot;010111101010100101000010010&quot;,
&quot;010100110010111101111101000&quot;,
&quot;000000000101010111000111000&quot;,
&quot;011111110100011001010111110&quot;,
&quot;010000010000110011000110110&quot;,
&quot;010111010110001011111111000&quot;,
&quot;010111010101101100110101110&quot;,
&quot;010111010100000111001001010&quot;,
&quot;010000010111010101101110010&quot;,
&quot;011111110101001100011111110&quot;,
&quot;000000000000000000000000000&quot;,
].map(function(i) i.split(&quot;&quot;));

var vis = new pv.Panel()
    .width(216)
    .height(216);
vis.add(pv.Layout.Grid)
    .rows(qr)
 	.cell.add(pv.Bar)
 	    .fillStyle(pv.colors(&quot;#fff&quot;, &quot;#000&quot;))
     ;
vis.render();</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/QR-grid-big.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/QR-grid-big.png" alt="" title="QR-grid-big" width="216" height="216" class="aligncenter size-full wp-image-628" /></a>(BTW, this is the QR code to this page)</td>
</tr>
</table>
<p>On line 29, I&#8217;m using a <a href="http://jckr.github.io/blog/?p=494">map function</a> to turn this array of strings, which is easier and shorter to type, into a <em>bona fide</em> 2-dimensional array. </p>
<p>That&#8217;s all there is to grids, of all the layouts they are among the easiest to reproduce with regular protovis.</p>
<p>Now, stacks.<br />
The easiest way to use them is to pass them 2-dimensional arrays. Now it doesn&#8217;t have to be arrays of numbers, it can be arrays of associative arrays in case you need to do something exotic. But for the following examples let&#8217;s just assume you don&#8217;t. Here is how you&#8217;d do a stacked area, stacked columns and stacked bars respectively:</p>
<table>
<tr>
<td>
<pre class="brush: jscript; title: ; notranslate" title="">var data=[
[[1000,1200,1500,1700]]
[[100,500,300,200]]
]
var vis=new pv.Panel().width(200).height(200);
vis.add(pv.Layout.Stack)
    .layers(data)
    .x(function() 50*this.index)
    .y(function(d) d/20)
    .layer.add(pv.Area)</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/stackedAreas.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/stackedAreas.png" alt="" title="stackedAreas" width="200" height="200" class="aligncenter size-full wp-image-636" /></a></td>
</tr>
</table>
<p>all you need is to feed the layers, x, y properties of your stack, then say what you want to add to your layers.<br />
Now, columns: </p>
<table>
<tr>
<td>
<pre class="brush: jscript; first-line: 6; title: ; notranslate" title="">vis.add(pv.Layout.Stack)
    .layers(data)
    .x(function() 50*this.index)
    .y(function(d) d/20)
    .layer.add(pv.Bar).width(40)</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/stackedColumns.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/stackedColumns.png" alt="" title="stackedColumns" width="200" height="200" class="aligncenter size-full wp-image-637" /></a></td>
</tr>
</table>
<p>and finally, bars: </p>
<table>
<tr>
<td>
<pre class="brush: jscript; first-line: 6; highlight: [8,11]; title: ; notranslate" title="">vis.add(pv.Layout.Stack)
    .layers(data)
    .orient(&quot;left&quot;)
    .x(function() 50*this.index)
    .y(function(d) d/20)
    .layer.add(pv.Bar).height(40)</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/stackedBars.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/stackedBars.png" alt="" title="stackedBars" width="200" height="200" class="aligncenter size-full wp-image-638" /></a></td>
</tr>
</table>
<p>For bars, there is a little trick here. I specify that the layer orientation is horizontal (&#8220;left&#8221;) and I change the height instead of the width of the added pv.Bar.<br />
And that all there is. You can create various streamgraphs by <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Layout.Stack.html#offset">playing with the order and offset properties</a> of the stack but this doesn&#8217;t change anything to the data structure, so we&#8217;re done here.</p>
<h3>Representing networks</h3>
<p>Protovis provides 3 cool layouts to easily exhibit relationships between nodes: arc diagrams, matrix diagrams and force-directed layouts.<br />
The good news is that the shape of the data required by those three layouts is identical. </p>
<p>They require an array that correponds to the nodes. This can be as simple as a pv.range(), or as sophisticated as an array of associative arrays if you want to style your network graph according to several potential attributes of the node. </p>
<p>And they also require an array for the links. This array has a more rigid form, it must be an array of associative arrays of the shape: {source: #, target: #, value: #} where the values for source and target correspond to the position of a node in the node array, and value indicates the strength of the link. </p>
<p>So let&#8217;s do a simple one. </p>
<table>
<tr>
<td>
<pre class="brush: jscript; title: ; notranslate" title="">var nodes=pv.range(6); // why more complex, right?
var links=[
{source:0, target:1, value:2},
{source:1, target:2, value:1},
{source:1, target:3, value:1},
{source:2, target:4, value:4},
{source:3, target:5, value:1},
{source:4, target:5, value:1},
{source:1, target:5, value:3}
]
var vis = new pv.Panel()
    .width(200)
    .height(200)
    ;
var arc = vis.add(pv.Layout.Arc)
    .nodes(nodes)
    .links(links)
	.bottom(100)
arc.link.add(pv.Line);
arc.node.add(pv.Dot)
    .size(50)
vis.render();</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleNetwork1.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleNetwork1.png" alt="" title="simpleNetwork" width="200" height="200" class="aligncenter size-full wp-image-644" /></a></td>
</tr>
</table>
<p>Here, by varying the strength of the link, the thickness of the arcs changes accordingly. The nodes are left unstyled, had we passed a more complicated dataset to the nodes array, we could have changed their properties (fillStyle, size, strokeStyle, labels etc.) with appropriate accessor functions. </p>
<p>With little modifications we can create a force-directed layout and a matrix diagram.</p>
<table>
<tr>
<td>
<pre class="brush: jscript; first-line: 14; title: ; notranslate" title="">
var force = vis.add(pv.Layout.Force)
    .nodes(nodes)
    .links(links);

force.link.add(pv.Line);

force.node.add(pv.Dot)
	.size(50)
	.anchor(&quot;center&quot;).add(pv.Label)
		.text(function() this.index);

vis.render();
</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleForce.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleForce.png" alt="" title="simpleForce" width="200" height="200" class="aligncenter size-full wp-image-645" /></a></td>
</tr>
</table>
<p>Here I labelled the nodes so one can tell which is which. This is done by adding a pv.Label to the pv.Dot that&#8217;s attached to the node, just like with any other mark.</p>
<table>
<tr>
<td>
<pre class="brush: jscript; first-line: 14; title: ; notranslate" title="">
var Matrix = vis.add(pv.Layout.Matrix)
	.nodes(nodes)
	.directed(true)
	.links(links)
	.top(20).left(20)

Matrix.link.add(pv.Bar)
    .fillStyle(function(d) pv.Scale.linear(0, 2, 4)
      .range('#eee', 'yellow', 'green')(d.linkValue))

Matrix.label.add(pv.Label).text(function() Math.floor(this.index/2))

vis.render();</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleMatrix1.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleMatrix1.png" alt="" title="simpleMatrix" width="200" height="200" class="aligncenter size-full wp-image-647" /></a></td>
</tr>
</table>
<p>For the matrix things are slightly more complex than for the previous 2. Here I opted for a directed matrix, as opposed to a bidirectional one: this means that each link is shown once, to its source from its target, and not twice (ie from its target back to its source) which is the default.<br />
I chose to color the bar attached to my links (which are cells of the matrix) according to the strength of my links. Again, if my nodes field was more qualified, I could have used these properties. </p>
<p>Finally, we&#8217;ve added labels to the custom property Matrix.label. Only, the labels are numbered from 0 to 11 so to get numbers from 0 to 5 for both rows and columns I used Math.floor(this.index/2) (integer part of half of this number).</p>
<h3>Hierarchized data</h3>
<p>Like for networks, the shape of the data we can feed to treemaps, icicles and other hierarchical representation doesn&#8217;t change. So once you have your data in order, you can easily switch representations. </p>
<p>Essentially, you will be passing a tree of the form: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var myTree={
   rootnode: {
      node: {
      ...  
         node: {
            leaf: value,
            leaf: value,
            ...
            leaf: value
         },
      ...  
}</pre>
<p>The protovis examples use the hierarchy of <a href="http://vis.stanford.edu/protovis/ex/flare.js">flare source code</a> as an example, which really shows what can be done with a treemap and other tree represenations. </p>
<p>For our purpose we are going for a simpler tree, inspired by the work of Periscopic on <a href="http://www.congressspeaks.com/">congressspeaks.com</a> which Kim Rees showed at <a href="http://now.periscopic.com/2011/02/lessons-in-visual-economy-at-strata/">Strata</a>.<br />
Kim presentation featured tiny treemaps that showed the voting record for a congressperson, and whether they had voted for or against their party.</p>
<p>So let&#8217;s play with the voting record of an hypothetic congressperson:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var hasVoted={
	didnt: 100,
	voted: {
	    yes: {
	        yesWithParty: 241,
	        yesAgainstParty: 23
	    },
	    no: {
	        noWithParty: 73,
	        noAgainstParty: 5
	    }
	}
};</pre>
<p>Once you have your tree, you will need to pass it to your layout using pv.dom, like this: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">pv.dom(hasVoted).root(&quot;hasVoted&quot;).nodes()</pre>
<p>Based on that let&#8217;s do two hierarchical representations.<br />
Let&#8217;s start with a tree: </p>
<pre class="brush: jscript; first-line: 14; title: ; notranslate" title="">var vis = new pv.Panel()
    .width(500)
    .height(200)
    ;
var tree = vis.add(pv.Layout.Tree)
    .nodes(pv.dom(hasVoted).root(&quot;hasVoted&quot;).nodes())
    .depth(40)
    .breadth(100)
    .top(30)
    .right(100)
    ;
tree.link.add(pv.Line);
tree.node.add(pv.Dot)
    .size(function(n) n.nodeValue)
	.anchor(&quot;center&quot;).add(pv.Label).textAlign(&quot;center&quot;).text(function(n) n.nodeName)
vis.render();</pre>
<p>And here is the result:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleTree.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleTree.png" alt="" title="simpleTree" width="500" height="200" class="aligncenter size-full wp-image-652" /></a></p>
<p>There are many styling possibilities obviously left unexplored in this simple example (you can control properties of the tree.link, tree.node, tree.labels which we didn&#8217;t use here, etc.), but this won&#8217;t change much as far as data are concerned. </p>
<p>Now let&#8217;s try a treemap with the same dataset.</p>
<pre class="brush: jscript; first-line: 14; title: ; notranslate" title="">var vis = new pv.Panel()
    .width(400)
    .height(200)
    ;

var tree = vis.add(pv.Layout.Treemap)
	.width(200).height(200)
    .nodes(pv.dom(hasVoted).root(&quot;hasVoted&quot;).nodes())
    ;

tree.leaf.add(pv.Panel)
	.fillStyle(function(d) d.nodeName==&quot;didnt&quot;?&quot;darkgrey&quot;:d.nodeName.slice(0,3)==&quot;yes&quot;?
	d.nodeName.slice(-9)==&quot;WithParty&quot;?&quot;powderblue&quot;:&quot;steelblue&quot;:
	d.nodeName.slice(-9)==&quot;WithParty&quot;?&quot;lightsalmon&quot;:&quot;salmon&quot;)

vis.add(pv.Panel)
	.data([
		   {label:&quot;yes with party&quot;, 	color: &quot;powderblue&quot;},
		   {label:&quot;yes against party&quot;, 	color: &quot;steelblue&quot;},
		   {label:&quot;no with party&quot;, 		color: &quot;lightsalmon&quot;},
		   {label:&quot;no against party&quot;, 	color: &quot;salmon&quot;},
		   {label:&quot;didn't vote&quot;, 		color: &quot;darkgrey&quot;}
		   ])
	.left(220)
	.top(function() 50+20*this.index)
	.height(15)
	.width(20)
	.fillStyle(function(d) d.color)
	.anchor(&quot;right&quot;).add(pv.Label).textAlign(&quot;left&quot;).text(function(d) d.label)

vis.render();
</pre>
<p>and what took the longest part of the code was making the legend.</p>
<p>Here is the outcome:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleTreemap.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/simpleTreemap.png" alt="" title="simpleTreemap" width="400" height="200" class="aligncenter size-full wp-image-653" /></a></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-502" class="post-502 post type-post status-publish format-standard hentry category-charts category-data-visualization category-protovis category-tips tag-aggregation tag-hierarchy tag-maps tag-nesting tag-protovis tag-rollup tag-trees">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/11/working-with-data-in-protovis-part-4-of-5/" rel="bookmark"><time class="entry-date published" datetime="2011-02-11T02:51:39+00:00">February 11, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/charts/" rel="category tag">charts</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/11/working-with-data-in-protovis-part-4-of-5/" rel="bookmark">Working with data in protovis &#8211; part 4 of 5</a></h1>
         
    </header>
	<section class="post-content">

		<p><a href="http://jckr.github.io/blog/?p=494">Previous: array functions in javascript and protovis</a></p>
<h2>Reshaping complex arrays</h2>
<p>This really is what protovis data processing is all about.<br />
In today&#8217;s tutorial, I am going to refer extensively to protovis&#8217;s <a href="http://vis.stanford.edu/protovis/ex/barley.html">Becker&#8217;s Barley</a> example. One reason for that is that it&#8217;s also used in the <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Nest.html">API documentation of the methods</a> we are going to cover, and also because I am posting <a href="http://jckr.github.io/blog/?p=534">a line-by-line explanation of this example</a> that you can refer to.</p>
<p>So far we’ve seen that :</p>
<ul>
<li>Associative arrays are great as data elements, as their various values can be used for various attributes.<br />
For instance, if the current data element is an associative array of this shape: </p>
<pre class="brush: jscript; title: ; notranslate" title="">{ yield: 27.00000, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;University Farm&quot; }</pre>
<p>one could imagine a bar chart where the length of the  bar would come from the yield, their fillStyle color from the variety, the label from the site, etc.</li>
<li>arrays of associative arrays are very practical to manipulate thanks to accessor functions.<br />
An array of the shape:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var barley = [
  { yield: 27.00000, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;University Farm&quot; },
  { yield: 48.86667, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Waseca&quot; },
  { yield: 27.43334, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Morris&quot; },
  { yield: 39.93333, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Crookston&quot; },
  { yield: 32.96667, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Grand Rapids&quot; },
  { yield: 28.96667, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Duluth&quot; },
  { yield: 43.06666, variety: &quot;Glabron&quot;, year: 1931, site: &quot;University Farm&quot; },
  { yield: 55.20000, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Waseca&quot; },
  { yield: 28.76667, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Morris&quot; },
  { yield: 38.13333, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Crookston&quot; },
  { yield: 29.13333, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Grand Rapids&quot; },
  { yield: 29.66667, variety: &quot;Glabron&quot;, year: 1931, site: &quot;Duluth&quot; },
  { yield: 35.13333, variety: &quot;Svansota&quot;, year: 1931, site: &quot;University Farm&quot; },
…
  { yield: 29.33333, variety: &quot;Wisconsin No. 38&quot;, year: 1932, site: &quot;Duluth&quot; }
]</pre>
<p>could be easily sorted according to any of the keys – yield, variety, year, site, etc.</li>
<li>it is easy to access the data of an element’s parent, and in some cases it can greatly simplify the code.</li>
</ul>
<h3>Nesting</h3>
<p>For this last reason, you may want to turn one flat array of associative arrays into an array of arrays of associative arrays. This process is called <strong>nesting</strong>.</p>
<p><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/nesting.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/nesting.png" alt="" title="nesting" width="700" height="250" class="aligncenter size-full wp-image-528" /></a></p>
<h4>Simple nesting</h4>
<p>If you turn a <strong>single array</strong> like the one on the left-hand side to <strong>an array of arrays</strong> like on the right-hand side, you could easily do 3 smaller charts, one next to the other, by creating them inside of panels. You could have some information at this panel level (for instance the variety) and the rest at a lower level. </p>
<p>Fortunately, there are protovis methods that can turn your flat list into a more complex array of arrays. And since protovis methods are meant to be chained, you can even go on and create arrays of arrays of arrays of arrays if needs be.<br />
Even better – combined with the other data processing functions, you don’t only change the structure of your array, but you can also filter and control the order of the elements to show everything that you want and only what you want.</p>
<p>And how complicated can this be?<br />
To do the above, all you have to type is </p>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley).key(function(d) d.variety).entries();</pre>
<p>What this does is that it nests your <em>barley</em> array, according to the <em>variety</em> key. entries() at the end is required to obtain the array of arrays needed.</p>
<p>Here is an example of what can be done with both kinds of data structures in just a few lines of code (which won&#8217;t include the data proper. The long, flat array is stored in the variable barley, as above).<br />
Without nesting:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithoutNesting.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithoutNesting.png" alt="" title="BarleyWithoutNesting" width="606" height="198" class="aligncenter size-full wp-image-594" /></a></p>
<pre class="brush: jscript; title: ; notranslate" title="">var vis = new pv.Panel()
    .width(600)
    .height(200)
;
vis.add(pv.Bar)
	.data(barley)
	.left(function() this.index*5)
	.width(4)
	.bottom(0)
	.height(function(d) d.yield*2)
	.fillStyle(function(d) d.year==1931?&quot;steelBlue&quot;:&quot;Orange&quot;)
;
vis.render();</pre>
<p>As the pv.Bar goes through the array, there is not much it can do to structure it. We can just size the bars according to the value of yield, and color them according to another key (here the year).</p>
<p>Now using nesting:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithNesting2.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/BarleyWithNesting2.png" alt="" title="BarleyWithNesting2" width="711" height="160" class="aligncenter size-full wp-image-598" /></a></p>
<pre class="brush: jscript; highlight: [1,8,15]; title: ; notranslate" title="">barley2=pv.nest(barley).key(function(d) d.variety).entries();
barley2=pv.nest(barley).key(function(d) d.variety).entries();
var vis = new pv.Panel()
    .width(710)
    .height(150)
;
var cell=vis.add(pv.Panel)
	.data(barley2)
	.left(function() this.index*70)
	.width(70)
	.top(0)
	.height(150);
cell.anchor(&quot;top&quot;).add(pv.Label).textAlign(&quot;center&quot;).font(&quot;9px sans-serif&quot;).text(function(d) d.key)
cell.add(pv.Bar)
		.data(function(d) d.values)
		.left(function() 5+this.index%6*10)
		.width(8)
		.bottom(0)
		.height(function(d) d.yield*2)
		.fillStyle(function(d) d.year==1931?&quot;steelBlue&quot;:&quot;Orange&quot;)
		.add(pv.Label).text(function(d) d.site).textAngle(-Math.PI/2)
			.textAlign(&quot;left&quot;).left(function() 15+this.index%6*10).textStyle(&quot;#222&quot;)
	;
vis.render();
</pre>
<p>Here we used the same simple nesting command as above (the original example uses a more complicated one which allows for more refinement in the display). This structure allows us to create first panels, which we can style by displaying the name of the sites for instance, then, within these panels, the corresponding bars.</p>
<p>Doing this with the data in its original form would have been possible, but would have required writing a much longer program. So the whole idea of nesting is to <strong>take some time to plan the data structure once, so that the code is as short and useful as possible</strong>.</p>
<h4>Going further with nesting</h4>
<p>However, it is possible to go beyond that: </p>
<ul>
<li>by nesting further, which can be done by adding other .key() methods:</p>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .key(function(d) d.year)
  .entries();</pre>
</li>
</ul>
<p>And/or</p>
<ul>
<li>by sorting keys or values using the sortKeys() and sortValues() methods, respectively. </p>
<p>For instance, we can change the order in which the variety blocks are displayed with sortKeys():</p>
<table>
<tr>
<td>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .entries();</pre>
</td>
<td>
<pre class="brush: jscript; highlight: [3]; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .sortKeys()
  .entries();</pre>
</td>
</tr>
<tr>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-unsorted.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-unsorted.png" alt="" title="sort-unsorted" width="300" height="250" class="aligncenter size-full wp-image-524" /></a></td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-sorted.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/sort-sorted.png" alt="" title="sort-sorted" width="300" height="250" class="aligncenter size-full wp-image-525" /></a></td>
</tr>
</table>
</li>
</ul>
<p>By using sortKeys without argument, the natural order is used (alphabetical, since our key is a string). But we could provide a comparison function if we wanted a more sophisticated arrangement.</p>
<h4>Nesting and hierarchy</h4>
<p>If you run the double nesting command we discussed above, </p>
<pre class="brush: jscript; title: ; notranslate" title="">barley=pv.nest(barley)
  .key(function(d) d.variety)
  .key(function(d) d.year)
  .entries();</pre>
<p>you&#8217;ll get as a result something of the form: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var barley=[
  {key:&quot;Manchuria&quot;, values: [
    {key:&quot;1931&quot;, values: [
      {site:&quot;University farm&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 27},
      {site:&quot;Waseca&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 48.86667},
      {site:&quot;Morris&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 27.43334},
      {site:&quot;Crookston&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 39.93333},
      {site:&quot;Grand Rapids&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 32.96667},
      {site:&quot;Duluth&quot;, variety: &quot;Manchuria&quot;, year: 1931, yield: 28.96667}
    ]},
    {key:&quot;1932&quot;, values: [  
      {site:&quot;University farm&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 26.9},
      {site:&quot;Waseca&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 33.46667},
      {site:&quot;Morris&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 34.36666},
      {site:&quot;Crookston&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 32.96667},
      {site:&quot;Grand Rapids&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 22.13333},
      {site:&quot;Duluth&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 22.56667}
    ]}
  ]},
  {key: &quot;Glabron&quot;, ...
]
</pre>
<p>and so on and so forth for all the varieties of barley. Now how can we use this structure in a protovis script? why not use multi-dimensional arrays instead, and if so, how would the code change?</p>
<p>Well. You&#8217;d start using this structure by creating a first panel and and passing it the nested structure as data.<br />
Assuming your root panel is called vis, you&#8217;d start likewise:</p>
<pre class="brush: jscript; highlight: [2]; title: ; notranslate" title="">
vis.add(pv.Panel)
    .data(barley)</pre>
<p>now, since barley has been nested first by variety, it is now an array of 10 elements. You are going to create 10 individual panels. At some point you should worry about dimensioning and positioning them. But here we are only focusing on passing data to subsequent elements.</p>
<p>Next, you are going to create another set of panels (or any mark, really, this doesn&#8217;t change anything for the data)</p>
<pre class="brush: jscript; first-line: 3; highlight: [4]; title: ; notranslate" title="">.add(pv.Panel)
    .data(function(d) d.values)</pre>
<p>This is how you drill down to the next level of data, by using an accessor function with the key &#8220;values&#8221;.<br />
Congratulations! you have created 2 panels in each of our 10 individual panels, one per year. </p>
<p>Finally, you are going to create a final mark (let&#8217;s say, a pv.Bar)</p>
<pre class="brush: jscript; first-line: 5; highlight: [6]; title: ; notranslate" title="">.add(pv.Bar)
    .data(function(d) d.values)</pre>
<p>Again, you use an accessor function of the same form. This will create a bar chart with 6 bars.<br />
The data element corresponding to each bar is of the form:
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{site:&quot;University farm&quot;, variety: &quot;Manchuria&quot;, year: 1932, yield: 26.9}</pre>
<p>So, when you style the chart, you can access these properties with accessor functions, and write for instance:</p>
<pre class="brush: jscript; first-line: 7; title: ; notranslate" title="">    .height(function(d) d.yield)
    .add(pv.Label).text(function(d) d.variety)</pre>
<p>etc.</p>
<p>To sum it up: you can create a hierarchical structure in protovis that corresponds to the shape of your nested array by adding elements and passing data using an accessor function with the key &#8220;values&#8221;.<br />
At the lowest level of your structure you can access all the properties of the original array using accessor functions.</p>
<p>Now, what if instead we used a multi-dimensional, normal array without keys and values? don&#8217;t they have structure and hierarchy, too?<br />
This is not only possible, but also advised when your dataset is getting really big, as you would plague your users with annoying loading times. This changes the structure of the code though. </p>
<p>An equivalent multi-dimensional array would be something like: </p>
<pre class="brush: jscript; title: ; notranslate" title="">
var yields =
[ // this is the level of the variety
  [ // this is the level of the year
    [ 27, 48.86667, 27.43334, 39.93333, 32.96667, 28.96667], 
    [ 26.9, 33.46667, 34.36666, 32.96667, 22.13333, 22.56667]
  ],
  [ 
    [ 43.06666, 55.2, 28.76667, 38.13333, 29.13333, 29.66667],
    [ 36.8, 37.73333, 35.13333, 26.16667, 14.43333, 25.86667]
  ],
  [
    [ 35.13333, 47.33333, 25.76667, 40.46667, 29.66667, 25.7],
    [ 27.43334, 38.5, 35.03333, 20.63333, 16.63333, 22.23333]
  ],
  [
    [ 39.9, 50.23333, 26.13333, 41.33333, 23.03333, 26.3],
    [ 26.8, 37.4, 38.83333, 32.06666, 32.23333, 22.46667]
  ],
  [
    [ 36.56666, 63.8333, 43.76667, 46.93333, 29.76667, 33.93333],
    [ 29.06667, 49.2333, 46.63333, 41.83333, 20.63333, 30.6]
  ],
  [
    [ 43.26667, 58.1, 28.7, 45.66667, 32.16667, 33.6],
    [ 26.43334, 42.2, 43.53334, 34.33333, 19.46667, 22.7]
  ],
  [
    [ 36.6, 65.7667, 30.36667, 48.56666, 24.93334, 28.1],
    [ 25.56667, 44.7, 47, 30.53333, 19.9, 22.5]
  ],
  [
    [ 32.76667, 48.56666, 29.86667, 41.6, 34.7, 32],
    [ 28.06667, 36.03333, 43.2, 25.23333, 26.76667, 31.36667]
  ],
  [
    [ 24.66667, 46.76667, 22.6, 44.1, 19.7, 33.06666],
    [ 30, 41.26667, 44.23333, 32.13333, 15.23333, 27.36667]
  ],
  [
    [ 39.3, 58.8, 29.46667, 49.86667, 34.46667, 31.6],
    [ 38, 58.16667, 47.16667, 35.9, 20.66667, 29.33333]
  ]
]</pre>
<p>and that&#8217;s the whole lot. It is indeed shorter. now this array is only the yields, you may want to create an array of the possible values of varieties, sites and years for good measure.</p>
<pre class="brush: jscript; title: ; notranslate" title="">var varieties=[&quot;Manchuria&quot;, &quot;Glabron&quot;, &quot;Svansota&quot;, &quot;Velvet&quot;, &quot;Trebi&quot;,
     &quot;No. 457&quot;, &quot;No. 462&quot;, &quot;Peatland&quot;, &quot;No. 475&quot;, &quot;Wisconsin No. 38&quot;], 
    sites=[&quot;University Farm&quot;, &quot;Waseca&quot;, &quot;Morris&quot;, &quot;Crookston&quot;, &quot;Grand Rapids&quot;, &quot;Duluth&quot;],
    years=[1931,1932];</pre>
<p>And by the way, it is very possible to create these arrays out of the original array using the map() method or equivalent.</p>
<p>how can we create an equivalent structure?<br />
we start like the above:</p>
<pre class="brush: jscript; title: ; notranslate" title="">vis.add(pv.Panel)
     .data(yields)</pre>
<p>Likewise, our 3-dimensional array is really an array of 10 arrays of 2 arrays of 6 elements. So we are also creating 10 panels. Let&#8217;s continue and create panels for the years:</p>
<pre class="brush: jscript; first-line: 3; highlight: [4]; title: ; notranslate" title="">.add(pv.Panel)
    .data(function(d) d)</pre>
<p>To drill down one level in an array, you have to use this form. you say that you are giving the children of your object what&#8217;s inside the data property of their parent. </p>
<p>So naturally, you follow by</p>
<pre class="brush: jscript; first-line: 5; highlight: [6]; title: ; notranslate" title="">.add(pv.Bar)
    .data(function(d) d)</pre>
<p>now how you style your bars will be slightly different than before. What you passed your first panel was an array of yields. So that&#8217;s what you get now from your data. If you want something else, you&#8217;ll have to get it with this.index for instance.</p>
<pre class="brush: jscript; first-line: 7; title: ; notranslate" title="">    .height(function(d) d) // that's the yield
    .add(pv.Label).text(function() varieties[this.index])</pre>
<p>All in all it&#8217;s trickier to work with arrays. The code is less explicit, and if you change one array even by accident, you&#8217;ll have to check that others are still synchronized. But it could make your vis much faster.</p>
<h3>Aggregating</h3>
<p>Sometimes, what you want out of an array is not a more complex array, but a simpler list of numbers. For instance, what if you could obtain the sum of all the values in the array for such or such property? This is also possible in protovis, and in fact, it looks a lot like what we&#8217;ve done. The difference is that instead of using the method entries(), we will use the method rollup().</p>
<p>Let&#8217;s suppose we have a flat array that looks like this: these are scores of students on 3 exams. </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">var scores=[
{student:&quot;Adam&quot;, exam:1, score: 77},
{student:&quot;Adam&quot;, exam:2, score: 34},
{student:&quot;Adam&quot;, exam:3, score: 85},
{student:&quot;Barbara&quot;, exam:1, score: 92},
{student:&quot;Barbara&quot;, exam:2, score: 68},
{student:&quot;Barbara&quot;, exam:3, score: 97},
{student:&quot;Connor&quot;, exam:1, score: 84},
{student:&quot;Connor&quot;, exam:2, score: 54},
{student:&quot;Connor&quot;, exam:3, score: 37},
{student:&quot;Daniela&quot;, exam:1, score: 61},
{student:&quot;Daniela&quot;, exam:2, score: 58},
{student:&quot;Daniela&quot;, exam:3, score: 64}
]</pre>
<p>Now, we would like to get, in one simple object, the average for each student.<br />
We know we could reshape the array if we wanted by using pv.Nest and entries(): </p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.nest(scores).key(function(d) d.student).entries()</pre>
<p>This would be something of the shape: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">
[{key:&quot;Adam&quot;, values:[
    {exam:1, score: 77, student: &quot;Adam&quot;},
    {exam:2, score: 34, student: &quot;Adam&quot;},
    {exam:3, score: 85, student: &quot;Adam&quot;}
    ]
  },
  {key:&quot;Barbara&quot;, values:[
    {exam:1, score: 92, student: &quot;Barbara&quot;},
    {exam:2, score: 68, student: &quot;Barbara&quot;},
    {exam:3, score: 97, student: &quot;Barbara&quot;}
   ]
  },
etc.
</pre>
<p>Useful, for instance, if we&#8217;d want to chart the progress of each student separately. </p>
<p>Now if instead of using entries() at the end, we use rollup(), we could get this: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{
Adam: 65.33333333333333
Barbara: 85.66666666666667
Connor: 58.333333333333336
Daniela: 61}
</pre>
<p>The exact statement is </p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.nest(scores)
  .key(function(d) d.student)
  .rollup(function(data) pv.mean(data, function(d) d.score))</pre>
<p>To understand how this works, it helps to visualize what the pv.nest would have returned if we had asked for entries.<br />
What rollup does is that it would go through each of the values that correspond to the keys, and return one aggregate value, depending on the function. </p>
<p>For the first student, &#8220;Adam&#8221;, the corresponding values array is like this: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">[
    {exam:1, score: 77, student: &quot;Adam&quot;},
    {exam:2, score: 34, student: &quot;Adam&quot;},
    {exam:3, score: 85, student: &quot;Adam&quot;}
    ]</pre>
<p>so rollup will just look at each element of this array and apply the function.<br />
This is what (data) in &#8220;function(data)&#8221; corresponds to.<br />
Next, we tell protovis what to do with these elements. Here, we are interested in the average, so we take pv.mean (not pv.average, <a href="http://jckr.github.io/blog/?p=494">remember</a>?)<br />
However, we can&#8217;t directly compute the average of an array of associative arrays &#8211; we must tell protovis exactly what to average. This is why we use an accessor function, function(d) d.score.</p>
<p>Of course, pv.mean used in this example can be replaced by just about any function.</p>
<p>In the name of clarity, especially if there is only one property that can be aggregated, you can declare a function outside of the rollup() method. This is useful if you are going to aggregate your array by different dimensions:</p>
<pre class="brush: jscript; title: ; notranslate" title="">function meanScore(data) pv.mean(data, function(d) d.score);
var avgStudent=pv.nest(scores)
  .key(function(d) d.student)
  .rollup(meanScore);
var avgExam=pv.nest(scores)
  .key(function(d) d.exam)
  .rollup(meanScore);</pre>
<h3>Flattening</h3>
<p>Protovis also provides methods that turn a &#8220;nested&#8221; array back into a flat array. And methods that turn a normal array into a tree.<br />
The main advantage of having a flat array is that you can nest it in a different way. This is useful, for instance, if you got your data in a nested form that doesn&#8217;t work for you. Likewise, a tree is easier to reshape in protovis than an array.</p>
<p>To create a flat array out of a nested one, you have to use pv.flatten and specify all the keys of the array and conclude by array().</p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">barley=pv.flatten(barley).key(&quot;variety&quot;).key(&quot;site&quot;).key(&quot;year&quot;).key(&quot;yield&quot;).array()</pre>
<p>It&#8217;s important to note that you need to specify all the keys, not just the keys that correspond to actual nesting. So again, if you start from a flat array, and you do</p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">barley=pv.nest(barley).key(&quot;variety&quot;).entries()</pre>
<p>to reverse this, you&#8217;ll have to enter the full formula, using key four times:</p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">barley=pv.flatten(barley).key(&quot;variety&quot;).key(&quot;site&quot;).key(&quot;year&quot;).key(&quot;yield&quot;).array()</pre>
<p>Finally, pv.tree &#8211; well, I haven&#8217;t seen this method used outside the <a href="http://vis.stanford.edu/protovis/jsdoc/symbols/pv.Tree.html">documentation</a>. It&#8217;s not used in any live example, not covered by any question in the forum, and I haven&#8217;t found any trace of it in the internet. So I&#8217;d rather leave you with the explanation in the documentation which is fairly clear than come up with my own. If you find yourself in a situation like in the documentation, where you have a flat array of associative arrays, which have a property that could be interpreted as a hierarchy, then you could use this method to turn your array in something more useful to protovis.</p>
<h3>Putting it all together</h3>
<p>Instead of coming up with a specific new example for this section I refer you to my explanation of the <a href="http://jckr.github.io/blog/?p=534">Becker&#8217;s Barley example</a>.<br />
On the same subject, see a comparison of how to <a href="http://jckr.github.io/blog/?p=550">re-create Becker&#8217;s Barley with protovis and Tableau</a></p>
<p>next: <a href="http://jckr.github.io/blog/?p=623">working with layouts</a></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-534" class="post-534 post type-post status-publish format-standard hentry category-data-visualization category-protovis category-tips tag-barley tag-becker tag-nesting tag-protovis tag-rollup tag-treillis">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/11/protovis-analysis-of-the-beckers-barley-example-sketch/" rel="bookmark"><time class="entry-date published" datetime="2011-02-11T02:45:44+00:00">February 11, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/11/protovis-analysis-of-the-beckers-barley-example-sketch/" rel="bookmark">Protovis: analysis of the Becker&#8217;s barley example sketch</a></h1>
         
    </header>
	<section class="post-content">

		<p>We are taking a look at the Protovis <a href="http://vis.stanford.edu/protovis/ex/barley.html">Becker&#8217;s Barley</a> example.</p>
<pre class="brush: jscript; title: ; notranslate" title="">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Barley Yields&lt;/title&gt;
    &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;ex.css?3.2&quot;/&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;../protovis-r3.2.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;barley.js&quot;&gt;&lt;/script&gt;
    &lt;style type=&quot;text/css&quot;&gt;

#fig {
  width: 350px;
  height: 833px;
}

    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;&lt;div id=&quot;center&quot;&gt;&lt;div id=&quot;fig&quot;&gt;
    &lt;script type=&quot;text/javascript+protovis&quot;&gt;

/* Compute yield medians by site and by variety. */
function median(data) pv.median(data, function(d) d.yield);
var site = pv.nest(barley).key(function(d) d.site).rollup(median);
var variety = pv.nest(barley).key(function(d) d.variety).rollup(median);

/* Nest yields data by site then year. */
barley = pv.nest(barley)
    .key(function(d) d.site)
    .sortKeys(function(a, b) site[b] - site[a])
    .key(function(d) d.year)
    .sortValues(function(a, b) variety[b.variety] - variety[a.variety])
    .entries();

/* Sizing and scales. */
var w = 242,
    h = 132,
    x = pv.Scale.linear(10, 70).range(0, w),
    c = pv.Colors.category10();

/* The root panel. */
var vis = new pv.Panel()
    .width(w)
    .height(h * pv.keys(site).length)
    .top(15)
    .left(90)
    .right(20)
    .bottom(25);

/* A panel per site-year. */
var cell = vis.add(pv.Panel)
    .data(barley)
    .height(h)
    .top(function() this.index * h)
    .strokeStyle(&quot;#999&quot;);

/* Title bar. */
cell.add(pv.Bar)
    .height(14)
    .fillStyle(&quot;bisque&quot;)
  .anchor(&quot;center&quot;).add(pv.Label)
    .text(function(site) site.key);

/* A dot showing the yield. */
var dot = cell.add(pv.Panel)
    .data(function(site) site.values)
    .top(23)
  .add(pv.Dot)
    .data(function(year) year.values)
    .left(function(d) x(d.yield))
    .top(function() this.index * 11)
    .size(12)
    .lineWidth(2)
    .strokeStyle(function(d) c(d.year));

/* A label showing the variety. */
dot.anchor(&quot;left&quot;).add(pv.Label)
    .visible(function() !this.parent.index)
    .left(-1)
    .text(function(d) d.variety);

/* X-ticks. */
vis.add(pv.Rule)
    .data(x.ticks(7))
    .left(x)
    .bottom(-5)
    .height(5)
    .strokeStyle(&quot;#999&quot;)
  .anchor(&quot;bottom&quot;).add(pv.Label);

/* A legend showing the year. */
vis.add(pv.Dot)
    .extend(dot)
    .data([{year:1931}, {year:1932}])
    .left(function(d) 170 + this.index * 40)
    .top(-8)
  .anchor(&quot;right&quot;).add(pv.Label)
    .text(function(d) d.year);

vis.render();

    &lt;/script&gt;
  &lt;/div&gt;&lt;/div&gt;&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>Data: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">var barley = [
  { yield: 27.00000, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;University Farm&quot; },
  { yield: 48.86667, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Waseca&quot; },
  { yield: 27.43334, variety: &quot;Manchuria&quot;, year: 1931, site: &quot;Morris&quot; },
etc.</pre>
<p>The code begins by defining a function that will be used throughout the program.</p>
<pre class="brush: jscript; first-line: 20; title: ; notranslate" title="">function median(data) pv.median(data, function(d) d.yield);</pre>
<p>this function expects an array of associative arrays which have the key “yield”. What it does is that it returns the median of all the values of the key yield.<br />
If run against barley, it will return the median yield of all observations.  If run against a subset of barley, it will return the median of the yield of that subset.<br />
The point of this function is to simplify the writing of otherwise obfuscated statements.</p>
<p>Now let’s see it put to good use.</p>
<pre class="brush: jscript; first-line: 21; title: ; notranslate" title="">var site = pv.nest(barley).key(function(d) d.site).rollup(median);</pre>
<p>The output of this statement is easier to understand than itself. It returns an associative array, with each site as a key, and their corresponding value is the median yield for all observations for that site. </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{
  Crookston: 39.03333,
  Duluth: 28.533335,
  Grand Rapids: 23.983335,
  Morris: 34.699995,
  University Farm: 31.383335,
  Waseca: 47.949995}</pre>
<p><strong>pv.nest(barley)</strong> means that we are going to create an associative array based on barley with a hierarchy. (tree)<br />
<strong>.key(function(d) d.site)</strong> means that they first key in the hierarchy of that tree will be the site. So, we are going to run an operation on all the entries of “barley” with the same site.<br />
That operation is called by <strong>.rollup(median )</strong> at the end of the line: this crunches all the entries and replace them by the result of the function “median” applied to all those records. </p>
<pre class="brush: jscript; first-line: 22; title: ; notranslate" title="">var variety = pv.nest(barley).key(function(d) d.variety).rollup(median);</pre>
<p>This does the same as above, but by variety instead of by site. </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{
  Glabron: 32.4,
  Manchuria: 30.96667,
  No. 457: 33.966665,
  No. 462: 30.45,
  No. 475: 31.066665,
  Peatland: 32.383335,
  Svansota: 28.550005,
  Trebi: 39.199995,
  Velvet: 32.149995000000004,
  Wisconsin No. 38: 36.95
}</pre>
<pre class="brush: jscript; first-line: 24; title: ; notranslate" title="">
/* Nest yields data by site then year. */
  barley = pv.nest(barley)
    .key(function(d) d.site)
    .sortKeys(function(a, b) site[b] - site[a])
    .key(function(d) d.year)
    .sortValues(function(a, b) variety[b.variety] - variety[a.variety])
    .entries();</pre>
<p>This will transform the variable barley, which is now a flat list of records, into a tree form.<br />
<strong>pv.nest(barley)</strong> indicates we are turning barley into a tree.<br />
<strong>.key(function(d) d.site)</strong> says that the first order of the hierarchy will be “site”.<br />
So our tree should look like: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">[{key:”Crookston”, values: {….},
  {key:”Duluth”, values:{…},
…</pre>
<p>Well, the order of the keys may not be alphabetical, thanks to the next statement.<br />
<strong>sortKeys </strong>sorts the keys using a comparator function: this function(a,b) thing goes through all the pairs of keys and will order them according to that function, so if for a key the value of site is higher than for another one, it will be put first.<br />
As a result, the first key should be Waseca, then Crookston, etc.<br />
The next order of hierarchy will be after year.  No sortkeys here, so the values of keys will just be presented in natural order.<br />
So our tree will look like: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">[
{ key: “Waseca”, values: [
	{key: 1931, values: [ … ]},
	{key: 1932, values: [ … ]}
  ]
}, 
{key: “Crookston”, values: [
	{key: 1931, values: [ … ]},
	{key: 1932, values: [ … ]}
  ]
}, etc.</pre>
<p>The next statement will rank the values.<br />
What is in that values field (where the ellipses are) will now be ranked using another comparator function, on variety this time.<br />
The <strong>sortKeys </strong>statement worked on keys: “Crookston”, “Duluth”, etc. so one could write directly site[a] and get a value.<br />
But this <strong>sortValues </strong>statement works on entries (fields like:  { yield: 48.86667, variety: &#8220;Manchuria&#8221;, year: 1931, site: &#8220;Waseca&#8221; } ), so one can’t write variety[a] but instead, variety[a.variety].</p>
<p>Finally, the last statement, <strong>entries()</strong>, says that the values thing should be filled by the actual records, as opposed to using rollup in order to crush an aggregate value from the records. </p>
<p>So the final tree will look like this: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">[{key: “Waseca”, values: [
 {key: 1931, values: 	[{site: &quot;Waseca&quot;, variety: &quot;Trebi&quot;, year: 1931, yield: 63.8333},
 {site: &quot;Waseca&quot;,variety: &quot;Wisconsin No. 38&quot;, year: 1931, yield: 58.8},
 {site: &quot;Waseca&quot;, variety: &quot;No. 457&quot;, year: 1931, yield: 58.1},
…
]},
{key: 1932, values: 	[…]}
]}, 
{key: “Crookston”, values: […]}, 
…
{key: “Grand Rapids”, values: […]}]</pre>
<p>The next block of statements is more straightforward.</p>
<pre class="brush: jscript; first-line: 32; title: ; notranslate" title="">/* Sizing and scales. */
var w = 242,
    h = 132,
    x = pv.Scale.linear(10, 70).range(0, w),
    c = pv.Colors.category10();</pre>
<p>w and h are constants for the width and heights of the cells,<br />
x is a scale to transform the yields in horizontal coordinates, so 10 will be represented at the left-most sied of the cell and 70 at the right-most side,<br />
c is the standard color palette.</p>
<p>Now, we create the panels. </p>
<pre class="brush: jscript; first-line: 38; title: ; notranslate" title="">/* The root panel. */
var vis = new pv.Panel()
    .width(w)
    .height(h * pv.keys(site).length)
    .top(15)
    .left(90)
    .right(20)
    .bottom(25);

/* A panel per site-year. */
var cell = vis.add(pv.Panel)
    .data(barley)
    .height(h)
    .top(function() this.index * h)
    .strokeStyle(&quot;#999&quot;);
</pre>
<p>First we create the root panel. The height of the panel is determined by the number of sites.<br />
Since site is an associative array, we first derive an array of the same length with <strong>pv.keys(site)</strong>, which contains the names of the keys of that associative array (in plain English, the names of the sites). What we need is just the number of them, that’s what the <strong>length </strong>property is for.<br />
(btw, we could have simply written <strong>barley.length</strong>)<br />
We multiply that number by the height of each cell to get the height of the root panel. </p>
<p>We then create panels inside that rootpanel.<br />
Note the simplicity with which data is pushed into those panels: </p>
<pre class="brush: jscript; first-line: 49; title: ; notranslate" title="">    .data(barley)</pre>
<p>Now barley is an array of 6 objects. So we are creating 6 panels, and their data element will be of the form: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{key: “Waseca”, values: [{key: “1931”, values:  [entries]}, {key:”1932”, values: [entries]}]}</pre>
<p>Since these cells will be positioned from the root panel, their top value is determined using a simple function of this.index, so the 1st one will be right on top, the next one will be at h pixels from the top, the next one at 2*h pixels, etc.</p>
<pre class="brush: jscript; first-line: 54; title: ; notranslate" title="">/* Title bar. */
cell.add(pv.Bar)
    .height(14)
    .fillStyle(&quot;bisque&quot;)
  .anchor(&quot;center&quot;).add(pv.Label)
    .text(function(site) site.key);</pre>
<p>This just adds a title to the cells. Here, we use a bar, but it could have been a panel.<br />
We only specify the height: the top and left value are supposed to be 0 and the width is that of the parent. We choose the svg color “bisque” as the background color and we add a label in the middle.<br />
Here’s how we obtain the text. Yes it is the site name, but this has nothing to do with the choice of “site” as the variable name in the accessor function.<br />
That function just takes data from the data property, which is directly inherited from the parent. This is a complex associative array, but at its first level, the key property corresponds to the site name. So, function(site) site.key returns the site name. </p>
<pre class="brush: jscript; first-line: 61; title: ; notranslate" title="">/* A dot showing the yield. */
var dot = cell.add(pv.Panel)
    .data(function(site) site.values)
    .top(23)
  .add(pv.Dot)
    .data(function(year) year.values)
    .left(function(d) x(d.yield))
    .top(function() this.index * 11)
    .size(12)
    .lineWidth(2)
    .strokeStyle(function(d) c(d.year));</pre>
<p>Here’s the data representation.<br />
We first add a group of panels called dot to the panel cell.<br />
This is a group, and not a single panel, because of what they get through the data method: the content of the values key of their parent.<br />
Again, the data property of their parent, cell, is of the form: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{key: site name, values: [{key: “1931”, values: […]}, {key:”1932”, values: […]}]}</pre>
<p>So if we isolate the content of the values key, we have an array of 2 values:</p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">[{key: “1931”, values:[…]} , 
{key: “1932”, values:[…]} ]</pre>
<p>Therefore, this statement creates 2, not 1, panels.<br />
But those panels are superposed: the only positioning instruction is that they are 23 pixels from the top, so they are both taking the full width of the cell panel, and go to the bottom of that panel as well.<br />
The system will first draw the first one, then the second one on top of that.</p>
<p>Then, we add a dot object to those dot panels, which is a series of circles.<br />
How many dots will there be in those series? This, again, depends on the contents of the data method.<br />
What we get this time is: </p>
<pre class="brush: jscript; first-line: 66; title: ; notranslate" title="">    .data(function(year) year.values)</pre>
<p>What this means is that we are looking at the data element of the parent, and we are taking what’s behind values. </p>
<p>The data element of the parent was of the form: </p>
<pre class="brush: jscript; light: true; title: ; notranslate" title="">{key: year name, values: 
  [
   {site: site name, variety: variety name, year: year name, yield: yield value},
   {site: site name, variety: variety name, year: year name, yield: yield value}, 
   {site: site name, variety: variety name, year: year name, yield: yield value},
…
   {site: site name, variety: variety name, year: year name, yield: yield value}
  ]
}</pre>
<p>So what we’re getting is the array of 10 entries that were behind values.</p>
<pre class="brush: jscript; first-line: 67; title: ; notranslate" title="">.left(function(d) x(d.yield))</pre>
<p>This means that each mark will be positioned from the left, according to the value of its yield property, once transformed by our scale. </p>
<pre class="brush: jscript; first-line: 68; title: ; notranslate" title="">.top(function() this.index * 11)</pre>
<p>And they are simply positioned vertically depending on this.index, so one on top of the other. Remember, this is relative to the dot panel, not to cell.</p>
<pre class="brush: jscript; first-line: 69; title: ; notranslate" title="">.size(12)
.lineWidth(2)</pre>
<p>We are determining a size and a line width, but no fill style, so we are drawing rings, not discs. Even if they are superposed, the back one should still be visible. </p>
<pre class="brush: jscript; first-line: 71; title: ; notranslate" title="">.strokeStyle(function(d) c(d.year));</pre>
<p>Finally, we are determining the color of the ring. For that, we extract the year of the current entry using d.year.  It is converted to a color using the palette c.<br />
There are other ways to get the year, but this is the simplest to write.</p>
<p>Now if we consider the statement in its entirety again: </p>
<pre class="brush: jscript; first-line: 61; title: ; notranslate" title="">/* A dot showing the yield. */
var dot = cell.add(pv.Panel)
    .data(function(site) site.values)
    .top(23)
  .add(pv.Dot)
    .data(function(year) year.values)
    .left(function(d) x(d.yield))
    .top(function() this.index * 11)
    .size(12)
    .lineWidth(2)
    .strokeStyle(function(d) c(d.year));</pre>
<p>What is really assigned to dot is not the first item created (panels) but the dot chart proper. This is important to note that for the rest: </p>
<pre class="brush: jscript; first-line: 73; title: ; notranslate" title="">/* A label showing the variety. */
dot.anchor(&quot;left&quot;).add(pv.Label)
    .visible(function() !this.parent.index)
    .left(-1)
    .text(function(d) d.variety);
</pre>
<p>What we’re trying to do here is to write legends for the dot charts. We don’t want to do this for each year: the labels would be on top of each other, and less legible than if they were just one group of labels. This is why we use this visible statement. this.parent refers to a the parent panel of dot, so this.parent.index is worth 0 for the first panel, and 1 for the second. So here, !this.parent.index will be false for all values other than 0, so there will be only 1 set of labels, even if we add a year for instance. </p>
<p>Then, although we said we were adding the labels just to the left of the dot (this is what dot.anchor(“left”)  does), what we really want is to have them on the left of the cell.<br />
That’s why we use </p>
<pre class="brush: jscript; first-line: 76; title: ; notranslate" title="">.left(-1)</pre>
<pre class="brush: jscript; first-line: 77; title: ; notranslate" title="">.text(function(d) d.variety)</pre>
<p> runs on the data  provided by the parent, in this case the dot chart. So it’s just the variety of the current entry.</p>
<pre class="brush: jscript; first-line: 79; title: ; notranslate" title="">/* X-ticks. */
vis.add(pv.Rule)
    .data(x.ticks(7))
    .left(x)
    .bottom(-5)
    .height(5)
    .strokeStyle(&quot;#999&quot;)
  .anchor(&quot;bottom&quot;).add(pv.Label);</pre>
<p>This just adds a series of  7 ticks to the bottom of the chart. They are rules, but their height has been limited to 5 pixels. They start from below the chart &#8211; bottom(-5)  &#8211; and we add the ticks to that below with anchor(“bottom”). Since all the values are 2-digit numbers, we can leave the default versions for the pv.Label objects, and not go into tickFormat or anything fancy.</p>
<pre class="brush: jscript; first-line: 88; title: ; notranslate" title="">/* A legend showing the year. */
vis.add(pv.Dot)
    .extend(dot)
    .data([{year:1931}, {year:1932}])
    .left(function(d) 170 + this.index * 40)
    .top(-8)
  .anchor(&quot;right&quot;).add(pv.Label)
    .text(function(d) d.year);</pre>
<p>Finally, the legend of the chart, in form of a dot chart.<br />
The first .extend(dot) statement just says that we are copying the properties of the other  dot chart. So, if we decide to change the size of the rings or their thickness, it will be reflected in the legend.<br />
Here, we just pass the data manually. Note that this is added to the root panel (vis), so top(-8) means that it appears over the main chart. </p>
<p>In this example, the authors have started from an unformated, flat list of 120 entries.<br />
Then, they thought of the shape their final visualization will take and the hierarchy of objects needed to accommodate that:<br />
•	two superposed dot series, showing the various varieties for a given year/site combination (dot),<br />
•	each inside a panel, one for each year,<br />
•	which would be part of a parent panel, for each site (cell)<br />
•	which would be stacked vertically inside the root panel (vis).</p>
<p>So in order to do that seamlessly, they had to prepare a data variable with that hierarchy:<br />
First by site, then by year, then by variety. </p>
<p>This is what the complex pv.nest command does at the beginning.<br />
Once this is taken care of, the various objects can be added one to the other naturally.</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-550" class="post-550 post type-post status-publish format-standard hentry category-charts category-data-visualization category-protovis category-tips tag-grammar-of-graphics tag-nesting tag-protovis tag-tableau tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/11/working-with-data-in-protovis-interlude-protovis-nesting-vs-tableau/" rel="bookmark"><time class="entry-date published" datetime="2011-02-11T02:40:48+00:00">February 11, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/charts/" rel="category tag">charts</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/11/working-with-data-in-protovis-interlude-protovis-nesting-vs-tableau/" rel="bookmark">Working with data in protovis &#8211; interlude: protovis nesting vs tableau</a></h1>
         
    </header>
	<section class="post-content">

		<p>Protovis, like Tableau, are based on the grammar of graphics framework. In a nutshell, in both environments, a chart designer can map visual attributes (such as x or y dimension, color, shape, etc.) to dimensions of data. </p>
<p>The flat file which <a href="http://vis.stanford.edu/protovis/ex/barley.html">Becker&#8217;s Barley</a> is based on can be used in Tableau public nearly as is.<br />
Here&#8217;s a size-by-size comparison of the results:</p>
<table>
<tr>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/protovisBarley.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/protovisBarley.png" alt="" title="protovisBarley" width="350" height="830" class="aligncenter size-full wp-image-551" /></a></td>
<td><script type="text/javascript" src="http://public.tableausoftware.com/javascripts/api/viz_v1.js"></script><object class="tableauViz" width="356" height="901" style="display:none;"><param name="name" value="barley/Dashboard1" /><param name="toolbar" value="no" /><param name="tabs" value="no" /></object><noscript>Dashboard 1 <br /><a href="#"><img alt="Dashboard 1 " src="http://public.tableausoftware.com/static/images/ba/barley/Dashboard1/1_rss.png" height="100%" /></a></noscript></td>
</tr>
</table>
<h2>How it&#8217;s done in Protovis</h2>
<p>In protovis, the flat file is nested several times, so that its various elements can be called in a hierarchy from series of dots per variety, to panel per sites to a grander panel. Legend and ticks are added by hand for a perfect finish. Still, some careful planning is required to prepare the data file and to adjust the various elements (choice of colors, sizes, etc.)</p>
<h2>How it&#8217;s done in Tableau</h2>
<p><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/tableauBarley.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/tableauBarley.png" alt="" title="tableauBarley" width="665" height="497" class="aligncenter size-full wp-image-554" /></a><br />
The data file, unsurprisingly, has 4 dimensions: site, variety, year and yield. In tableau terms, yield is a measure (a numerical dimension) while the other 3 are categorical dimensions. With a few clicks, it is possible to get a result which is similar to the original vis in Protovis. We assign yield to column (horizontal attribute), site and variety to row in that order. We also untick aggregate measures in Analysis, so we get little circles and not big bars. Here, I&#8217;ve manually sorted the sites and the varieties. </p>
<h2>Conclusion</h2>
<p>It is much, much easier to achieve a similar result with Tableau, however using protovis provides a finer control. </p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-494" class="post-494 post type-post status-publish format-standard hentry category-charts category-data-visualization category-protovis category-tips tag-arrays tag-javascript tag-protovis tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/09/working-with-data-in-protovis-part-3-of-5/" rel="bookmark"><time class="entry-date published" datetime="2011-02-09T19:08:57+00:00">February 9, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/charts/" rel="category tag">charts</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/09/working-with-data-in-protovis-part-3-of-5/" rel="bookmark">Working with data in protovis – part 3 of 5</a></h1>
         
    </header>
	<section class="post-content">

		<p>Previous : <a href="http://jckr.github.io/blog/?p=479">Multi-dimensional arrays, inheritance and hierarchy</a></p>
<h2>Short interlude: what can be done with arrays in javascript?</h2>
<p>Now that we have a grasp on how arrays work and how they can be used in protovis, let’s take a step back and look at some very useful methods for working with arrays in standard javascript.</p>
<h3>Sorting arrays</h3>
<p>Using a method called, well, sort(), javascript arrays can be reordered in a variety of ways.</p>
<pre class="brush: jscript; title: ; notranslate" title="">var a = [1, 1.2, 1.7, 1.5, .7, .3];
a.sort();</pre>
<p>Without any argument, this will sort the array in ascending order: [0.3, 0.7, 1, 1.2, 1.5, 1.7].</p>
<p>However, we can reorder the array differently with a comparison function, such as:</p>
<pre class="brush: jscript; title: ; notranslate" title="">a.sort(function(a,b) b-a)</pre>
<p>Note that this is protovis notation. In traditional javascript, you’d have written a.sort(function(a,b) {return b-a;});</p>
<p>This would sort a in descending order ([1.7, 1.5, 1.2, 1, 0.7, 0.3]). Here is how it works.</p>
<p>The comparison function takes 2 elements in the array. If the first element (corresponding to the first argument, a) should appear first, the function must return a negative number. If the result is positive, the second element is appearing first. With our example, b-a is negative when the first element is greater than the second. So, this function sorts an array in descending order.</p>
<p>Sort also works with arrays of associative arrays. For instance:</p>
<pre class="brush: jscript; title: ; notranslate" title="">var data = [
  {key:&quot;a&quot;, value:1},
  {key:&quot;b&quot;, value:1.2},
  {key:&quot;c&quot;, value:1.7}, 
  {key:&quot;d&quot;, value:1.5},
  {key:&quot;e&quot;, value:.7},
  {key:&quot;f&quot;, value:.3}
];

data.sort(function(a,b) b.value-a.value);
</pre>
<p>Here, we have to specify which criterion is used to sort the array. In this example, we sort it in descending order by value. But we could have sorted it in ascending order by key, for instance.</p>
<p>The method reverse() turns an array upside down.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var a = [1, 1.2, 1.7, 1.5, .7, .3];

a.reverse(); // gives [0.3, 0.7, 1.5, 1.7, 1.2, 1]
</pre>
<p>So, a.sort().reverse() will also sort that array in decreasing order.</p>
<h3>Extracting sub-arrays</h3>
<p>The method slice() will extract a sub-array out of an array, in other words, it will retrieve certain elements. It works with one or two arguments. If you only give one argument, it will give you the last elements from the index you specified.</p>
<p>For instance,</p>
<pre class="brush: jscript; title: ; notranslate" title="">[1, 1.2, 1.7, 1.5, .7, .3].slice(3) // it's [1.5, 0.7, 0.3]</pre>
<p>The index 3 corresponds to the 4<sup>th</sup> element of the array (0,1,2,3) so slice(3) will return the 4<sup>th</sup>, 5<sup>th</sup> and 6<sup>th</sup> elements.</p>
<p>With 2 arguments, you get a sub-array that starts at the first index but ends just before the 2<sup>nd</sup> one. For instance,</p>
<pre class="brush: jscript; title: ; notranslate" title="">[1, 1.2, 1.7, 1.5, .7, .3].slice(0,3) // gives [1, 1.2, 1.7]</pre>
<p>It is also possible to use negative arguments. Instead of counting from the beginning of the array, it means counting from the end.</p>
<pre class="brush: jscript; title: ; notranslate" title="">[1, 1.2, 1.7, 1.5, .7, .3].slice(-1) // result: [0.3]</pre>
<h3>Turning a string into an array</h3>
<p>This can be done via the split() method.</p>
<p>split() normally works with a separator, for instance &#8220;07/04/1975&#8221;.split(&#8220;/&#8221;) is [&#8220;07&#8221;, &#8220;04&#8221;, &#8220;1975&#8221;], but if an empty string is used, then each character becomes an element of the new array. For instance,</p>
<pre class="brush: jscript; title: ; notranslate" title="">&quot;ABCDEFGHIJ&quot;.split(&quot;&quot;) // result: [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;G&quot;, &quot;H&quot;, &quot;I&quot;, &quot;J&quot;] </pre>
<p>This can be very useful to generate data on the go.</p>
<h2>And what methods does protovis has for working with arrays and data?</h2>
<p>Many.</p>
<p>Some simple, some very elaborate. In addition to visualization functions protovis has impressive data processing capabilities.</p>
<h3>The workhorse: pv.range()</h3>
<p>pv.range() is a method that creates an array of numbers.</p>
<p>pv.range(10), for instance, is [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], or the 10 first integers starting from 0.<br />
(this is the method I referred to in the example of the previous part).</p>
<p>By using the other arguments, it is possible to generate arrays of numbers that go from one specific index to another, or to change the step. For instance:</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.range(5,10) // is [5, 6, 7, 8, 9]
pv.range(5,21,5) // is [5, 10, 15, 20]</pre>
<p>While this may not look incredible at first sight, pv.range() really shines when associated with other functions or methods such as map().</p>
<p>map()  is an array method that creates a new array by applying a function to each of the element of the array it’s run against. For instance,</p>
<pre class="brush: jscript; title: ; notranslate" title="">var data = pv.range(100).map(Math.random) // creates an array of 100 random numbers.

var data = pv.range(1000).map(function(a) Math.cos(a/1000)) // stores into data 1000 values 
// of cos(x) for all the numbers between 0 and 0.999 by increment of 0.001.</pre>
<p>In other words, pv.range() and map() can quickly create very interesting datasets for protovis to visualize.</p>
<h3>Simple statistical functions that make life easier</h3>
<h4>pv.min(), pv.max()</h4>
<p>Protovis has functions that extract the maximum or the minimum value of an array.</p>
<p>pv.min([1, 1.2, 1.7, 1.5, .7, .3]) will return the value of the smallest element of the array, in that case 0.3.</p>
<p>Likewise, pv.max returns the value of the greatest element of the array.</p>
<p>Both of these can be used with an accessor function to help retrieve what will be compared.</p>
<p>For instance:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var data = [
  {key:&quot;a&quot;, value:1},
  {key:&quot;b&quot;,value:1.2},
  {key:&quot;c&quot;, value:1.7}, 
  {key:&quot;d&quot;, value:1.5},
  {key:&quot;e&quot;, value:.7},
  {key:&quot;f&quot;, value:.3}
];

pv.max(data, function(a) a.value); // should return 1.7</pre>
<h4>pv.sum(), pv.mean(), pv.median()</h4>
<p>Likewise, protovis has aptly-named methods that return the sum, the mean and the median of the elements of an array. Note that it&#8217;s pv.mean() and not pv.average(), though.</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.sum([1, 1.2, 1.7, 1.5, .7, .3]) // gives  6.4.
pv.mean([1, 1.2, 1.7, 1.5, .7, .3]) // gives 1.0666666666666667
pv.median([1, 1.2, 1.7, 1.5, .7, .3]) // gives 1.1.</pre>
<p>Similarly to pv.min() you can use an optional accessor function.</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.median(data, function(a) a.value);</pre>
<h4>pv.normalize()</h4>
<p>pv.normalize() is a handy method that divides all elements in an array by a factor, so that the sum of all these elements is 1.</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.normalize([1, 1.2, 1.7, 1.5, .7, .3])
// [0.15625, 0.18749999999999997, 0.265625, 0.234375, 0.10937499999999999, 0.04687499999999999]

pv.sum(pv.normalize([1, 1.2, 1.7, 1.5, .7, .3])) // result: 1.</pre>
<h3>Combining arrays</h3>
<h4>pv.blend()</h4>
<p>pv.blend() simply turns an array of arrays into a simpler array where all elements follow each other.</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.blend([[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], [1,2,3]]) // gives  [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, 1, 2, 3]</pre>
<p>One benefit is that it is possible to run methods on this new array that wouldn’t work on an array of arrays.</p>
<p>For instance:</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.max([[1,2],[3,4],[5,6]]) // result : NaN
// protovis cannot guess how to compare [1,2], [3,4] or [5,6] without any further instruction.
pv.max(pv.blend([[1,2],[3,4],[5,6]])) // result: 6.
pv.max([[1,2],[3,4],[5,6]], function(a) pv.max(a)) // also returns 6.</pre>
<h4>pv.cross()</h4>
<p>Given two arrays a and b, pv.cross(a,b) returns an array of all possible pairs of elements.</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.cross([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], [1,2,3]) // returns 
//[[“a”,1],[“a”,2],[“a”,3],[“b”,1],[“b”,2],[“b”,3],[“c”,1],[“c”,2],[“c”,3]]</pre>
<h4>pv.transpose()</h4>
<p>pv.transpose() flips an array of arrays.</p>
<p>In our previous example –</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.cross([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], [1,2,3])</pre>
<p>The result was a 9&#215;2 array. [[“a”,1],[“a”,2],[“a”,3],[“b”,1],[“b”,2],[“b”,3],[“c”,1],[“c”,2],[“c”,3]]</p>
<p>If we apply pv.transpose, we get a 2&#215;9 array:</p>
<pre class="brush: jscript; title: ; notranslate" title="">pv.transpose(pv.cross([&quot;a&quot;, &quot;b&quot;, &quot;c&quot;], [1,2,3])); // result:
//[[&quot;a&quot;,&quot;a&quot;,&quot;a&quot;,&quot;b&quot;,&quot;b&quot;,&quot;b&quot;,&quot;c&quot;,&quot;c&quot;,&quot;c&quot;]
//[1,2,3,1,2,3,1,2,3]]</pre>
<h3>Putting it all together</h3>
<p>This short example will show how one can work from an unprepared dataset.<br />
For the purpose of this example, I&#8217;m retrieving GDP per capita data of OECD countries. I have a table of 34 countries on 10 years from 2000 to 2009. The countries are in alphabetical order.<br />
I would like to do a bar chart showing the top 12 countries ranked by their GDP per capita. How complex can this be? With the array methods, not so difficult.</p>
<pre class="brush: jscript; highlight: [40,50]; title: ; notranslate" title="">var data=[
[&quot;Country&quot;,2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009],
[&quot;Australia&quot;,28045.6566279103, 29241.289462815, 30444.7839453338, 32079.5610505727, 33494.6654789274, 35091.7414600449, 37098.3968669994, 39002.0335375021, 39148.4759391917, 39660.1953738791],
[&quot;Austria&quot;,28769.5911274323, 28799.1968990511, 30231.0955219759, 31080.6122212092, 32598.0698959222, 33409.3453751649, 36268.9604225683, 37801.7320979073, 39848.9481928628, 38822.6960085478],
[&quot;Belgium&quot;,27624.4454637489, 28488.7963954409, 30013.7570016445, 30241.724380444, 31151.6315179167, 32140.9239149283, 34159.4723388042, 35597.2980660662, 36878.9710906881, 36308.4784216699],
[&quot;Canada&quot;,28484.9776553362, 29331.8223245112, 29911.3226371905, 31268.5521058006, 32845.6267954986, 35105.9892865177, 36853.5554314586, 38353.0812084648, 38883.0700787846, 37807.5259929247],
[&quot;Chile&quot;,9293.72322249492, 9712.95685376592, 9973.25946014534, 10475.6486664294, 11299.9329380664, 12194.1443507847, 13036.1285137662, 13896.6946083854, 14577.5715215544, 14346.4648487517],
[&quot;Czech Republic&quot;,14992.3582327884, 16173.6387263985, 16872.3146139754, 17991.9331910401, 19303.9208098529, 20365.7571142986, 22349.7033747705, 24578.7151794413, 25845.0252652635, 25530.2001372786],
[&quot;Denmark&quot;,28822.3343389384, 29437.5232757263, 30756.3323835463, 30427.5149228283, 32301.3394496912, 33195.8834383121, 36025.8628586246, 37730.736916861, 39494.1216134705, 37688.2516868117],
[&quot;Estonia&quot;,9861.80346448344, 10693.0362387373, 11966.6746413277, 13370.127724177, 14758.4181995435, 16530.7311083966, 19134.4130457855, 21262.1415030861, 21802.2185996096, 19880.2786070771],
[&quot;Finland&quot;,25651.0005450286, 26518.293212524, 27509.1023963486, 27592.2031438268, 29855.387224753, 30689.9753400459, 33095.030855128, 36149.32963148, 37795.237097856, 35236.9462175119],
[&quot;France&quot;,25272.4127936247, 26644.8404266553, 27776.4225007831, 27399.5459524877, 28273.6330332193, 29692.129719144, 31551.3458452695, 33300.5367942194, 34233.0770304046, 33697.9698933558],
[&quot;Germany&quot;,25949.0588445755, 26855.1296905696, 27587.1573355486, 28566.8930562768, 29900.6507502683, 31365.576121107, 33713.1689185469, 35623.4147543745, 37170.693412872, 36339.9009091421],
[&quot;Greece&quot;,18410.2161113813, 19928.6672542964, 21597.5997816753, 22701.7754699285, 24088.2202877303, 24571.6085727425, 26917.7358531616, 28059.5724529461, 29919.6385697499, 29121.8306842272],
[&quot;Hungary&quot;,12134.0140204384, 13576.4413471795, 14765.2333755651, 15424.3926636975, 16316.8885518624, 16937.9383138957, 18329.1579647528, 19187.2829138188, 20699.9056965458, 20279.5060192879],
[&quot;Iceland&quot;,28840.4899286393, 30443.907492292, 31083.7723760522, 30768.0910155965, 33697.6723843766, 35025.1338769129, 35807.880160537, 37178.9762849327, 39029.2396691797, 36789.0728215933],
[&quot;Ireland&quot;,28695.0931156375, 30524.3712319885, 33052.4517849575, 34525.4148515126, 36511.518217243, 38622.5520655621, 42267.9784043449, 45293.6482834027, 42643.6362934458, 39571.204030073],
[&quot;Israel&quot;,23496.1573531847, 23455.1048827219, 23534.8524310529, 22270.5507137525, 23650.3373360675, 23390.3809761211, 24960.0508863672, 26583.387317862, 27679.3777353666, 27661.1271269539],
[&quot;Italy&quot;,25594.3456589799, 27127.4298830414, 26803.97019843, 27137.5365317475, 27416.0961790796, 28144.0379218171, 30224.2469223694, 31897.7434207435, 33270.7464832409, 32407.5033618371],
[&quot;Japan&quot;,25607.7204586644, 26156.1615068187, 26804.9303541079, 27487.123875677, 29020.8955443678, 30311.5281317716, 31865.2733339475, 33577.1846704038, 33902.3807335349, 32476.7736535378],
[&quot;Korea&quot;,17197.0800334388, 18150.876787578, 19655.5961579558, 20180.932195274, 21630.1629926488, 22783.2288432845, 24286.1803272315, 26190.6122298674, 26876.6422899926, 27099.9481192024],
[&quot;Luxembourg&quot;,53645.7229595775, 53932.4594967082, 57559.2104243171, 60723.9861616145, 65021.6940738929, 68372.258619455, 78523.2988291034, 84577.2190776183, 89732.070876649, 84802.9716853677],
[&quot;Mexico&quot;,10046.1268819126, 10135.7265293228, 10397.8915415223, 10883.8643666506, 11535.0108530091, 12460.5385178945, 13672.6034191998, 14581.5178679935, 15290.896575069, 14336.6153896301],
[&quot;Netherlands&quot;,29405.5490140191, 30788.2508953647, 31943.4974056501, 31702.5798119046, 33208.8592768987, 35110.6577619843, 38063.6877336725, 40744.3819227526, 42887.4361825772, 40813.047575264],
[&quot;New Zealand&quot;,21113.9167562199, 22128.8483527737, 23115.0676326844, 23826.8007737809, 24775.7827578032, 25460.2942993256, 27277.7654223562, 28701.3328788203, 29231.151567007, 29097.307061683],
[&quot;Norway&quot;,36125.7036078917, 37091.7150478501, 37051.9473705873, 38298.8631304819, 42257.5943785044, 47318.7844737929, 53287.9750020125, 55042.2093246253, 60634.9819502298, 55726.7456848212],
[&quot;Poland&quot;,10567.0016558591, 10950.4739587211, 11562.6245018264, 11985.0042955849, 13014.5996003514, 13785.7656450352, 15067.4402978586, 16762.2045951617, 18062.1834289945, 18928.8205162032],
[&quot;Portugal&quot;,17748.6930918065, 18464.7472033934, 19088.1764760703, 19392.2862101711, 19796.1891048601, 21294.1660710906, 22869.9272824917, 24122.9886840593, 24962.2959136026, 24980.061318413],
[&quot;Slovak Republic&quot;,10980.1169029929, 12070.70145551, 12965.6228450353, 13597.9556337584, 14659.0096334623, 16174.4605836956, 18397.5822518716, 20916.5438777989, 23241.0972994031, 22870.8998469728],
[&quot;Slovenia&quot;,17468.5101911515, 18342.8685005009, 19702.0589885459, 20448.2040741134, 22200.7770986247, 23493.9370882038, 25432.3240768864, 27228.3376725332, 29240.5471362484, 27535.6540786883],
[&quot;Spain&quot;,21320.0690041202, 22591.3855327033, 24066.5003000439, 24748.2819467008, 25958.1017090553, 27376.7644983649, 30347.9357063518, 32251.8469529105, 33173.3334547015, 32254.0895139806],
[&quot;Sweden&quot;,27948.4749835611, 28231.3958224236, 29277.7736264795, 30418.0441004337, 32505.646687298, 32701.4327422078, 35680.1787996674, 38339.6698693908, 39321.3014501815, 36996.1394001578],
[&quot;Switzerland&quot;,31618.0958082618, 32103.4812665805, 33390.9169108411, 33266.3042144918, 34536.8476164193, 35478.0395058126, 39116.3945212067, 42755.5569054368, 45516.5601956426, 44830.3719226918],
[&quot;Turkey&quot;,9169.71780977686, 8613.21159842998, 8666.90348260238, 8790.01048446305, 10166.0963401732, 11391.3768057053, 12886.6195973915, 13897.3820310325, 14962.4944915831, 14242.7276329837],
[&quot;United Kingdom&quot;,26071.3066882302, 27578.2857038985, 28887.5850874466, 29848.7319363944, 31790.9933025905, 32724.4057819337, 34970.5193042987, 35719.2060247462, 36817.493156774, 35158.8005888247],
[&quot;United States&quot;,35050.1738557741, 35866.2624634202, 36754.5543204007, 38127.524970345, 40246.0630591955, 42466.1326203714, 44594.9199470326, 46337.2237397566, 46901.0697730874, 45673.7445647402]
];

var year=10;
var rows = data.slice(1,data.length);

var x = pv.Scale.ordinal(pv.range(12)).splitBanded(0, 240, 4/5);
var y = pv.Scale.linear(0, 80000).range(0, 170);

var vis = new pv.Panel()
    .width(250)
    .height(200)
    ;
	vis.add(pv.Bar)
		.data(rows.sort(function(a,b) b[year]-a[year]).slice(0,12))
		.bottom(10)
		.width(x.range().band)
		.height(function(d) y(d[year]))
		.left(function() 5+x(this.index))
		.anchor(&quot;bottom&quot;).add(pv.Label).textAngle(Math.PI/2).text(function(d) d[0]).textBaseline(&quot;middle&quot;).textAlign(&quot;right&quot;)
		;
vis.render();</pre>
<p>here, in the data variable, I&#8217;ve put my 2-dimensional table as I got it. The first row contains headers which I won&#8217;t need. So, in line 40, I create rows which just removes that 1st line with a slice function. data.slice(1,data.length) effectively keeps all the lines but the first.<br />
In the next few lines I create two scales for placing my bars, a standard vis panel and a bar chart. Now, what kind of data will I pass to the bar chart?<br />
I want to sort the rows by the value of the latest year (which happens to be the 11th column, so 10). This is what the rows.sort(function(a,b) b[year]-a[year]) part of the statement does. I&#8217;ve simply assigned 10 to the variable year, so if I want to display other years (with an HTML form for instance) it wouldn&#8217;t be difficult to modify.<br />
And, since I only want the top 12 values, I just write .slice(0,12) after that. </p>
<p>In line 55, I just add a label. pv.Label inherits the data of its parent. The data item is the whole row of my 2-dimensional table, so if I write function(d) d[0], I am referring to the left-most item which will be the country name. </p>
<p>So, with the use of simple array functions, I can easily rework an unprepared dataset in protovis, rather than having to tailor my dataset with manual (and error-prone) manipulations in external programs. Here is the result:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/sortedBar.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/sortedBar.png" alt="" title="sortedBar" width="250" height="200" class="aligncenter size-full wp-image-589" /></a><br />
Next: <a href="http://jckr.github.io/blog/?p=502">reshaping complex arrays</a></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-479" class="post-479 post type-post status-publish format-standard hentry category-charts category-data-visualization category-protovis category-tips category-uncategorized tag-hierarchy tag-inheritance tag-protovis tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2011/02/08/working-with-data-in-protovis-part-2-of-5/" rel="bookmark"><time class="entry-date published" datetime="2011-02-08T19:51:01+00:00">February 8, 2011</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/charts/" rel="category tag">charts</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/protovis/" rel="category tag">protovis</a>, <a href="/category/tips/" rel="category tag">tips</a>, <a href="/category/uncategorized/" rel="category tag">Uncategorized</a>			</span>
		        <h1 class="post-title"><a href="/2011/02/08/working-with-data-in-protovis-part-2-of-5/" rel="bookmark">Working with data in protovis – part 2 of 5</a></h1>
         
    </header>
	<section class="post-content">

		<p>Previous post: <a href="http://jckr.github.io/blog/?p=429">simple arrays</a></p>
<h2>Multi-dimensional arrays, associative arrays and protovis</h2>
<p>Even for a simple chart, chances are that you’ll have more than a single series of numbers to represent. For instance, you could have labels to describe what they mean, several series, and so on and so forth.<br />
So, let’s say we want to add these labels to our original examples, so we know what those bars represent.</p>
<table>
<tbody>
<tr>
<td>
<pre class="brush: jscript; title: ; notranslate" title="">var categories = [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;,&quot;e&quot;,&quot;f&quot;];
var vis = new pv.Panel()
  .width(150)
  .height(150);

vis.add(pv.Bar)
  .data([1, 1.2, 1.7, 1.5, .7, .3])
  .width(20)
  .height(function(d) d * 80)
  .bottom(0)
  .left(function() this.index * 25)
  .anchor(&quot;bottom&quot;).add(pv.Label)
    .text(function() categories[this.index]);

vis.render();
</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/categories.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/categories.png" alt="" title="categories" width="144" height="135" class="aligncenter size-full wp-image-483" /></a></td>
</tr>
</tbody>
</table>
<p>While this did the trick, nothing guarantees that the data proper and the category name will stay coordinated. If one data point is deleted or removed and this is not replicated on the categories, they will no longer match. A more integrated way to proceed would be to group category and data information, like this:</p>
<pre class="brush: jscript; highlight: [16,20]; title: ; notranslate" title="">var data = [
  {key:&quot;a&quot;, value:1},
  {key:&quot;b&quot;, value:1.2},
  {key:&quot;c&quot;, value:1.7}, 
  {key:&quot;d&quot;, value:1.5},
  {key:&quot;e&quot;, value:.7},
  {key:&quot;f&quot;, value:.3}
];
var vis = new pv.Panel()
  .width(150)
  .height(150);

vis.add(pv.Bar)
  .data(data)
  .width(20)
  .height(function(d) d.value * 80)
  .bottom(0)
  .left(function() this.index * 25)
  .anchor(&quot;bottom&quot;).add(pv.Label)
    .text(function(d) d.key);

vis.render();</pre>
<p>This time, we group the values and the category names in a single variable, an array of associative arrays.<br />
When drawing the bar chart, protovis will go through this array and retrieve an associative array for each bar.<br />
We have to change the way the height function is written. The data element being accessed is no longer of the form 1 or 1.7, but {key:”a”, value:1} or {key:”c”, value:1.7}. So to get the number part of it, we must write <strong>d.value</strong>.</p>
<p>Likewise, instead of accessing an array of categories for the text part, we can use the current data element via an accessor function, and write <strong>d.key</strong>.</p>
<h2>Hierarchy and inheritance</h2>
<p>So we’ve seen that arrays, or associative arrays, can have several levels and can be nested one into another.<br />
Interestingly, protovis elements, like panels, charts, mark etc. also work in a <em>hierarchy</em>. For instance, when you start working with protovis you create a panel object. Then, you add other objects to that panel, like a bar chart (our example), or another panel. You can add other objects to your new objects, or attach them to your first panel.<br />
This diagram shows the hierarchy between elements in the previous example.</p>
<table>
<tr>
<td>
<pre class="brush: jscript; title: ; notranslate" title="">var categories = [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;,&quot;e&quot;,&quot;f&quot;];
var vis = new pv.Panel()
  .width(150)
  .height(150)

var bar = vis.add(pv.Bar)
  .data([1, 1.2, 1.7, 1.5, .7, .3])
  .width(20)
  .height(function(d) d * 80)
  .bottom(0)
  .left(function() this.index * 25)
  .anchor(&quot;bottom&quot;).add(pv.Label)
  .text(function() categories[this.index]);

vis.render();</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/hierarchy.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/hierarchy.png" alt="" title="hierarchy" width="220" height="170" class="aligncenter size-full wp-image-485" /></a></td>
</tr>
</table>
<p>The bar object is considered to be the child of vis, who is its parent.</br><br />
You may know that in protovis, children objects inherit properties of their parents.</br><br />
For instance, if width wasn’t specified for the bar object, it would have the width of its parent, 150. Each mark would cover the whole screen.</p>
<p>For data, when a new object is added, data is either specified at that level, or obtained from the parent element of this object.</p>
<p>Let’s take our example and tweak it a bit.<br />
<table>
<tr>
<td>
<pre class="brush: jscript; highlight: [5]; title: ; notranslate" title="">var vis = new pv.Panel().width(150).height(150);
var bar = vis.add(pv.Bar)
  .data([1, 1.2, 1.7, 1.5, .7, .3]).width(20) .bottom(0)
  .height(function(d) d * 80).left(function() this.index * 25)
  .anchor(&quot;top&quot;).add(pv.Label)
vis.render();</pre>
<td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/part3.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/part3.png" alt="" title="part3" width="154" height="154" class="aligncenter size-full wp-image-487" /></a></td>
</tr>
</table>
<p>Here, I didn’t specify a data or a text value for the labels I added. They just took the value of its parent element – the marks of the pv.Bar object.<br />
Here’s another variation:</p>
<table>
<tr>
<td>
<pre class="brush: jscript; highlight: [4]; title: ; notranslate" title="">
var vis = new pv.Panel().width(150).height(150);
vis.add(pv.Panel)
  .data([1, 1.2, 1.7, 1.5, .7, .3]) .left(function() this.index * 25)
  .add(pv.Bar).width(20) .bottom(0)
  .height(function(d) d * 80)
  .anchor(&quot;top&quot;).add(pv.Label)
vis.render();</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/part4.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/part4.png" alt="" title="part4" width="154" height="154" class="aligncenter size-full wp-image-488" /></a></td>
</tr>
</table>
<p>Here, I’m adding panels, then a bar in each panel.<br />
From the root panel, I’m adding a group of panel with this data: [1, 1.2, 1.7, 1.5, .7, .3].<br />
Since there are 6 elements here, I’m adding 6 panels.<br />
Here, the left method applies to each of the panel. The first one is to the left, the next one is 25 pixels further, etc.<br />
I’m then adding a bar object to each panel. Is that one group of bar? Technically yes, but each has only one element! Each pv.Bar <em>implicitly</em> gets the data element of its parent, so the first bar gets [1], the next one gets [1.2], etc. The height of each bar is determined by multiplying the value of that element by 80.<br />
Note that since the fillStyle properties are not defined for the bars, they get the ones which are attributed by default, which explains the color changes.</p>
<p>Further refinement: accessing the data of its parent!</p>
<table>
<tr>
<td>
<pre class="brush: jscript; highlight: [5]; title: ; notranslate" title="">
var vis = new pv.Panel().width(150).height(150);
vis.add(pv.Panel)
  .data([1, 1.2, 1.7, 1.5, .7, .3]) .left(function() this.index * 25)
  .add(pv.Bar).width(20) .bottom(0)
  .height(function(a,b) b * 80)
  .anchor(&quot;top&quot;).add(pv.Label)
vis.render();
</pre>
</td>
<td><a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/part4.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/part4.png" alt="" title="part4" width="154" height="154" class="aligncenter size-full wp-image-488" /></a></td>
</tr>
</table>
<p>Well, the output is exactly the same, but how I obtained the data is different. Instead of getting the data using the standard accessor function, I passed two arguments: function(a, b).<br />
What this does is that the first argument corresponds to the current data element of this object, and the second, to that of its parent.</p>
<p>In this example, they happen to be the same, but this is how you can access the data of the parent objects.</p>
<h2>Putting it all together</h2>
<p>Let&#8217;s see how we can use protovis and the properties of hierarchy! This example is less trivial than the ones we&#8217;ve seen so far but with what we&#8217;ve seen it is quite accessible.<br />
The challenge: re-create <a href="http://eagereyes.org/communication/Engaging-readers-with-square-pie-waffle-charts.html">square pie charts</a>.<br />
How it&#8217;s done: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var data=[36,78,63,24],  // arbitrary numbers
cellSize = 16,
cellPadding = 1,
squarePadding=5,
colors=pv.Colors.category20().range()
;

var vis=new pv.Panel()
    .width(4*(10*cellSize+squarePadding))
    .height(10*cellSize)
    ;

var square = vis.add(pv.Panel)
    .data(data)
    .width(10*cellSize)
    .height(10*cellSize)
    .left(function() this.index*(cellSize*10+squarePadding))
    ;

var row = square.add(pv.Panel)
	.data([0,1,2,3,4,5,6,7,8,9])
	.height(cellSize)
	.bottom(function(d) d*cellSize)
	;

var cell = row.add(pv.Panel)
    .data([0,1,2,3,4,5,6,7,8,9])
    .height(cellSize-2*cellPadding)
    .width(cellSize-2*cellPadding)
    .top(cellPadding)
    .left(function(d) d*cellSize+cellPadding)
    .fillStyle(function(a,b,c) (b*10+a)&lt;c?colors[this.parent.parent.index].color:&quot;lightGrey&quot;)
;

square.anchor(&quot;center&quot;)
  .add(pv.Label)
    .text(function(d) d)
    .textStyle(&quot;rgba(0,0,0,.1)&quot;)
    .font(&quot;100px sans-serif&quot;);

vis.render();</pre>
<p>First, we initiate the data (4 arbitrary numbers from 1 to 100), and various parameters which will help size the square pie &#8211; size of the cells, space between them, space between the square pie charts. We also initiate a color palette.<br />
Then, we are going to create 4 panels or groups of panels, each a child of the previous one.<br />
First comes the <strong>vis</strong> panel, which groups everything,<br />
Then the <strong>square </strong>panels, which correspond to each square pie. This is to this panel that our data is assigned.<br />
Then come the <strong>row </strong>panels, and, finally, the <strong>cell </strong>panels.<br />
The numbers which we want to represent are assigned to the square panel. So, what data are we passing to the row and the cell panels? The only thing we want is to have 10 rows and 10 cells per row. So, we can use an array with 10 items. We are going to use [0,1,2,3,4,5,6,7,8,9] so the data value of the row and that of the cell will correspond to the coordinate of the row and the cell, respectively. In other words, the 5th row will be assigned the data value of 4, and the 7th cell in that row will get the data value of 6. We could retrieve the same numbers using &#8220;this.index&#8221; but this can lead to obfuscated formulas.</p>
<p>Note that in the next part of the tutorial, we&#8217;ll see that in Protovis, there is a more elegant way to write [0,1,2,3,4,5,6,7,8,9] or similar series of numbers. But, we&#8217;ll leave this more explicit form for now.</p>
<p>Back to our row panel. We position it with bottom(function(d) d*cellSize). Here, again, d represents the rank of the row, so the 1st row will get 0, and its bottom value will be 0, the next row will get 1, and its bottom value will be 1*cellSize or 16, etc. </p>
<p>Likewise, in the cell panel, the cells are positioned with left(function(d) d*cellSize+cellPadding). This is the same principle. (here, cellPadding is just used to fine-tune the position of the cell).</p>
<p>This is in the final line that we are really going to use hierarchy.</p>
<pre class="brush: jscript; title: ; notranslate" title="">.fillStyle(function(a,b,c) (b*10+a)&lt;c?colors[this.parent.parent.index].color:&quot;lightGrey&quot;)</pre>
<p>here, a represents the data value of the cell &#8211; in other words, the column number.<br />
b, the data value of the cell&#8217;s parent, the row. This is the row number.<br />
and c is the data value of the parent of the parent of the row, the square &#8211; this is the number that we are trying to represent.</p>
<p>so, what we are going to determine is whether b*10+a&lt;c. If that&#8217;s the case, we color the cell, else, we leave it in pale grey. To get the color we need, we go back to the palette that we defined at the beginning, and take the color corresponding to the square number (0 to 3 from left to right).<br />
The square number can be obtained by this.parent.parent.index.</p>
<p>Finally, we add the numbers in large transparent gray digits on top of the squares.</p>
<p>Here is the result:<br />
<a href="http://jckr.github.io/blog/wp-content/uploads/2011/02/squarePies.png"><img src="http://jckr.github.io/blog/wp-content/uploads/2011/02/squarePies.png" alt="" title="squarePies" width="660" height="160" class="aligncenter size-full wp-image-559" /></a></p>
<p>Next: <a href="http://jckr.github.io/blog/?p=49">Javascript and protovis array functions</a></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				<nav class="pagination navigation paging-navigation" role="navigation">
		<div class="nav-links">
						<div class="older-posts"><a href="/category/tips/page/4/" >Older Posts <span class="meta-nav">&rarr;</span></a></div>
							<div class="page-number">Page 3 of 4</div>
						<div class="newer-posts"><a href="/category/tips/page/2/" ><span class="meta-nav">&larr;</span> Newer Posts</a></div>
			
		</div><!-- .nav-links -->
	</nav><!-- .navigation -->
	
		
		</main><!-- #main -->
	</section><!-- #primary -->

	<div id="secondary" class="widget-area" role="complementary">
		<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form></aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h1 class="widget-title">Recent Posts</h1>		<ul>
					<li>
				<a href="/2016/08/17/the-big-leagues/">The big leagues</a>
						</li>
					<li>
				<a href="/2016/08/17/creating-a-react-visualization-web-app/">Creating a React visualization web app</a>
						</li>
					<li>
				<a href="/2016/08/13/beyond-rendering/">Beyond rendering</a>
						</li>
					<li>
				<a href="/2016/08/11/react-components/">React components</a>
						</li>
					<li>
				<a href="/2016/08/10/coding-with-react/">Coding with React</a>
						</li>
				</ul>
		</aside>		<aside id="recent-comments-2" class="widget widget_recent_comments"><h1 class="widget-title">Recent Comments</h1><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a href='http://omeraz.wordpress.com/' rel='external nofollow' class='url'>עומר עזריאל</a></span> on <a href="/2016/08/17/the-big-leagues/#comment-567">The big leagues</a></li><li class="recentcomments"><span class="comment-author-link">Carlos Ayres</span> on <a href="/2012/05/28/manipulating-data-like-a-boss-with-d3/#comment-312">Manipulating data like a boss with d3</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://migrate.powertripanalytics.com/game-of-thrones-interactions-among-the-top-30-characters/' rel='external nofollow' class='url'>Game of ThronesInteractions Among the Top 30 Characters &#8211; PowerTrip Analytics</a></span> on <a href="/2013/05/13/making-the-game-of-thrones-visualization/#comment-466">Making the game of thrones visualization</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://abgoswam.wordpress.com/2016/10/08/d3-getting-started/' rel='external nofollow' class='url'>D3 &#8211; Getting Started | abgoswam&#039;s tech blog</a></span> on <a href="/2012/09/04/getting-to-hello-world-with-d3/#comment-419">Getting to &#8220;Hello world&#8221; with d3</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://plus.google.com/+BrotoBhattacharjee' rel='external nofollow' class='url'>Broto Bhattacharjee</a></span> on <a href="/2012/09/04/getting-to-hello-world-with-d3/#comment-418">Getting to &#8220;Hello world&#8221; with d3</a></li></ul></aside><aside id="archives-2" class="widget widget_archive"><h1 class="widget-title">Archives</h1>		<ul>
			<li><a href='/2016/08/'>August 2016</a></li>
	<li><a href='/2015/05/'>May 2015</a></li>
	<li><a href='/2015/02/'>February 2015</a></li>
	<li><a href='/2014/10/'>October 2014</a></li>
	<li><a href='/2013/11/'>November 2013</a></li>
	<li><a href='/2013/05/'>May 2013</a></li>
	<li><a href='/2013/03/'>March 2013</a></li>
	<li><a href='/2013/01/'>January 2013</a></li>
	<li><a href='/2012/12/'>December 2012</a></li>
	<li><a href='/2012/11/'>November 2012</a></li>
	<li><a href='/2012/10/'>October 2012</a></li>
	<li><a href='/2012/09/'>September 2012</a></li>
	<li><a href='/2012/07/'>July 2012</a></li>
	<li><a href='/2012/06/'>June 2012</a></li>
	<li><a href='/2012/05/'>May 2012</a></li>
	<li><a href='/2012/04/'>April 2012</a></li>
	<li><a href='/2012/01/'>January 2012</a></li>
	<li><a href='/2011/11/'>November 2011</a></li>
	<li><a href='/2011/10/'>October 2011</a></li>
	<li><a href='/2011/09/'>September 2011</a></li>
	<li><a href='/2011/08/'>August 2011</a></li>
	<li><a href='/2011/07/'>July 2011</a></li>
	<li><a href='/2011/06/'>June 2011</a></li>
	<li><a href='/2011/05/'>May 2011</a></li>
	<li><a href='/2011/04/'>April 2011</a></li>
	<li><a href='/2011/03/'>March 2011</a></li>
	<li><a href='/2011/02/'>February 2011</a></li>
	<li><a href='/2011/01/'>January 2011</a></li>
	<li><a href='/2010/11/'>November 2010</a></li>
	<li><a href='/2010/04/'>April 2010</a></li>
	<li><a href='/2010/03/'>March 2010</a></li>
	<li><a href='/2010/02/'>February 2010</a></li>
	<li><a href='/2010/01/'>January 2010</a></li>
	<li><a href='/2009/12/'>December 2009</a></li>
	<li><a href='/2009/10/'>October 2009</a></li>
	<li><a href='/2009/09/'>September 2009</a></li>
	<li><a href='/2009/08/'>August 2009</a></li>
	<li><a href='/2009/07/'>July 2009</a></li>
	<li><a href='/2009/06/'>June 2009</a></li>
	<li><a href='/2009/05/'>May 2009</a></li>
	<li><a href='/2008/12/'>December 2008</a></li>
	<li><a href='/2008/11/'>November 2008</a></li>
	<li><a href='/2008/10/'>October 2008</a></li>
		</ul>
		</aside><aside id="categories-2" class="widget widget_categories"><h1 class="widget-title">Categories</h1>		<ul>
	<li class="cat-item cat-item-2"><a href="/category/book-review/" >book review</a>
</li>
	<li class="cat-item cat-item-3"><a href="/category/charts/" >charts</a>
</li>
	<li class="cat-item cat-item-4"><a href="/category/conferences/" >conferences</a>
</li>
	<li class="cat-item cat-item-5"><a href="/category/d3/" >d3</a>
</li>
	<li class="cat-item cat-item-6"><a href="/category/dashboards/" >dashboards</a>
</li>
	<li class="cat-item cat-item-7"><a href="/category/data-publishing/" >data publishing</a>
</li>
	<li class="cat-item cat-item-8"><a href="/category/data-visualization/" >data visualization</a>
</li>
	<li class="cat-item cat-item-9"><a href="/category/francais/" >français</a>
</li>
	<li class="cat-item cat-item-10"><a href="/category/javascript/" >javascript</a>
</li>
	<li class="cat-item cat-item-11"><a href="/category/presentation/" >presentation</a>
</li>
	<li class="cat-item cat-item-12"><a href="/category/protovis/" >protovis</a>
</li>
	<li class="cat-item cat-item-13"><a href="/category/react/" >react</a>
</li>
	<li class="cat-item cat-item-14 current-cat"><a href="/category/tips/" >tips</a>
</li>
	<li class="cat-item cat-item-1"><a href="/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-15"><a href="/category/web-sites/" >web sites</a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta"><h1 class="widget-title">Meta</h1>			<ul>
						<li><a href="/wp-login.php">Log in</a></li>
			<li><a href="/feed/">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="/comments/feed/">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
			</aside>		<div class="clear">&nbsp;</div>
	</div><!-- #secondary -->
	<footer id="colophon" class="site-footer" role="contentinfo">
	    <a class="subscribe icon-feed" href="/feed/"><span class="tooltip">Subscribe!</span></a>
		<div class="site-info inner">
		    <section class="copyright">
		    			    		<a href="https://github.com/lacymorrow/casper" rel="home">Casper WP</a> by Lacy Morrow		    			    </section>
		</div><!-- .site-info -->
	</footer><!-- #colophon -->
</main><!-- /#content -->

<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPlain.js?ver=3.0.9b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.9b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPhp.js?ver=3.0.9b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='/wp-content/themes/casper/js/main.js?ver=1.0.0'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.10'></script>
<!--stats_footer_test--></body>
</html>
