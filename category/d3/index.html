<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True" />
<meta name="MobileOptimized" content="320" />

<title>d3 | jeromecukier.net</title>

<link rel="profile" href="http://gmpg.org/xfn/11">
<link rel="pingback" href="/xmlrpc.php">
<link rel='dns-prefetch' href='//fonts.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="jeromecukier.net &raquo; Feed" href="/feed/" />
<link rel="alternate" type="application/rss+xml" title="jeromecukier.net &raquo; Comments Feed" href="/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="jeromecukier.net &raquo; d3 Category Feed" href="/category/d3/feed/" />
<!-- This site uses the Google Analytics by MonsterInsights plugin v7.0.5 - Using Analytics tracking - https://www.monsterinsights.com/ -->
<!-- Note: MonsterInsights is not currently configured on this site. The site owner needs to authenticate with Google Analytics in the MonsterInsights settings panel. -->
<!-- No UA code set -->
<!-- / Google Analytics by MonsterInsights -->
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/localhost:8888\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.10"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='YoutubeShortcodeMargenn-css'  href='/wp-content/plugins/youtube-shortcode/youtube-shortcode.css?ver=4.6.10' type='text/css' media='all' />
<link rel='stylesheet' id='casper-google-fonts-css'  href='//fonts.googleapis.com/css?family=Noto+Serif%3A400%2C700%2C400italic%7COpen+Sans%3A700%2C400&#038;ver=4.6.10' type='text/css' media='all' />
<link rel='stylesheet' id='casper-style-css'  href='/wp-content/themes/casper/style.css?ver=4.6.10' type='text/css' media='all' />
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.6.10" />

   	<style type="text/css">
					.blog-title a, .blog-description, .social-icons a { color: #ffffff; }
		
						                
		
							.main-navigation a { color: ; }
		                                            </style>
    		<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
		<style type="text/css" id="syntaxhighlighteranchor"></style>
</head>

<body class="archive category category-d3 category-5 group-blog">

<header id="masthead" role="banner" class="site-head site-header" >
    <nav id="site-navigation" class="main-navigation" role="navigation">
        <div>
            <h1 class="menu-toggle">
                <a class="icon-bars" href="#">
                    <span class="hidden">Menu</span>
                </a>
            </h1>
            <a class="skip-link screen-reader-text" href="#content">Skip to content</a>
            <div class="menu"><ul><li ><a href="/">Home</a></li><li class="page_item page-item-6"><a href="/about/">About</a></li><li class="page_item page-item-1073"><a href="/data-stories/">Data with stories workshop &#8211; examples</a></li><li class="page_item page-item-437"><a href="/proofs-of-concept/">Private section</a></li><li class="page_item page-item-2"><a href="/sample-page/">Sample Page</a></li></ul></div>
        </div>
    </nav><!-- #site-navigation -->

    <div class="vertical-row">
        <div class="vertical">
            <div class="site-head-content inner">
                
                <div class="social-icons">
                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                <h1 class="blog-title"><a class="blog-logo" href='/' rel='home'>jeromecukier.net</a></h1>
                <h2 class="blog-description">Just another WordPress site</h2>
            </div>
        </div>
    </div>
</header><!-- #masthead -->

<main id="content" class="content" role="main">

	<section id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			<header class="page-header">
				<h1 class="page-title">
					d3				</h1>
							</header><!-- .page-header -->

						
				
<article id="post-1758" class="post-1758 post type-post status-publish format-standard hentry category-d3 category-data-visualization category-javascript category-react category-tips">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2016/08/13/beyond-rendering/" rel="bookmark"><time class="entry-date published" datetime="2016-08-13T01:41:36+00:00">August 13, 2016</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/javascript/" rel="category tag">javascript</a>, <a href="/category/react/" rel="category tag">react</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2016/08/13/beyond-rendering/" rel="bookmark">Beyond rendering</a></h1>
         
    </header>
	<section class="post-content">

		<p>This is the 5th post in my <a href="http://wp.me/po630-rq">Visualization with React</a> series. Previous post: <a href="http://wp.me/po630-sg">React components</a></p>
<h1>The lifecycle functions</h1>
<p>I&#8217;m not going to go into great details on this, but a talk on React without mentioning the <a href="https://facebook.github.io/react/docs/component-specs.html">lifecycle functions</a> would not be complete.<br />
React components come with several functions which are fired when certain events occur, such as when the component is first created (&#8216;mounts&#8217;), when it&#8217;s updated or when it&#8217;s removed (&#8216;unmounts&#8217;).<br />
Pure functional components, which we&#8217;ve been mostly using, don&#8217;t have lifecycle functions.<br />
But components with a state can have them.</p>
<p>Some examples of usage of those lifecycle functions include: </p>
<ul>
<li>Before the component is rendered, you can load data. that&#8217;s a job for &#8216;componentWillMount&#8217;.</li>
<li>After a component is rendered, you can animate it, or add an event listener. Use &#8216;componentDidMount&#8217;. </li>
<li>Prevent a component from rendering under certain circumstances, even if it receives new properties or its state changes. Use &#8216;shouldComponentUpdate&#8217;. </li>
<li>After a component receives new props or new state, you can trigger another function before the component updates (&#8216;componentWillUpdate&#8217;) or right after (&#8216;componentDidUpdate&#8217;). </li>
<li>When a component is going to be removed, you can do some cleanups, like deleting event listeners. Use &#8216;componentWillUnmount&#8217;. </li>
</ul>
<p>Oftentimes, you can simply get by by using the default behavior of React components, which re-render only when they receive different properties or when their state changes. But it can be really convenient to have that extra degree of control.</p>
<p>Here is an example of using these lifecycle functions in context.</p>
<p data-height="400" data-theme-id="0" data-slug-hash="Vjxywz" data-default-tab="result" data-user="jckr" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/jckr/pen/Vjxywz/">lifecycle functions example</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>What is going on there?<br />
We&#8217;re adapting our earlier <a href="http://codepen.io/jckr/pen/BzKVJq">scatterplot</a> example, only this time, we are not using pure functional components (which don&#8217;t have those lifecycle functions), but creating classes.<br />
We&#8217;re going to have three classes: Chart, at the highest level; Scatterplot, a child of Chart; and Points.<br />
Chart passes data to Scatterplot. What it passes depends on whether the button is clicked. That button changes the state of Chart (which causes a rerendering of the Scatterplot and the Point elements).<br />
Chart also has a private variable that holds a message we can display on top. We can still use callback functions to change this variable, just like we change the state, but the difference between changing the state and changing a private variable is that changing a private variable doesn&#8217;t cause the children to re-render.<br />
When we first create the scatterplot element, the componentDidMount function is called, and the message is changed to reflect that.<br />
Then, each time we click the button, a different data property is passed to the Scatterplot element. Also, the componentDidUpdate method is triggered, which changes the message.<br />
(changing the state of the parent from a componentDidUpdate method can cause an endless re-rendering loop, this is why I used private variables instead of the state, and there are ways to address this but for the sake of brevity this is the easiest way to deal with that problem).<br />
Now, when a full dataset is passed to the Scatterplot element, many Point elements will be created. I&#8217;ve also added a lifecycle method to these Points: when they are first created, they receive a small animation. To that end, I have also used the componentDidMount method, but this time at the Point level.<br />
Exit animations are also possible, but &#8211; full disclosure &#8211; they are less easy to implement in React than entry animations, or than in D3. So again in the interest of concision I&#8217;ll skip these for now.</p>
<h1>React and D3</h1>
<p>We just saw that with React, we can create a DOM element, then immediately after, call a function to do whatever we want, such as manipulating that element. That function would have access to all the properties and state of that React element.<br />
So what prevents us from combining React and D3? Nothing!<br />
We can create components that are, essentially, an SVG element, then use componentDidMount to perform D3 magic on that element.<br />
Here&#8217;s an example:</p>
<p data-height="600" data-theme-id="0" data-slug-hash="BzxbPY" data-default-tab="result" data-user="jckr" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/jckr/pen/BzxbPY/">mixing react and d3</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>In that example, I have used a bona fide bl.ocks (<a href="https://bl.ocks.org/mbostock/7881887">https://bl.ocks.org/mbostock/7881887</a>) and wrapped it inside a React component. So I can create one, or in the case of that example, several such elements by just passing properties. Those components can perfectly function as black boxes: we give them properties, they give us visualizations that correspond to these parameters. And it doesn&#8217;t have to be D3 &#8211; once a React element has been created, we can use componentDidMount to do all kinds of operations on it. </p>
<p>In the last 2 articles I will present actual data visualization web apps made with React.<br />
In the next post, we&#8217;ll see how to set up a simple web app and we&#8217;ll create our <a href="http://wp.me/po630-sp">first example app</a>. </p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1739" class="post-1739 post type-post status-publish format-standard hentry category-d3 category-data-visualization category-javascript category-react category-tips">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2016/08/10/coding-with-react/" rel="bookmark"><time class="entry-date published" datetime="2016-08-10T21:16:47+00:00">August 10, 2016</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/javascript/" rel="category tag">javascript</a>, <a href="/category/react/" rel="category tag">react</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2016/08/10/coding-with-react/" rel="bookmark">Coding with React</a></h1>
         
    </header>
	<section class="post-content">

		<p><script src="//assets.codepen.io/assets/embed/ei.js" async=""></script>This article is part of my series <a href="http://wp.me/po630-rQ">Visualization with React</a>. Previous article: <a href="http://wp.me/po630-rX">An ES6 primer</a></p>
<h1>Setting things up in Codepen</h1>
<p>In the last two articles of the series, I&#8217;ll cover how to get a real React coding environment going, but to start dabbling, playgrounds like <a href="https://jsfiddle.net/reactjs/69z2wepo/">jsFiddle</a> or <a href="http://codepen.io/">codepen</a> are great. I&#8217;m partial to codepen. When you create a new pen, you still have a couple of options to set up before you can start creating React code: <img src="http://jeromecukier.net/assets/visualization-with-react/react-settings-in-codepen.png" alt="" /></p>
<p>In the Settings / Javascript / quick-add section (the drop-down at the bottom left) please choose React, then React DOM.</p>
<p>All of the code examples of articles 1, 3, 4, and 5 can be found in this <a href="http://codepen.io/collection/XdEpyp/">codepen collection</a>.</p>
<h1>Creating elements</h1>
<p class="codepen" data-height="265" data-theme-id="0" data-slug-hash="pbjpOm" data-default-tab="result" data-user="jckr" data-embed-version="2">See the Pen <a href="http://codepen.io/jckr/pen/pbjpOm/">React simple scatterplot</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>In this first React example, we&#8217;re going to create a couple of very simple elements and render them. Let&#8217;s start by the end: <code>ReactDOM.render(myDiv, document.querySelector('#root'));</code> We use ReactDOM.render to, well, render something we have created (myDiv) somewhere in our document (on top of what corresponds to the &#8216;#root&#8217; selection. We conveniently have a div with the id &#8220;root&#8221; in the HTML part of the pen). That&#8217;s it! we&#8217;ve output something using React. While the syntax can appear a bit daunting, it really does one simple thing: take what you&#8217;ve made and put it where it should be. But what&#8217;s that myDiv? To find out, let&#8217;s look at the first 2 lines of our code. <code>const mySpan = React.createElement('span', {style: {fontFamily: 'sans-serif'}}, 'hello React world'); const myDiv = React.createElement('div', {className: 'my-div'}, mySpan);</code> Oh, so before there was a myDiv, there was a mySpan. MySpan is a React element, the building brick of the React eco system. To create it, we use React.createElement which is the workhorse of React. React.createElement takes three arguments: the type of React element we are creating, its properties, and its content. The type of element can be any HTML or SVG element, and we&#8217;ll see later that we can also make our own. The second argument is the properties. It&#8217;s an object. In the d3 world, the properties could be what goes in the attr method. So when you create an SVG element like a rect, its properties could include things like x, y, width and height. In d3, style is treated slightly differently. This is also the case in React. When using React.createElement with an HTML or SVG element, that could be styled using CSS, you can use a style property to pass a style object. That style object contains all CSS properties you want to apply to the object, but instead of hyphenating them, they are written in camel case (so font-family, for instance, becomes fontFamily). The third argument is content: it can either be a string, a single React element, or an array of React elements. In the first line (mySpan) we&#8217;ve used a string. So, this first line created a React element which is a span, which contains &#8220;hello React world&#8221;, and which has a simple style applied to it. In the second line, we create a second React element. Again, React.createElement takes three arguments: type of element (now it&#8217;s an HTML div), properties and content. Instead of providing a string, we can pass another React element, such as mySpan that we created above. And that&#8217;s it! we&#8217;ve rendered something using react.</p>
<h1>Creating elements from data</h1>
<p>In the example above, we&#8217;ve used React.createElement with two kind of content: a string and another React element. But I mentioned that there was a third possibility: an array of React elements. If you&#8217;re familiar with d3, you might think: in d3, I could do that from an array of data. The idea in React is pretty similar, only, instead of using select / selectAll / data / enter / append, we can just create our array.</p>
<p class="codepen" data-height="350" data-theme-id="0" data-slug-hash="ezZrOM" data-default-tab="result" data-user="jckr" data-embed-version="2">See the Pen <a href="http://codepen.io/jckr/pen/ezZrOM/">React simple scatterplot</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>One simple way to do that is to use map: <code>myArray.map(d =&gt; React.createElement(...))</code>. This is exactly what we are doing in the snippet of code above. This uses the birthdeathrates dataset, one of the example files provided with R (number of births and deaths per thousand people per year in various countries.) The interestingness happens here:</p>
<pre class="brush: jscript; title: ; notranslate" title="">birthdeathrates.map(
  (d, i) =&gt; React.createElement('div', {
    'key': i,
    'style': {
       background: '#222',
       borderRadius: 5,
       height: 10,
       left: 5 * d.birth,
       top: 300 - 5 * d.death,
       position: 'absolute',
       width: 10,
       opacity: .2}
  })
)</pre>
<p>In the properties that I pass, some depend on the underlying data. This is a mapping so it&#8217;s going to return something for each item of the array. Each item of the array is represented by d, and has the birth, death and country properties. In left and top, we use a calculation based on these properties. And for each item, we get a React element created with these calculations. This isn&#8217;t unlike what we&#8217;d had in d3 if we had written:</p>
<pre class="brush: jscript; title: ; notranslate" title=""> ...
 .selectAll('div')
 .data(birthdeathrates)
 .enter()
 .append('div')
 .style({ ..., left: d =&gt; 5 * d.birth, top: d =&gt; 300 - 5 * d.death, ...})
</pre>
<p>Take note of the key property in the react code. This is necessary when you create many elements using map (well not really necessary but strongly recommended, you&#8217;d get a warning if you don&#8217;t use it). This is used so that if for some reason your parent element has to re-render, each child element will only be re-rendered if needed. If you&#8217;ve followed this far, you are now capable of doing things in React the critical part of what you were doing with d3: creating elements out of data. You might wonder: but does it work for svg? yes, and the logic is exactly the same:</p>
<p class="codepen" data-height="373" data-theme-id="0" data-slug-hash="MeyVLE" data-default-tab="result" data-user="jckr" data-embed-version="2">See the Pen <a href="http://codepen.io/jckr/pen/MeyVLE/">React simple scatterplot</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<h1>Introducing JSX</h1>
<p data-height="373" data-theme-id="0" data-slug-hash="YWqLwz" data-default-tab="result" data-user="jckr" data-embed-version="2" class="codepen">See the Pen <a href="http://codepen.io/jckr/pen/YWqLwz/">React simple scatterplot JSX</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>At this point you might think: all of this is great, but typing React.createElement all the time is kind of cumbersome. Many people do too, and there are a number of ways to not do that. The most popular, and the one in use at Facebook, is JSX. I personally use <a title="r-dom" href="http://https://github.com/uber/r-dom">r-dom</a> most of the time, but since JSX is definitely the most common way to write React, now that you have a feel for what React.createElement does, it&#8217;s not unreasonable to continue with JSX.</p>
<p>The main idea of JSX is that you&#8217;ll write tags in your javascript. Instead of writing:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
React.createElement('type', {property1: value1, property2: value2, ...}, content)
</pre>
<p>you would write:</p>
<pre class="brush: plain; title: ; notranslate" title="">
&lt;type property1={value1} property2={value2} ...&gt;
content
&lt;/type&gt;
</pre>
<p>So in our previous example, we create an SVG element that has a width and a height property.<br />
We&#8217;d write:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
const svg = &lt;svg height={300} width={300}&gt;
//... content ...
&lt;/svg&gt;
</pre>
<p>Inside the opening tag, we list all the properties and we give them a value. This isn&#8217;t unlike what you&#8217;d see when you watch the source of an HTML file.<br />
The value of the properties go inside curly braces, unless they are a string. For length-type values (ie height, width, top, left, font-size&#8230;) if a number is provided, it&#8217;s assumed it&#8217;s in px.<br />
If the element we create has other elements inside of it, there has to be an opening and a closing tag (ie &lt;element&gt; and &lt;/element&gt;). But if there isn&#8217;t, there can be a single tag (ie &lt;element /&gt;)<br />
Inside our svg, we have a bunch of circle elements. They are of the form:</p>
<pre class="brush: plain; title: ; notranslate" title="">
&lt;circle 
  cx={5 * d.birth}
  cy={300 - 5 * d.death}
  key={i}
  r={5}
  style={{
    fill: '#222',
    opacity: .2
  }}
/&gt;</pre>
<p>inside our curly braces, we can have calculations. And since there are no elements inside our circles, we don&#8217;t have to have both a &lt;cirlce&gt; and a &lt;/circle&gt; tag, although we could; we can have a single &lt;circle /&gt; tag.</p>
<p>That&#8217;s it in a nutshell, more details can be found <a title="here" href="https://facebook.github.io/react/docs/jsx-in-depth.html">here.</a><br />
Now you might think: if I type that in my text editor, I&#8217;m almost certain I&#8217;ll get an error! Indeed, behind the scenes, there has to be some transformation for your browser to understand JSX. This magical operation is called <em>transpilation</em>. Transpilation is just what you&#8217;d hope it is, it turns code written how you like into code that the browser can interpret flawlessly. The flip side is that&#8230; well, you have to transpile your code.<br />
If you work into environments like codepen or JsFiddle, they can take care of this for you. The most common transpiler is Babel. Babel turns your code into ES2015 compliant javascript (that is, before ES6). So the added bonus is that we can use any ES6 feature without wondering whether the user browser supports it or not. Most ES6 features are supported by the latest versions of many browswers, but there&#8217;s no guarantee that your users will run your favorite browser, let alone its latest version.<br />
If you want to do this on your own, you&#8217;ll have to set up a build environment, we&#8217;ll cover this in the last two articles.</p>
<p>&nbsp;</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1722" class="post-1722 post type-post status-publish format-standard hentry category-d3 category-data-visualization category-javascript category-react category-tips">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2016/08/09/d3-and-react-similarities-and-differences/" rel="bookmark"><time class="entry-date published" datetime="2016-08-09T06:13:37+00:00">August 9, 2016</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/javascript/" rel="category tag">javascript</a>, <a href="/category/react/" rel="category tag">react</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2016/08/09/d3-and-react-similarities-and-differences/" rel="bookmark">D3 and React &#8211; similarities and differences</a></h1>
         
    </header>
	<section class="post-content">

		<p><script src="//assets.codepen.io/assets/embed/ei.js" async=""></script><br />
<a href="http://wp.me/po630-rr">Previous article: Visualization with React</a></p>
<h1>d3, meet cousin React</h1>
<p>Let&#8217;s not sugarcoat it: working with React is more complicated than with plain vanilla javascript. There are a few additional notions which may sound complex. But the good news is that if you come from the d3 world, there are many concepts which are similar. Visualization on the web is, at its core,<strong> transforming a dataset into a representation</strong>. That dataset is probably going to be an array, and at some point the framework will loop through the array and create something for each element of the array. For instance, if you want to make a bar chart, you probably will have at some point an array with one item that corresponds to each bar, which has a value that corresponds to its length. Looping through the array, each item is turned into a rectangle whose height depends on that value. That logic, which is at the core of d3 with <a href="http://www.jeromecukier.net/blog/2013/03/05/d3-tutorial-at-strata-redux/">selections</a>, is also present in React. In d3, <strong>visualizations are essentially hierarchical.</strong> We start from an SVG element (probably), add to it elements like groups, which can hold other elements. To continue with our bar chart example, our chart will have several data marks attached to it (the bars), and there&#8217;s a hierarchical relation between them: the chart contains those marks. Our chart could be part of a dashboard that has several charts, or part of a web page that has other information. At any rate, in the d3 world, everything we create is added to a root element or to elements we create and arranged in a tree-like hierarchy. This is also the case in React, with a difference: the world of React is mostly structured into components. When that of d3 is mostly made of DOM elements like HTML or SVG elements, that of React is made of components. A React component is a part of your end result. It can be as small as a DOM element, or as big as the whole application. And it can have component children. So, components are logical ways to package your application. Components are created with modularity and reusability in mind. For instance, I can create a bar chart component in React, and the next time I have a bar chart to make, I can just reuse the exact same component. I can also create components to make axes or the individual bars in the chart, which my bar chart component will use. But the next time I need a bar chart, I wouldn&#8217;t have to think about it. In contrast, if I want to create another bar chart in d3, I probably have to recreate it from scratch and decide manually what happens to all the SVG or HTML elements that constitute the bar chart.</p>
<h1>You say dAYta, I say da-tah</h1>
<p>One fundamental way in which d3 and React differ is by how they treat data. If you read about React, you may find fancy terms like one-way data binding. In how many ways the data is bound in d3 is not something which is on top of our head when we create visualization so that might sound confusing. In d3, an element can modify the data which is associated to it. I&#8217;ve used it so many times.</p>
<p class="codepen" data-height="265" data-theme-id="0" data-slug-hash="XKmpYo" data-default-tab="result" data-user="jckr" data-embed-version="2">See the Pen <a href="http://codepen.io/jckr/pen/XKmpYo/">React simple scatterplot</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>These bars have been made with a very simple dataset shown below them. If you click on the bars, the underlying data will change and the representation will change as well. In the world of React, when properties are passed to a component, they cannot be changed. That&#8217;s what one-way binding means. Data in React flows unidirectionally. Once it&#8217;s defined, it determines the way all components should be displayed. In certain events, a parent component can pass different properties to its children component and they may be re-rendered (we&#8217;ll see this in just a moment). But the important part is that properties passed to a component can never be changed. You may wonder: why is that even a good thing? React makes it impossible to do things! yes, but in the process it also makes things much safer. If properties can&#8217;t be changed, it also means that they can&#8217;t be altered by something we hadn&#8217;t thought of. Also, it makes it much easier to work on components independently: one team mate could make a bar chart component while her colleague makes a line chart. They don&#8217;t really need to know the inner working of the other component, and they know that nothing unexpected will disturb the way their component function.</p>
<h1>The state of affairs</h1>
<p>Components of React have a really powerful feature which doesn&#8217;t explicitly exist in d3: the state. The state represents the current status of a component. Here&#8217;s a simple switch component:</p>
<p class="codepen" data-height="265" data-theme-id="0" data-slug-hash="mEeRvr" data-default-tab="result" data-user="jckr" data-embed-version="2">See the Pen <a href="http://codepen.io/jckr/pen/mEeRvr/">React simple scatterplot</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>We want to record the fact that the switch can be turned on or off. Here&#8217;s how it should work: First we create our switch component, and it&#8217;s supposed to be off. Then, if the user clicks it, it becomes on if it were off and vice-versa. And it should also be redrawn, to reflect that it&#8217;s been turned on (or off). The state does all that. It records the current status of the component. Technically, it&#8217;s an object with properties, so it can save a lot of information, not just a simple true or false value. The other great thing about the state is that if it changes, then the component is re-rendered. Rendering a component could require rendering children component, and they may be re-rendered as well. So with the state and properties, we have a powerful framework to handle events and whatever may happen to our app. If there&#8217;s an event we care about, it can change the state of a component, then, all of the children components may be re-rendered. And there&#8217;s no other way to redraw them. This is in contrast with plain d3 where anything goes &#8211; anything can change anything, data can be used to render elements, the underlying data can be changed without changing the element, the element can be transformed without changing the underlying data.</p>
<p>State is an important notion in computer science. In d3, it&#8217;s just doesn&#8217;t have a more formal representation than all the variables in your code.</p>
<p>In the next article in the series, <a href="http://wp.me/po630-rX">an ES6 Primer</a>, we will look in some useful ES6 features for React. </p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1726" class="post-1726 post type-post status-publish format-standard hentry category-d3 category-data-visualization category-javascript category-react category-tips">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2016/08/09/visualization-with-react/" rel="bookmark"><time class="entry-date published" datetime="2016-08-09T06:07:56+00:00">August 9, 2016</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/javascript/" rel="category tag">javascript</a>, <a href="/category/react/" rel="category tag">react</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2016/08/09/visualization-with-react/" rel="bookmark">Visualization with React</a></h1>
         
    </header>
	<section class="post-content">

		<h1>Some back story&#8230;</h1>
<p>In what seemed a lifetime ago now, I wrote tutorials to help people get started with Protovis as I learned it myself (it is indeed a lifetime away since Protovis is dead and buried for all intents and purposes). And a few years ago, I did the same for d3 as this started to become the most powerful visualization framework and for which documentation was still scarce. I wrote these tutorials to help me learn, but since then I have met many people who found them useful which blew my mind. By documenting my learning, I got noticed by Facebook and travelled 9000 miles to a new life.</p>
<p>At Facebook, I had some loosely-defined data visualization explorer role. While I joined during the infancy of React, I didn&#8217;t feel super comfortable using it then &#8211; I felt more effective writing one-off d3 applications. Eventually, I moved on and am now working at Uber as a fully-fledged <a href="https://eng.uber.com/data-viz-intel/">data visualization engineer</a>. I work almost exclusively with dashboards, which have a pretty elaborate UI.</p>
<p>Like in many other companies, at Uber, we use React for our web applications, including our visualizations, dashboards and maps. Increasingly, React is becoming the lingua franca of visualization: more than a tool that allows one to draw data, a mindset that informs how one should think a visualization. React is no longer a young library &#8211; the initial public release dates back from May 2013, and its very first application at Facebook was visualization (my first Facebook project, pages insights). There&#8217;s already many, many learning resources and tutorials for React. What I&#8217;ll try to do here is to show how React can be used for visualization: hopefully, this will be useful both for people who come from d3 and who&#8217;ve never worked with a web framework before, and for people who are familiar with React but who don&#8217;t know visualization well. That won&#8217;t be a complete and exhaustive guide, more a way to get started with references on how to go further.</p>
<h1>The articles</h1>
<p>I&#8217;ve structured this guide in 7 parts, and I&#8217;ll publish one per day:</p>
<ol>
<li><a href="http://www.jeromecukier.net/blog/2016/08/09/d3-and-react-similarities-and-differences/">React vs D3</a>, where we&#8217;ll explore similarities and differences between these two frameworks.</li>
<li><a href="http://wp.me/po630-rX">An ES6 primer</a>. I have written all the examples in good, sensible, modern ES6 javascript, because as of 2016 this is probably the most common syntax. Without going too deep into the details, I&#8217;ll explain what parts of the language I used for the examples, and how they differ from ES5.</li>
<li>Gentle introduction to <a href="http://wp.me/po630-s3">coding with React</a>, where we&#8217;ll explore the high-level concepts of the framework and see how we can create visual elements from data. We&#8217;ll end on a presentation of JSX, a flavor of Javascript used to write React applications, which I&#8217;ll also use for most of the examples for the same reasons as ES6 &#8211; because it&#8217;s the most widespread way of writing React code today.</li>
<li><a href="http://wp.me/po630-sg">React components</a>, the most important concept in React and the building blocks of React applications.</li>
<li><a href="http://wp.me/po630-sm">Beyond rendering</a>. We&#8217;ll look at the React concept of lifecycle methods, and also how we can use d3 within React components.</li>
<li><a href="http://wp.me/po630-st">Creating a React visualization web app</a> &#8211; using what we&#8217;ve seen, and two libraries &#8211; Facebook&#8217;s <a href="https://github.com/facebookincubator/create-react-app">create-react-app</a> and Uber&#8217;s <a href="https://github.com/uber/react-vis/">React-vis</a>, we&#8217;ll create a small standalone React visualization that can be deployed on its own website.</li>
<li><a href="http://wp.me/po630-st">The big leagues</a> &#8211; in that last part, we&#8217;ll write together a more complex visualization with live data and several components interacting with one another.</li>
</ol>
<h1>The code</h1>
<p>The examples of parts 1-5 can be found on <a href="http://codepen.io/collection/XdEpyp/">codepen</a>. I&#8217;ll add link to examples of part 6 and 7 when they go live.</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1664" class="post-1664 post type-post status-publish format-standard hentry category-charts category-d3 category-javascript category-tips tag-canvas tag-d3js tag-dom tag-javascript tag-library tag-svg">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2015/05/19/you-may-not-need-d3/" rel="bookmark"><time class="entry-date published" datetime="2015-05-19T23:15:56+00:00">May 19, 2015</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/charts/" rel="category tag">charts</a>, <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/javascript/" rel="category tag">javascript</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2015/05/19/you-may-not-need-d3/" rel="bookmark">You may not need d3</a></h1>
         
    </header>
	<section class="post-content">

		<p>If you&#8217;re working on visualization on the web, the go-to choice is to use <a href="http://d3js.org/">d3js</a> (or a higher-level library). d3js is powerful and versatile. The best proof of that is the lead author of d3, Mike Bostock, worked until recently at the New York Times which many, including myself, consider the ultimate reference in terms of information graphics. At the NYT and elsewhere, d3js has powered breathtaking projects.</p>
<p>d3js was built as a successor to protovis. Protovis was a slightly higher-level library than d3js, more specialized in data graphics, and designed with the assumption that it could be used with little or no programming experience. And indeed this was true. When I started using protovis in 2009, my javascript skills were limited, and so I learned by deconstructing and recombining the examples. I kept on doing that when d3 came along &#8211; learning through examples. And the d3 examples, like those in protovis before, were short and standalone, demonstrating how easy it was to create something with a few lines of code.</p>
<p>d3js requires more technical knowledge than protovis did to get started, but not much. However, it is much more versatile &#8211; no longer constrained to charts and maps, it can handle a lot of the front-end functionalities of a web site. And so, it is possible to make visualizations by:</p>
<ul>
<li>learning how to do stuff in d3js,</li>
<li>learning the essential javascript that you need to run d3js, as needed (i.e. variables, if-then statements, array methods&#8230;)</li>
<li>then, learning through doing, and obtain a feeling for how SVG, HTML and the Document Object Model works.</li>
</ul>
<p>This approach is actually very limiting.</p>
<p>You would create much more robust code by:</p>
<ul>
<li>learning javascript,</li>
<li>learning SVG/HTML/DOM,</li>
<li>then learning and appreciate d3 logic.</li>
</ul>
<p>That would give you the choice when to use a d3js method, when to use another library (past, present or future), or when to use native javascript.</p>
<p>The point of this article is to go through the main functions of d3js and see how they can be replicated without using a library. As of this writing, I am convinced that using d3js is the most sensible way to handle certain tasks (though this may change in the future). In almost any case I can think of, even when it&#8217;s not the most efficient way to do so, using the d3js approach is the most convenient and the easiest from the developer&#8217;s perspective.  But I also believe it&#8217;s really important to know how to do all these things without d3js.</p>
<p>This will be a very long post. I&#8217;m trying to keep it as structured as possible so you can jump to the right section and keep it as a reference. This also assumes you have a certain familiarity with d3js and javascript &#8211; this is not an introductory post.</p>
<p>I&#8217;ve divided it in 4 parts:</p>
<ul>
<li>Tasks that you really don&#8217;t need d3js for. And ok, you may want to use it regardless. But here&#8217;s how to do those things without it. (manipulating DOM elements)</li>
<li>interlude: a reflexion on d3js data binding. Do you really need that?</li>
<li>Tasks which are significantly easier with d3js (working with external data, animation)</li>
<li>Tasks where as of now, d3js is clearly superior to anything else (scales, array refactoring, map projections, layouts).</li>
</ul>
<h2>Selecting and manipulating elements</h2>
<p>At the core of d3js is the notion of selection. In d3js, you select one or several elements which become a selection object. You can then do a variety of things:</p>
<ul>
<li>join them with data, which is also an essential tenet of the d3 philosophy,</li>
<li>create or delete elements, especially in relation to the data you may have joined with their parent,</li>
<li>manipulate these elements by changing their attributes and their style, including in function of the data joined with each of them,</li>
<li>attach events listeners to those elements, so that when events happen (ie somebody clicks on a rectangle, or change the value of a form) a function might be triggered,</li>
<li>animate and transform those elements.</li>
</ul>
<h3>Selecting elements and parsing the DOM</h3>
<h4>d3 selection objects vs Nodes, HTML NodeList vs HTML LiveCollections</h4>
<p>When you select something with d3js, using methods such as d3.select() or d3.selectAll(), this returns a d3 selection object. The selection object is a subclass of the javascript object Array &#8211; <a href="http://bost.ocks.org/mike/selection/">check here for all the nitty-gritty</a>. The gist of it is that d3 selection objects can then be manipulated by d3 methods, such as .attr() or .style() to assign attributes or styles.</p>
<p>By contrast, the DOM is made of Node objects. The root of the DOM, the Document Object Model, is a special Node called Document. Nodes are organized in a tree-like structure: Document has children, which may have children etc. and encompass everything in the page. The Node objects are really the building blocks of a web page. When an element is added, be it an HTML element like a &lt;div&gt; or an SVG element like a &lt;rect&gt;, a new Node is created as well. So d3js has to interact with Node objects as well. d3 selection objects are tightly connected to their corresponding Node objects.</p>
<p>However, with &#8220;vanilla&#8221; javascript, you can <em>directly</em> access and manipulate the Node objects.</p>
<h4>d3.select / d3.selectAll vs document.querySelector / document.querySelectorAll</h4>
<p>In d3js, you parse the document using d3.select (to select one object) or d3.selectAll. The argument of this method is a <a href="https://github.com/mbostock/d3/wiki/Selections">CSS3 selector</a>, that is, a string which is very similar to what could be found in a CSS style sheet to assign specific styles to certain situations. For instance, &#8220;g.series rect.mark&#8221; will match with all the rectangles of the class &#8220;mark&#8221; which are descendants of the SVG g groups of the class series.</p>
<p>When d3js was introduced in 2011, javascript didn&#8217;t have an equivalent syntax &#8211; instead you could select elements by class, or by id, or by tag name (more on that in a minute). Things have changed however and it is now possible to use CSS3 selectors using document.querySelector (which will return just one node) or document.querySelectorAll (which will return an HTML NodeList).</p>
<p>An HTML NodeList is a special object which is kind of like an array of Node objects, only it has almost no array methods or properties. You can still access its members using brackets, and get its length, but that&#8217;s it.</p>
<p>I wrote document.querySelectorAll, because you can use this method from the document, but you can use it from any Node. Those two snippets of code are parallel:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var svg = d3.select(&quot;svg&quot;); // svg is a d3 selection object
var g = svg.selectAll(&quot;g&quot;); // g is a d3 selection object
</pre>
<pre class="brush: jscript; title: ; notranslate" title="">
var svg = document.querySelector(&quot;svg&quot;); // svg is a Node
var g = svg.querySelectorAll(&quot;g&quot;); // g is a NodeList
</pre>
<h4> Getting elements by class name, ID, tag name, name attribute</h4>
<p>d3js doesn&#8217;t have a special way to get all descendants of a selection of a certain class, of a certain ID, etc. The CSS3 selector syntax can indeed handle all those cases, so why have a separate way?</p>
<p>By contrast, javascript pre-2011 didn&#8217;t have a querySelectorAll method, and so the only way to parse the document was to use more specific method, like document.getElementsByClassName().</p>
<p>document.getElementsByClassName() retrieves all descendants of a certain class. document.getElementsByName() retrieves elements with a certain &#8220;name&#8221; attribute (think forms). documents.getElementsByTagName() gets all descendants of a certain type (ie all &lt;div&gt;s, all &lt;rect&gt;s, etc.).</p>
<p>What&#8217;s interesting about that is that what is returned is not an HTML NodeList like above with querySelectorAll, but another object called HTML <strong>Live Collection</strong>. The difference is that matching elements are created after, they would still be included in the Live Collection.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var svg = d3.select(&quot;svg&quot;);
svg.selectAll(&quot;rect&quot;).data([1,2,3]).enter().append(&quot;rect&quot;);
var mySelection = svg.selectAll(&quot;rect&quot;); // 3 elements
mySelection[0].length // 3
svg.append(&quot;rect&quot;);
mySelection[0].length // 3
mySelection = svg.selectAll(&quot;rect&quot;); // re-selecting to update it
mySelection[0].length // 4
</pre>
<pre class="brush: jscript; title: ; notranslate" title="">
var svg = document.querySelector(&quot;svg&quot;);
var ns = &quot;http://www.w3.org/2000/svg&quot;;
var i;
for (i = 0; i &lt; 3; i++) {
  var rect = document.createElementNS(ns, &quot;rect&quot;); // we'll explain creating elements later
  svg.appendChild(rect);
}
var mySelection = svg.getElementsByTagName(&quot;rect&quot;); // 3 elements
var rect = document.createElementNS(ns, &quot;rect&quot;);
svg.appendChild(rect);
mySelection.length // 4 - no need to reselect to update
</pre>
<p>How about IDs? there is also the getElementById (no s at elements!) which only retrieve one element. After all, IDs are supposed to be unique! if no elements match, getElementById returns null.</p>
<h4>Children, parents, siblings&#8230;</h4>
<p>Truth be told, if you can use selectors from the root, you can access everything. But sometimes, it&#8217;s nice to be able to go from one node to its parents or its children or its siblings, and d3js doesn&#8217;t provide that. By contrast, the Node object has an interface that does just that &#8211; node.childNodes gets a nodeList of child nodes, node.parentNode gets the parent node, node.nextSibling and node.previousSibling get the next and previous siblings. Nice.</p>
<p>However, most often you will really be manipulating elements (more on that in a second) and not nodes. What&#8217;s the difference? all Elements are Nodes, but the reverse is not true. One common example of Node which is not an Element is text content.</p>
<p>To get an Element&#8217;s children, you can use the (wait for it) children property. The added benefit is that what you get through children is a LiveCollection (dynamic), while what you get through childNodes is a NodeList (static).</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var svg = document.querySelector(&quot;svg&quot;);
var ns = &quot;http://www.w3.org/2000/svg&quot;;
var i;
for (i = 0; i &lt; 3; i++) {
  var myRect = document.createElementNS(ns, &quot;rect&quot;); // we'll explain creating elements later
  svg.appendChild(rect);
}
// the variable myRect holds the last of the 3 &lt;rect&gt; elements that have been added
svg.childNodes; // a NodeList
myRect.parentNode; // the svg element
myRect.nextSibling; // null - myRect holds the last child of svg.
myRect.previousSibling; // the 2nd &lt;rect&gt; element
svg.firstChild; // the 1st &lt;rect&gt;. Really useful shorthand
svg.querySelector(&quot;rect&quot;); // also the 1st &lt;rect&gt;.
svg.children; // a LiveCollection
</pre>
<h2>Adding/reading attributes, styles, properties and events</h2>
<h4>Node, Element, EventTarget and other objects</h4>
<p>In d3 101, right after you&#8217;ve created elements (to which we&#8217;ll come in a moment), you can start moving them around or giving them cool colors like &#8220;steelblue&#8221; by using the .attr and .style methods.</p>
<p>Wouldn&#8217;t that be cool if we could do the same to Node objects in vanilla javascript!</p>
<p>Well, we can. Technically, you can&#8217;t add style or attributes to Node objects proper, but to Element objects. The Element object inherits from the Node objects and is used to store these properties. There is also an HTMLElement and SVGElement which inherit from the Element object.</p>
<p>If you look at the Chrome console at an SVG element like a rect, you can see, in the properties tab, all the objects it inherits from: Object, EventTarget, Node, Element, SVGElement, SVGGraphicsElement, SVGGeometryElement, SVGRectElement, rect.</p>
<p>All have different roles. To simplify: Node relates to their relative place in the document hierarchy, EventTarget, to events, and Element and its children, to attributes, style and the like. The various SVG-prefixed objects all implement specific methods and properties. When we select a Node object as we&#8217;ve done above with svg.querySelector(&#8220;rect&#8221;) and the like, note that there&#8217;s not a Node object on one side, then an Element object somewhere else, a distinct SVGGeometryElement, and so on and so forth. What is retrieved is <em>one single object</em> that inherits all methods and properties of Nodes, Elements, EventTargets, and so on and so forth, and, as such, that behaves like a Node, like an Element, etc.</p>
<h4>Setting and getting attributes</h4>
<p>You can set attributes with the Element.setAttribute method.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var rect = document.querySelector(&quot;rect&quot;);
rect.setAttribute(&quot;x&quot;, 100);
rect.setAttribute(&quot;y&quot;, 100);
rect.setAttribute(&quot;width&quot;, 100);
rect.setAttribute(&quot;height&quot;, 100);
</pre>
<p>To be honest, I&#8217;m a big fan of the shorthand method in d3js,</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var rect = d3.select(&quot;rect&quot;);
rect.attr({x: 100, y: 100, width: 100, height: 100});
</pre>
<p>Also, the Element.setAttribute method doesn&#8217;t return anything, which means it can&#8217;t be chained (which may or may not be a bad thing, though it&#8217;s definitely a change for d3js users). It&#8217;s not possible to set several attributes in one go either, although one could create a custom function, or, for the daring, extend the Element object for that.</p>
<p>Likewise, the Element object has a getAttribute method :</p>
<pre class="brush: jscript; title: ; notranslate" title="">
rect.getAttribute(&quot;x&quot;); // 100
</pre>
<h4>Classes, IDs and tag names</h4>
<p>Classes, IDs and tag names are special properties of the Element objects. It&#8217;s extremely common to add or remove classes to elements in visualization: my favorite way to do that is to use the classed method in d3js.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.select(&quot;rect&quot;).classed(&quot;myRect&quot;, 1)
</pre>
<p>In vanilla javascript, you have the concept of classList.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
document.querySelector(&quot;rect&quot;).classList; // [&quot;myRect&quot;]
</pre>
<p>ClassList has a number of cool methods. contains checks if this Element is of a certain class, add adds a class, remove removes a class, and toggles, well, toggles a class.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
document.querySelector(&quot;rect&quot;).classList.contains([&quot;myRect&quot;]); // true
document.querySelector(&quot;rect&quot;).classList.remove(&quot;myRect&quot;);
document.querySelector(&quot;rect&quot;).classList.add(&quot;myRect&quot;);
document.querySelector(&quot;rect&quot;).classList.toggle(&quot;myRect&quot;);
</pre>
<p>How about IDs ? with d3js, you&#8217;d have to treat them as any other property (rect.attr(&#8220;id&#8221;)). In vanilla javascript, however, you can access it directly via the id property of Element. You can also do that with the name property.<br />
Finally, you can use the tagName to get the type of element you are looking at (though you cannot change it &#8211; you can try, it just won&#8217;t do anything).</p>
<pre class="brush: jscript; title: ; notranslate" title="">
document.querySelector(&quot;rect&quot;).id = &quot;myRect&quot;; // true
document.querySelector(&quot;rect&quot;).name; // undefined;
document.querySelector(&quot;rect&quot;).tagName; // &quot;rect&quot;
document.querySelector(&quot;rect&quot;).tagName = &quot;circle&quot;;
document.querySelector(&quot;rect&quot;).tagName; // &quot;rect&quot;
</pre>
<h4>Text</h4>
<p>Text is a pretty useful aspect of visualization! it is different from attributes or styles, which are set in the opening tag of an element. The text or content is what is happening in between the opening and closing tags of that element. This is why, in d3js, text isn&#8217;t set using attr or style, but either by the html method for HTML elements like DIVs or Ps, or by the text method for SVG elements like &lt;text&gt; and &lt;tspan&gt;.</p>
<p>Those have equivalent in the DOM + javascript world.</p>
<p>HTMLelements have the .innerHTML and outerHTML properties. The difference between the two is that outerHTML includes the opening and closing tags. innerHTML and outerHTML both return HTML, complete with tags and syntax.</p>
<p>SVG elements, however, don&#8217;t have access to this property, so they have to rely on the Node property textContent. HTML elements also have access to it, by the way. textContent returns just the plain text content of what&#8217;s in the element. All three properties can be used to either get or set text.</p>
<h4>Style</h4>
<p>In d3js, setting styles to elements is very similar to setting attributes, only we use the .style method instead of the .attr one. It&#8217;s so much similar that it&#8217;s a rather common mistake to pass as attribute what should be a style and vice-versa! Like with attributes, it is possible to pass an object with keys and values to set several style properties at once.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.selectAll(&quot;rect&quot;).style(&quot;fill&quot;, &quot;red&quot;);
d3.selectAll(&quot;rect&quot;).style({stroke: &quot;#222&quot;, opacity: .5});
</pre>
<p>In the world of DOM and vanilla javascript, style is a property of the HTMLElement / SVGElement objects. You can set style properties one at a time:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
rect = document.querySelector(&quot;rect&quot;);
rect.style.fill = &quot;red&quot;;
rect.style.stroke = &quot;#222&quot;;
rect.style.opacity = .5;
</pre>
<p>Technically, .style returns a CSSStyleDeclaration object. This object maintains a &#8220;live&#8221; link to what it describes. So:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
myStyle = rect.style;
rect.style.fill = &quot;yellow&quot;;
myStyle.fill; // &quot;yellow&quot;
</pre>
<p>Finally, the window object has a getComputedStyle method that can get the computed styles of an element, ie how the element is actually going to get drawn. By contrast, the style property and the d3js style method only affect the inline styles of an element and are &#8220;blind&#8221; to styles of its parents.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
myStyle = window.getComputedStyle(rect, null);
myStyle.fill; // &quot;yellow&quot;
</pre>
<h4>Adding and removing events</h4>
<p>In d3js, we have the very practical method &#8220;on&#8221; which let users interact with elements and can trigger behavior, such as transformations, filtering, or, really, any arbitrary function. This is where creating visualizations with SVG really shines because any minute interaction with any part of a scene can be elegantly intercepted and dealt with. Since in d3js, elements can be tied with data, the &#8220;on&#8221; methods takes that into account and passes the data element to the listener function. One of my favorite tricks when I&#8217;m developing with d3js and SVG is to add somewhere towards the end the line:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.selectAll(&quot;*&quot;).on(&quot;click&quot;, function(d) {console.log(d);})
</pre>
<p>Which, as you may have guessed, displays the data item tied to any SVG element the user could click on.</p>
<p>In the world of the DOM, the object to which events methods are attached in the EventTarget. Every Element is also an EventTarget (and EventTarget could be other things that handle events too, like xhr requests).</p>
<p>To add an event listener to an element, use the addEventListener method like so.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
document
  .querySelector(&quot;rect&quot;)
  .addEventListener(&quot;click&quot;, function() {
     console.log(&quot;you clicked the rectangle!&quot;
   }, false);
</pre>
<p>The first parameter is the type of event to listen to (just as in &#8220;on&#8221;), the second is the listener function proper. The third one, &#8220;use capture&#8221;, a Boolean, is optional. If set to true, it stops the event from propagating up and being intercepted by event listeners of the parents of this element.</p>
<p>There is also a &#8220;removeEventListener&#8221; method that does the opposite, and needs the same elements: in other words, yes, you need to pass the same listener function to be able to stop listening to the element. There is no native way to remove all event listeners from an element, although there are <a href="http://stackoverflow.com/questions/9251837/how-to-remove-all-listeners-in-an-element">workarounds</a>.</p>
<h2>Creating and removing elements</h2>
<p>Selecting and modifying elements is great, but if you are creating a visualization, chances are that you want to create elements from scratch.</p>
<p>Let&#8217;s first talk about how this is done in the DOM/javascript, then we&#8217;ll better understand the data joins and d3 angle.</p>
<p>Node objects can exist outside of the hierarchy of the DOM. Actually, they must first be created, <em>then</em> be assigned to a place in the DOM.</p>
<p>Until a Node object is positioned in the DOM, it is not visible. However, it can receive attributes, styles, etc. Likewise, a Node object can be taken from the DOM, and still manipulated.</p>
<p>To create an HTML element, we can use the document.createElement() method:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var myDiv = document.createElement(&quot;div&quot;);
</pre>
<p>However, that won&#8217;t work for SVG elements &#8211; remember in an earlier example, we used the createElementNS method. This is because SVG elements have to be created in the SVG namespace. d3js old-timers may remember that in the first versions, we had to deal with namespaces when creating elements in d3js as well, but now this all happens under the hood.</p>
<p>Anyway, in vanilla javascript, this is  how it&#8217;s done:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var svgns = &quot;http://www.w3.org/2000/svg&quot;;
var myRect = document.createElementNS(svgns, &quot;rect&quot;);
</pre>
<p>Warning, because document.createElement(&#8220;rect&#8221;) will not produce anything useful as of this writing.</p>
<p>Once the new Node objects are created, in order to be visible, they should be present in the DOM. Because the DOM is a tree, this means that they have to have a parent.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
svg.appendChild(myRect);
</pre>
<p>Likewise, to remove a Node from the DOM means to sever that relationship with its parent, which is done through the removeChild method:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
svg.removeChild(myRect);
</pre>
<p>Again, even after a Node has been removed, it can still be manipulated, and possibly re inserted at a later time.</p>
<p>Nodes don&#8217;t remove themselves, but you can write:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
myRect.parentNode.removeChild(myRect);
</pre>
<p>In contrast, here is how things are done in d3js.</p>
<p>The append method will add one element to a parent.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.select(&quot;svg&quot;).append(&quot;rect&quot;);
</pre>
<p>The remove method will remove one entire selection object from the DOM.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.select(&quot;svg&quot;).selectAll(&quot;rect&quot;).remove(); // removes all rect elements which are children of the SVG element
</pre>
<p>But the most intriguing and the most characteristic way to <a href="http://www.jeromecukier.net/blog/2011/08/09/d3-adding-stuff-and-oh-understanding-selections/">create new elements</a> in d3js is to use a data join.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.select(&quot;svg&quot;)
  .selectAll(&quot;rect&quot;)
  .data(d3.range(5))
  .enter()
  .append(&quot;rect&quot;);
</pre>
<p>The above snippet of code counts all the rect children of the svg element, and, if there are fewer than 5 &#8211; the number of items in d3.range(5), which is the [0,1,2,3,4] array &#8211; creates as many as needed to get to 5, and binds values to those elements &#8211; the contents of d3.range(5) in order. If there are already 5 rect elements, no new elements will be created, but the data assignment to the existing elements will still occur.</p>
<h2>Data joins, or the lack thereof</h2>
<p>The select / selectAll / data / enter / append sequence can sound exotic to people who learn d3js, but to its practitioners, <a href="http://www.jeromecukier.net/blog/2011/08/09/d3-adding-stuff-and-oh-understanding-selections/">it is its angular stone</a>. Not only is it a quick way to create many elements (which, in vanilla javascript, takes at least 2 steps. Creating them, and assigning them to the right parent), but it also associates them with a data element. That data element can then be accessed each time the element is being manipulated, notably when setting attributes or styles and handling events.</p>
<p>For instance,</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.selectAll(&quot;rect&quot;)
  .attr(&quot;x&quot;, function(d) {return 20 * d;});
</pre>
<p>the above code utilizes the fact that each of the rectangle have a different number associated with them to dynamically set an attribute, here position rectangles horizontally.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.selectAll(&quot;rect&quot;)
  .on(&quot;click&quot;, function(d) {console.log(d);})
</pre>
<p>A trick I had mentioned above, but which illustrates this point: here by clicking on each rectangle, we use the data join to show the associated data element.</p>
<p>Having data readily available when manipulating elements in d3js is extremely convenient. After all, data visualization is but the encoding of data through visual attributes. How to perform this operation without the comfort of data joins?</p>
<p>Simply by going back to the dataset itself.</p>
<p>Consider this:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var data = [];
var i;
for (i = 0; i &lt; 100; i++) {
  data.push({x: Math.random() * 300, y: Math.random() * 300}); // random data points
}

// d3 way
var d3svg = d3.select(&quot;body&quot;).append(&quot;svg&quot;);
d3svg.selectAll(&quot;circle&quot;).data(data).enter().append(&quot;circle&quot;)
  .attr({cx: function(d) {return d.x;}, cy: function(d) {return d.y}, r: 2})
  .style({fill: &quot;#222&quot;, opacity: .5});

// vanilla js way
var svgns = &quot;http://www.w3.org/2000/svg&quot;;
var svg = document.createElementNS(svgns, &quot;svg&quot;);
document.querySelector(&quot;body&quot;).appendChild(svg);
for (i = 0; i &lt; 100; i++) {
  var myCircle = document.createElementNS(svgns, &quot;circle&quot;);
  myCircle.setAttribute(&quot;cx&quot;, data[i].x);
  myCircle.setAttribute(&quot;cy&quot;, data[i].y);
  myCircle.setAttribute(&quot;r&quot;, 2);
  myCircle.style.fill = &quot;#222&quot;;
  myCircle.style.opacity = .5;
  svg.appendChild(myCircle);
}</pre>
<p class="codepen" data-height="268" data-theme-id="0" data-slug-hash="eNzaYg" data-default-tab="result" data-user="jckr">See the Pen <a href="http://codepen.io/jckr/pen/eNzaYg/">eNzaYg</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p><script src="//assets.codepen.io/assets/embed/ei.js" async=""></script>Both codes are equivalent. Vanilla JS is also marginally faster, but d3 code is much more compact. In d3js, the process from dataset to visual is:</p>
<ul>
<li>Joining dataset to container,</li>
<li>Creating as may children to container as needed, [repeat operation for as many levels of hierarchy as needed],</li>
<li>Use d3 selection objects to update the attributes and styles of underlying Node objects from the data items which have been joined to them.</li>
</ul>
<p>    In contrast, in vanilla Javascript, the process is:</p>
<ul>
<li>Loop over the dataset,</li>
<li>create, position and style elements as they are read from the dataset.</li>
</ul>
<p>For visuals with a hierarchy of elements, the dataset may also have a hierarchy and could be nested. In this case, there may be several nested loops. While the d3js code is much more compact, the vanilla approach is actually more simple conceptually. Interestingly, this is the same logic that is at play when creating visualization with Canvas or with frameworks like React.js. To simply loop over an existing, invariant dataset enables you to implement a stateless design and take advantage of immutability. You don&#8217;t have to worry about things such as what happens if your dataset changes or the status that your nodes are in before creating or updating them. By contrast most operations in d3js assume that you are constantly updating a scene on which you are keeping tabs. In order to create elements, you would first need to me mindful on existing elements, what data is currently associated with them, etc. So while the d3js approach is much more convenient and puts the data that you need at your fingertips, the vanilla JS approach is not without merits.</p>
<h2>Loading files</h2>
<p>The first word in data visualization is data, and data comes in files, or database queries. If you&#8217;re plotting anything with more than a few datapoints, chances are you are not storing them as a local variable in your javascript. d3js has a number of nifty functions for that purpose, such as d3.csv or d3.json, which allow to load the files asynchronously. The trick in working with files is that it can take some time, so some operations can take place while we wait for the files to load, but some others really have to wait for the event that the file is loaded to start. I personally almost always use queue.js, also from Mike Bostock, as I typically have to load data from several files and a pure d3 approach would require nesting all those asynchronous file functions. But, for loading a simple csv file, d3js has a really simple syntax:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.csv(&quot;myfile.csv&quot;, function(error, csv) {
  // voila, the contents of the file is now store in the csv variable as an array
})
</pre>
<p>For reference, using queue js, this would look like</p>
<pre class="brush: jscript; title: ; notranslate" title="">
queue()
 .defer(d3.csv, &quot;myFirstFile.csv&quot;)
 .defer(d3.csv, &quot;mySecondFile.csv&quot;)
 .await(ready);

function ready(error, first, second) {
  // the contents of myFirstFile is stored as an array in the variable &quot;first&quot;,
  // and the contents of mySecondFile are in the variable &quot;second&quot;.
}
</pre>
<p>The way to do the equivalent in vanilla Javascript is to use XMLHttpRequest.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
function readFile() {
  var fileLines = this.responseText.split(&quot;\n&quot;);
  var fields = fileLines[0].split(&quot;,&quot;);
  var data = fileLines.slice(1).map(function(d) {
    var item = {};
    d.split(&quot;,&quot;).forEach(function(v, i) {item[fields[i]] = v;})
    return item;
  })

  var request = new XMLHttpRequest();
  request.onload = readFile;
  request.open(&quot;get&quot;, &quot;myFile.csv&quot;, true);
  request.send();
</pre>
<p>The syntax of loading the file isn&#8217;t that cumbersome, and there are tons of nice things that can be done through XMLHttpRequest(), but let&#8217;s admit that d3js/queue.js functions make it much more comfortable to work with csv files.</p>
<h2>Animations</h2>
<p>d3js transitions is one of my favorite part of the library. I understand it&#8217;s also one the things which couldn&#8217;t be done well in protovis and which caused that framework to break. It feels so natural: you define what you want to animate, all that needs to change, the time frame and the easing functions, and you&#8217;re good to go (<a href="http://www.jeromecukier.net/blog/2012/07/16/animations-and-transitions/">see my previous post on animations and transitions</a>). In native javascript, while you can have deep control of animations, it&#8217;s also, unsurprisingly, much more cumbersome. However, CSS3 provides an animation interface which is comparable in flexibility, expressiveness and ease of use to what d3js does. First let&#8217;s get a high-level view of how to do this entirely within JS. Then let&#8217;s get a sense of what CSS can do.</p>
<h4>requestAnimationFrame and animation in JavaScript</h4>
<p>JavaScript has timer functions, window.setTimeout and window.setTimeinterval, which let you run some code after a certain delay or every so often, respectively. But this isn&#8217;t great for animation. Your computer draws to screen a fixed number of times per second. So if you try to redraw the same element several times before in between those times, it&#8217;s a waste of resources! What requestAnimationFrame does is tell your system to wait for the next occasion to draw to execute a given function. Here&#8217;s how it will look in general.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
function animate(duration) {
  var start = Date.now();
  var id = requestAnimationFrame(tick);
  function tick() {
    var time = Date.now();
    if (time - start &lt; duration) {
       id = requestAnimationFrame(tick);
       draw(time - start / duration);
    } else {
      cancelAnimationFrame(id);
    }
  }
  function draw(frame) {
    // do your thing, update attributes, etc.
  }
}
</pre>
<p>&nbsp;</p>
<p>See the Pen <a href="http://codepen.io/jckr/pen/PqzgLV/">PqzgLV</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p><script src="//assets.codepen.io/assets/embed/ei.js" async=""></script></p>
<p>OK so in the part I commented out, you will do the drawing proper. Are you out of the woods yet? well, one great thing about d3js transitions is that they use easing functions, which transform a value between 0 and 1 into another value between 0 and 1 so that the speed of the animation isn&#8217;t necessarily uniform. In my example, you have (time &#8211; start) / duration represents the proportion of animation time that has already elapsed, so that proportion can be further transformed.</p>
<p>So yay we can do everything in plain javascript, but that&#8217;s a lot of things to rewrite from scratch.</p>
<h4>CSS3, animations and transitions</h4>
<p>(This is not intended to be an exhaustive description of animations and transitions, a subject on which whole books have been written. Just to give those who are not familiar with it a small taste).</p>
<p>In CSS3, anything you can do with CSS, you can time and animate. But there are some caveats.</p>
<p>There are two similar concepts to handle appearance change in CSS: <em>animations</em> and <em>transitions</em>. What is the difference?</p>
<ul>
<li>with <em>animations</em>, you describe a @keyframes rule, which is a sequence of states that happen at different points in time in your transition. In each of these events, any style property can be changed. The animation will transform smoothly your elements to go from one state to the next.</li>
<li>in <em>transitions, </em>you specify how changes to certain properties will be timed. For instance, you can say that whenever opacity changes, that change will be staged over a 1s period, as opposed to happen immediately.</li>
</ul>
<p>Both approaches have their uses. CSS3 animations are great to create complex sequences. In d3js, that requires to &#8220;chain transitions&#8221;, which is the more complex aspect of managing them. By contrast, going from one segment of the animation to another is fairly easy to handle in CSS3. Animations, though, require the @keyframes rule to be specified ahead of time in a CSS declaration file. And yes, that can be done programmatically, but it&#8217;s cumbersome and not the intent. The point is: animations work better for complex, pre-designed sequence of events.</p>
<p>Transitions, in contrast, can be set as inline styles, and work fine when one style property is changed dynamically, a scenario which is more likely to happen in interactive visualizations.</p>
<p>Here&#8217;s how they work. Let&#8217;s start with animations.</p>
<p class="codepen" data-height="268" data-theme-id="0" data-slug-hash="vOKKYN" data-default-tab="result" data-user="jckr">See the Pen <a href="http://codepen.io/jckr/pen/vOKKYN/">vOKKYN</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p><script src="//assets.codepen.io/assets/embed/ei.js" async=""></script>Note: as of this writing, animation-related CSS properties have to be vendor prefixed, i.e. you have to repeat writing these rules for the different browsers. Here&#8217;s a transition in action.</p>
<p class="codepen" data-height="268" data-theme-id="0" data-slug-hash="xGOqOR" data-default-tab="result" data-user="jckr">See the Pen <a href="http://codepen.io/jckr/pen/xGOqOR/">xGOqOR</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p>For transition, you specify one style property to &#8220;listen&#8221; to, and say how changes to that property will be timed, using the transition: name of property + settings. (in the above example: transition: transform ease 2s means that whenever the &#8220;transform&#8221; style of that element changes, this will happen over a 2s period with an easing function). <script src="//assets.codepen.io/assets/embed/ei.js" async=""></script></p>
<p>One big caveat for both CSS animations and transitions is that they are limited to <em>style properties</em>. In HTML elements this is fine because everything that is related to their appearance is effectively handled by style: position, size, colors, etc. For SVG, however, color or opacity are styles, like in HTML, but positions, sizes and shapes are <em>attributes</em>, and can&#8217;t be directly controlled by CSS. There is a workaround for positions and sizes, which is to use the transform style property.</p>
<p>But wait: isn&#8217;t transform an SVG attribute as well? that&#8217;s right. And that&#8217;s where it can get <em>really </em>confusing. Many SVG elements are positioned through x and y properties (attributes). They can also have a transform property which is additive to that. For instance, if I have a &lt;rect&gt; which has an x property of 100 and a transform set at &#8220;translate(100)&#8221;, it will be positioned 200px right of its point of origin. But on top of that, SVG elements can have a transform <em>style </em>which affects pretty much the same things (position, scales, rotation&#8230;) but which has a slightly different syntax (&#8220;translate(100)&#8221;, for instance, wouldn&#8217;t work, you&#8217;d have to write &#8220;translateX(100px)&#8221;). What&#8217;s more, the transform set in the style doesn&#8217;t add to the one set in the properties, but it overrides it. If we add a &#8220;transform: translateX(50px)&#8221; to our &lt;rect&gt;, it will be positioned at 150px, not 200px or 250px. Another potential headache is that some SVG elements cannot support transform styles.<br />
While any of these properties can be accessed programmatically, managing their potential conflicts and overlaps can be difficult. In the transition example above, I have used the transform/translateX syntax.</p>
<p>That said, a lot of awesome stuff can be done in CSS only. For scripted animations, the animation in pure CSS is definitely more powerful and flexible than the d3js equivalent, however, when dealing with dynamically changing data, while you can definitely handle most things through CSS transitions, you&#8217;ll appreciate the comfort of d3js style transitions.</p>
<p class="codepen" data-height="268" data-theme-id="0" data-slug-hash="GJqrLO" data-default-tab="result" data-user="jckr">See the Pen <a href="http://codepen.io/jckr/pen/GJqrLO/">GJqrLO</a> by Jerome Cukier (<a href="http://codepen.io/jckr">@jckr</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p><script src="//assets.codepen.io/assets/embed/ei.js" async=""></script></p>
<p>Now a common transformation handled by d3js transitions is to transform the shape of path shapes. This is impossible through CSS animations/transitions, because the shape of the path &#8211; the &#8220;d&#8221; &#8211; is definitely not a style property. And sure, we can use a purely programmatic approach with requestAnimationFrame but is there a more high level way?<br />
It turns out there actually is &#8211; the animation element of SVG, or SMIL. Through SMIL, everything SVG can be animated with an interface, this includes moving an object along a path, which I wouldn&#8217;t know how to do on top of my head in d3js. Here is an extensive <a href="https://css-tricks.com/guide-svg-animations-smil/">explanation of how this works and what can be done</a>.</p>
<h2>Data processing, scales, maps and layouts</h2>
<p>For the end of the article let&#8217;s talk about all of which could technically be done without d3js, but in a much, much less convenient way. Therefore, I won&#8217;t be discussing alternatives with vanilla Javascript, which would be very work intensive and not necessarily inventive.</p>
<h4>Array functions and data processing</h4>
<p>d3js comes with a number of array functions. Some are here for convenience, such as d3.min or d3.max which can easily be replaced by using the native reduce method of arrays. When comparing only two variables, d3.max([a, b]) is not much more convenient than Math.max(a,b) or a &gt; b ? a : b.</p>
<p>Likewise, d3js has many statistical functions, which saves you the trouble to implement them yourself if you need them, such as d3.quantile. There are other libraries who do that, but they&#8217;re here and it&#8217;s really not useful to recode that from scratch.</p>
<p>d3js comes with shims for maps and sets, which will be supported by ES6. By now, there are transpilers which can let you use ES6 data structures. But it&#8217;s nice to have them.</p>
<p>In my experience, d3js most useful tool in terms of data processing is the d3.nest function, which can transform an array of objects into a nested object. (I wrote <a href="http://www.jeromecukier.net/blog/2012/05/28/manipulating-data-like-a-boss-with-d3/">this article</a> about them).  Underscore has something similar. While you can definitely getting a dataset of any shape and size by parsing an array and performing any grouping or operations manually, this is not only very tedious but <strong>also extremely error prone.</strong></p>
<h4>Scales</h4>
<p>Scales are one superb feature of d3js. They are simple to understand, yet very versatile and convenient. Oftentimes, d3 scales, especially the linear ones, are a replacement for linear algebra.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.scale.linear().range([100, 500]).domain([0, 24])(14);
((14 - 0) / (24 - 0)) * (500 - 100) + 100; // those two are equivalent (333.33...)
</pre>
<p>but changing the domain or the range of a scale is much safer using the scale than adhoc formulas. Add to this scale goodness such as the ticks() method or nice() to round the domain, and you get something really powerful.</p>
<p>So, of course it is possible (and straightforward, even) to replace the scales but that would be missing out one of the best features of d3js.</p>
<h4>Maps</h4>
<p>d3js comes with a full arsenal of functions and methods to handle geographic projections, ie: the transformation of longitude/latitude coordinates into x,y positions on screen. Those come in two main groups, projections proper that turn an array of two values (longitude, latitude) into an array of two values (x, y). There are also paths functions that are used to trace polygons, such as countries, from specially formatted geographic files (geoJSON, topoJSON).</p>
<p>The mercator projection may be straightforward to implement, But others are much less so. The degree of comfort that d3js provides when visualizing geographical data is really impressive.</p>
<h4>Layouts</h4>
<p>d3js layouts, that is special visual arrangements of data, were in my opinion one of the key drivers of protovis (where they originated) then d3js adoption. Through layouts, it became simple to create, with a few line of codes, complex constructions like treemaps or force-directed networks. Some layouts, like the pie chart or the dendogram, are here for convenience and could be emulated. Others, and most of all the force layout, are remarkably implemented, efficient and versatile. While they are called different names in d3js, geometry functions such as voronoi tessellation or convex hulls are similar functionally and there is little incentive in reproducing what they do in plain javascript.</p>
<h1>Should I stop using d3?</h1>
<p>d3js is definitely the most advanced javascript visualization library. The point of this article is not to get you to stop using it, but rather, to have a critical thinking in your code. Even with the best hammer, not everything is a nail.</p>
<p>To parse the DOM, manipulate classes and listen to events, you probably don&#8217;t need a library. The context of your code may make it more convenient to use d3 or jQuery or something else, but it&#8217;s useful to consider alternatives.<br />
The concept of the data join unlocks a lot of possibilities in d3js. A good understanding of data join would lead you to implement your visualization much faster, using more concise code and replicable logic. It also makes trouble shooting easier. Data joins are especially useful if you have a dataset which is structured like your visualization should be, or if you plan to have interaction with your visualization that requires quick access with the underlying data. However, data joins are not necessary in d3js, or in visualization in general. In many cases, it&#8217;s actually perfectly sensible to parse a dataset and create a visual representation in one fell swoop, without attaching the data to its representation or overly worrying about updating.</p>
<p>Assuming you have d3js loaded, nothing prevents you from creating elements using d3js append methods instead of vanilla javascript. Or to listen to events using addEventListener rather than with d3js on method. It&#8217;s totally ok to mix and match.</p>
<p>Like data joins, transitions are a very powerful component of d3js, and, once you&#8217;re comfortable with them, they are very expressive. There are other animation frameworks available though, which can be better adapted to the task at hand.<br />
Scale, maps, layouts and geometries are extremely helpful features however and I can think of no good reason to reimplement them.</p>
<h2>Credit where it&#8217;s due</h2>
<p>To write this I drew inspiration from many articles and I will try to list them all here.<br />
The spark that led me to write was Lea Verou&#8217;s article <a href="http://lea.verou.me/2015/04/jquery-considered-harmful/">jQuery considered harmful</a>, as well as articles she cites (<a href="http://youmightnotneedjquery.com/">you might not need jQuery</a>, <a href="http://blog.garstasio.com/you-dont-need-jquery/">you don&#8217;t need jQuery</a>, <a href="http://www.sitepoint.com/do-you-really-need-jquery/">Do you really need jQuery?</a>, <a href="http://tutorialzine.com/2014/06/10-tips-for-writing-javascript-without-jquery/">10 tips for writing JavaScript without jQuery</a>).</p>
<p>Most of the information I used especially in the beginning of the article comes more or less directly from <a href="https://developer.mozilla.org/en-US/">MDN documentation</a>, and direct experimentation. For CSS and animation, I found the articles of Chris Coyier (such as <a href="https://css-tricks.com/animating-svg-css/">this one</a> or <a href="https://css-tricks.com/animate-to-an-inline-style/">this one</a>) and Sara Soueidan (<a href="https://css-tricks.com/guide-svg-animations-smil/">here</a>) on <a href="https://css-tricks.com/">CSS Tricks</a> to be extremely helpful. Those are definitely among the first resources to check out to go deeper on the subject. Sara was also <a href="http://blogs.adobe.com/dreamweaver/2015/04/an-introduction-to-graphical-effects-in-css.html">the inspiration</a> behind <a href="http://www.jeromecukier.net/blog/2015/05/05/blending-mode-and-svg/">my previous post</a>, so thanks to her again!</p>
<p>Finally, I&#8217;ve read <a href="http://blog.webkid.io/replacing-jquery-with-d3/">Replacing jQuery with d3</a> with great interest (like <a href="http://snips.net/blog/posts/2014/01-10-fast-interactive_prototyping_with_d3_js.html">Fast interactive prototyping with d3js and sketch</a> about a year ago). It may seem that what I write goes in the opposite direction, but we&#8217;re really talking about the same thing -that there are many ways to power front ends and that it&#8217;s important to maintain awareness of alternative methods.</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1661" class="post-1661 post type-post status-publish format-standard hentry category-d3 category-tips">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2015/05/05/blending-mode-and-svg/" rel="bookmark"><time class="entry-date published" datetime="2015-05-05T23:56:46+00:00">May 5, 2015</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2015/05/05/blending-mode-and-svg/" rel="bookmark">Blending mode and SVG</a></h1>
         
    </header>
	<section class="post-content">

		<p>One great thing about canvas is that it&#8217;s super easy to change the compositing mode. And sure, you can do all sorts of fancy things with that, but my basic usage of that is to control how opacity is handled. By default, in svg, if you add one element which is not fully opaque on top of another, the top element makes the bottom element darker. By contrast, in canvas you can have access to globalCompositeOperation that let you change how new elements drawn on top of an existing image are handled, or in processing, you have blendMode, etc.</p>
<p>In SVG, there are a variety of operations accessible through filters: see <a href="http://apike.ca/prog_svg_filters.html">http://apike.ca/prog_svg_filters.html</a> for an excellent overview. I must admit that I find filters a bit intimidating to set up and need to always go back to a reference to achieve anything.</p>
<p>I was reading this article this morning on CSS graphical effects <a href="http://blogs.adobe.com/dreamweaver/2015/04/an-introduction-to-graphical-effects-in-css.html">http://blogs.adobe.com/dreamweaver/2015/04/an-introduction-to-graphical-effects-in-css.html</a> thinking, wouldn&#8217;t that be nice if we could do control compositing in SVG.</p>
<p>It turns out that we can! By manipulating the &#8220;mix-blend-mode&#8221; style attribute of any graphical element, we can achieve one of 16 blending modes (which is actually more than canvas or processing!)<br />
Here&#8217;s a demo that shows what can be done. This is an adaptation of <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/background-blend-mode">this</a> example.</p>
<p>So, through the use of the right blending mode, opacity can be used to make the resulting image lighter (among many other things).</p>
<p><iframe src="http://www.jeromecukier.net/stuff/blendmode/blendmode.html" width="600" height="750" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1598" class="post-1598 post type-post status-publish format-standard hentry category-d3 category-data-visualization">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2014/10/27/new-personal-project-slopes-of-san-francisco/" rel="bookmark"><time class="entry-date published" datetime="2014-10-27T07:03:30+00:00">October 27, 2014</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>			</span>
		        <h1 class="post-title"><a href="/2014/10/27/new-personal-project-slopes-of-san-francisco/" rel="bookmark">New personal project: slopes of San Francisco</a></h1>
         
    </header>
	<section class="post-content">

		<p>Hi, it&#8217;s been a while since I last posted!<br />
Here is a new project using publicly available data: <a href="http://jeromecukier.net/projects/slopes/slopes.html">slopes of San Francisco</a>.</p>
<p>As a San Franciscan who likes to walk, I&#8217;m confronted to a common problem. Most cities, such as Paris where I&#8217;m from, are mostly flat. So, in order to go one block east and one block north of where I am standing, I can go North then East or East then North: this is mostly equivalent (except that streets never meet at a right angle in Paris but that&#8217;s another problem). In San Francisco, going North then East can mean climbing a huge hill then down, versus walking on a flat surface. Itineraries matter, and often times I found myself going through mountains and valleys just because I thought the straight line was the simplest way to go from A to B.</p>
<p>Which is why I wanted to create a map of streets by slope, to help me (and my fellow San Franciscans) figure out which streets are practicable, and which should be avoided.</p>
<p>Here&#8217;s how I did it.</p>
<h2>Getting the data</h2>
<p>To compute slopes, I needed elevation data and the most convenient way to obtain it is through <a href="https://developers.google.com/maps/documentation/elevation/">google elevation API</a>. This API takes one or several points (longitude and latitude) and returns an elevation. Now which points was I going to feed it?</p>
<p>I started by the <a href="http://metro.teczno.com/#san-francisco">San Francisco metro extract</a> from Open Street Map. What you get is an XML file which has a list of nodes with longitudes and latitudes, and a list of structures that connect them (such as landmass, streets, buildings, etc.). Now the problem was that the file I used had some 1.4m nodes, and Google Elevation API limits are 25000 locations per 24 hour period.</p>
<p>So my first task was to figure out how many of those 1.4m nodes I really needed. Turns out that the metro extract covers much more than the city but also the whole bay area. So my first pass was to filter out nodes that were outside a bounding box. Then, I only kept nodes that were part of a street, and furthermore, only the ones that would be either at the end of one street or at an intersection. By doing so, I&#8217;m assuming that all streets are straight between any two intersections, which is far from true, but would do for our purposes. I applied further filtering to weed out streets that were made of just one node. Eventually, I arrived at just over 10000 nodes! and in the process, I also extracted from the XML file the shape of the streets, that is, in which order nodes appeared in those streets. After several iterations in my code, I also scrapped their number of lanes when available and the street names.</p>
<h2>Sanity check</h2>
<p>The first thing I did was to plot my nodes on a map.</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v0.png" alt="First draft" width="600" height="499" /><p class="wp-caption-text">First draft</p></div></p>
<p>Looks ok. So next, I just drawed my streets. I did that using d3, and each of my streets in this next iteration is a single path object.</p>
<p>&nbsp;</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v1.png" alt="First network of streets" width="600" height="506" /><p class="wp-caption-text">First network of streets</p></div></p>
<p>So that&#8217;s a basic node-and-link mesh of San Francisco, the problem with that approach is that I can only style one street (i.e. the links between the nodes) as a whole. However, what I wanted to highlight was where the streets were steep: many streets just go up and down, so giving them a single &#8220;steepness&#8221; rating wasn&#8217;t going to cut it.</p>
<h2>Encoding steepness</h2>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v2.png" alt="Segments of streets" width="600" height="506" /><p class="wp-caption-text">Segments of streets</p></div></p>
<p>The next logical step was to draw each of the edges individually (this time, they are lines, not paths). There are 6000+ &#8220;streets&#8221; (in the OSM sense &#8211; streets can be split in any number of different entities in Open Street Map), versus about 16000 different edges. I also found I didn&#8217;t really need to draw the nodes.</p>
<p>The obvious way was to encode steepness from green to red on a linear scale. That looks ok, but that&#8217;s not super interesting because it&#8217;s very difficult to tell whether one street is steeper than another just by comparing colors. I didn&#8217;t need an infinite variation of colors, I just wanted to know whether a street was flat (or quasi-flat), with a noticeable slope, or really steep. So instead of using a full linear scale, I just used 3 colors from the green &#8211; purple colorbrewer scale.</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v3.png" alt="Same map with discrete colors" width="600" height="516" /><p class="wp-caption-text">Same map with discrete colors</p></div></p>
<p>I could see instantly which streets were flat or not, yet wondered if there wasn&#8217;t a good simple way to compare between two streets which would be the steepest. Color is no good for that, but how about line width?</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v4.png" alt="Using line width to express steepness" width="600" height="500" /><p class="wp-caption-text">Using line width to express steepness</p></div></p>
<p>That was kind of an interesting aesthetics but I found it was difficult to find a precise cross street. When looking on a map of San Francisco, we instinctively look for larger streets like Market or Van Ness and if width was used by something else, it can be confusing. At that moment I didn&#8217;t have a good measure of street width, so I went back to my OSM extract and tried to scrap the number of lanes from my dataset.</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v5.png" alt="using street widths" width="600" height="374" /><p class="wp-caption-text">using street widths</p></div></p>
<p>You will notice that the streets now have an outline. I don&#8217;t draw the shape of each block, that would be too difficult given my dataset. Instead, for each street segment, I first draw a dark grey line, then on top of it, a slightly thinner colored line 🙂</p>
<h2>Have the map do something</h2>
<p>This being a data visualization I thought there could be interesting calculations that could be done with the map. My first intuition was to reuse the ideas of my <a href="http://www.jeromecukier.net/projects/metro/map.html">interactive Paris metro map</a> and make a deformed SF map based on the effort needed to go from one point of the map to everywhere, taking the slopes of the streets into account.</p>
<p>I basically refactored my code which I hadn&#8217;t visited in almost two years&#8230; and adapted shortest-path algorithms to my network of streets. It confirmed what I feared, that not all of my streets connect. Some streets in the map form tiny islands which are isolated from the rest of the network, and so cannot be reached from outside. I decided not to deal with it, debugging the dataset was really too complicated at this stage (and to be honest the filters I had used to extract the street data had already gone through many, many iterations).</p>
<p>I also used voronoi tessellation to create a layer of polygons on top of my nodes to capture clicks. The user can choose where to base their map, not by clicking on a precise cross street, but in the area around it, like so:</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v31.png" alt="Showing the voronoi layer on top of the map" width="600" height="353" /><p class="wp-caption-text">Showing the voronoi layer on top of the map</p></div></p>
<p>However, the results proved to be underwhelming.</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v6.png" alt="Deformed map by effort needed to walk from a given point" width="600" height="536" /><p class="wp-caption-text">Deformed map by effort needed to walk from a given point</p></div></p>
<p>All right, so some points are closer, some points are further, but overall it&#8217;s not a super interesting map. It&#8217;s less legible, and it doesn&#8217;t help me figuring out my initial problem: from a given point, which streets should I take to not go up and down?</p>
<p>So I was back to the drawing board. Now with the Dijkstra algorithm which I use to compute the shortest distance from one point to the others in the network, I can also get which path is the shortest, i.e. which is the actual itinerary, edge by edge, that takes me from one point to the others using the shortest path.</p>
<h2>Path-finding</h2>
<p>So my next idea was to hide all the edges that would not be in a shortest path. Again there were about 16000 edges, and 10000 nodes; there is only 1 shortest-path edge per node, so that&#8217;s hiding about 1/3 of the streets. Let&#8217;s see how this looks:</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v7.png" alt="All streets which are not in a shortest path are hidden." width="600" height="347" /><p class="wp-caption-text">All streets which are not in a shortest path are hidden.</p></div></p>
<p>That&#8217;s more interesting! At least, I know which streets I should not even consider from a given starting point.</p>
<p>I could do better: once this is done and a starting point is selected, I can actually draw the shortest path to wherever the user moves his or her mouse:</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v8.png" alt="Drawing the shortest path" width="600" height="346" /><p class="wp-caption-text">Drawing the shortest path</p></div></p>
<h2>Styling and wrapping it up</h2>
<p>In parallel I had worked on a page template to put everything on and my map looked kind of abstract. I had considered adding street names but algorithmically it&#8217;s pretty complicated (it would have been much quicker to do it completely manually but eventually I decided against that). I needed the map to belong to one specific part of the page as opposed to be just hanging in free space. For this I thought I really needed the shape of the land.</p>
<p>So I went back to my OSM dataset and this time looked at the nodes which were on coastlines. Coastlines, though, are lines, not shapes, so some reworking was in order. In the original dataset there were some 200 different lines. Many of them were outside San Francisco proper, but still by removing those there were about 50 left. Many of them could be joined, and I had just to do a tiny bit of manual stitching to come up with one landmass shape for San Francisco.</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v9.png" alt="Now with a landmass" width="600" height="330" /><p class="wp-caption-text">Now with a landmass</p></div></p>
<p>I tried various combinations for styling and finally fell back on using green, orange and red for the steepness &#8211; the very palette I avoided in the beginning. I used more balanced, slightly less saturated colors though.</p>
<p>One last thing I did on the data side was to get, for every node (which is every end of street or cross-street) the name of all the streets that go through it, so I could describe them &#8211; both the first node the user will click on and anyone he or she will mouseover on.</p>
<p><div style="width: 610px" class="wp-caption alignnone"><img class="" src="http://jeromecukier.net/projects/slopes/v10.png" alt="The end result!" width="600" height="361" /><p class="wp-caption-text">The end result!</p></div></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1572" class="post-1572 post type-post status-publish format-standard hentry category-d3 category-data-visualization category-tips">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2013/11/20/getting-beyond-hello-world-with-d3/" rel="bookmark"><time class="entry-date published" datetime="2013-11-20T07:26:33+00:00">November 20, 2013</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2013/11/20/getting-beyond-hello-world-with-d3/" rel="bookmark">Getting beyond hello world with d3</a></h1>
         
    </header>
	<section class="post-content">

		<p>About a year ago I proposed a <a href="http://www.jeromecukier.net/blog/2012/09/04/getting-to-hello-world-with-d3/">very simple template</a> to start working with d3. But is that the way I actually work? Of course not. Because, though you and I know that displaying hello world in d3 is not exactly trivial, this is not a highly marketable skill either. That said, I just can&#8217;t afford to start each of my projects from scratch.</p>
<p>So in this article I will present you the template I actually use. I won&#8217;t go in as much detail as last time because the exact instructions matter less than the general idea.</p>
<p>My template is a set of two files, an html file and a js file. Of course, extra files can be used as needed.</p>
<p>There&#8217;s not much to the html file &#8211; its role is really to call the javascript code. There is a little twist though. This is also where the interface elements (ie buttons and other controls) may be. Another thing is that I don&#8217;t load a css file through the html. The reason is that when I work with svg, I may export the svg proper to a file to have it reworked in Adobe Illustrator etc. and so having style inside the file makes things easier. So I would instead load a style sheet into the svg through javascript.</p>
<p>The javascript file is written with the following assumptions:</p>
<ul>
<li>there could be other scripts called by the same page, so let&#8217;s try to avoid conflict as much as possible.</li>
<li>some variables need not to be accessed by other scripts.</li>
<li>the execution of my visualization is divided into several phases:
<ul>
<li><strong>initialize: </strong>assigning initial values to variables, if needed forecasting interaction,</li>
<li><strong>loading data: </strong>acquiring and processing external data,</li>
<li><strong></strong><strong>drawing: </strong>this is where the visualization will be actually rendered or updated</li>
</ul>
<p>In addition to these three phases which always occur in my visualizations, there are several optional operations which I may or may not use which are included in the template.</p>
<ul>
<li><strong>reshaping data:<em> </em></strong>operations like filtering or sorting the initial dataset after certain choices of the user. Following such an operation, the visualization has to be re-rendered.</li>
<li><strong>self-playing animation</strong>: when this is required, then the visualization should be able to update itself at given intervals of time. If that is the case, then the html will include controls such as a start and stop button and a slider that can be used to move to an arbitrary time. Then, the javascript includes functions to start and stop the animation, and the drawing function is done so it can be called with a time argument, and not assuming that it will always just show the next step (because the slider can be used to jump ahead or back).</li>
<li><strong>helper functions </strong>which can make me gain time but which don&#8217;t need to be accessed by other scripts.</li>
</ul>
</li>
</ul>
<p>To address the first concern, I wrap all my code in an anonymous function, like so:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
(function() {
// ... my code
})();
</pre>
<p>within that function, any variable which is declared using the var keyword is not accessible to other scripts. Variables which are declared without the var keyword, however, can be accessed. So in order to minimize the footprint of my code, I create one single object, vis, so I can store the functions and values I will need to call as properties of that object. </p>
<pre class="brush: jscript; title: ; notranslate" title="">
(function() {
vis = {}
vis.init = function() {
// code for my init function ...
}
vis.height = 100;
var local = 50;
})();
</pre>
<p>So outside of that anonymous function, I can call vis.init(), I can access and change the value of vis.height, but I cannot access local.</p>
<p>One step further:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
(function() {
vis = {}
vis.init = function(params) {
  // code for my init function ...
  vis.loaddata(params);
}
vis.loaddata = function(params) {
  // code for loading data ...
  vis.draw(params);
}
vis.draw = function(params) {
  // code for drawing stuff ...
}
})();
</pre>
<p>This gets a bit closer to how the code actually works. From the HTML, I would call vis.init and pass it parameters. vis.init will do its thing (assigning values to variables, creating the svg object, preparing interactions etc.) then call vis.loaddata, passing the same parameters. vis.loaddata will fill its purpose (namely, load the data and perhaps do a little data processing on the side) then call the drawing function.</p>
<p>Any of these functions can be called from the outside (from the HTML, ot from the console for debugging). The nice thing about it is that nothing really happens unless there&#8217;s an explicit instruction to start the visualization.</p>
<p>Let&#8217;s go a step deeper:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
(function() {
vis = {}
var chart, svg, height, width;
vis.init = function(params) {
  if (!params) {params = {};}
  chart = d3.select(params.chart || &quot;#chart&quot;);
  height = params.height || 500;
  width = params.width || 960;
  chart.selectAll(&quot;svg&quot;).data([{height: height, width: width}]).enter().append(&quot;svg&quot;);
  svg = chart.select(&quot;svg&quot;);
  svg
   .attr(&quot;height&quot;, function(d) {return d.height;})
   .attr(&quot;width&quot;, function(d) {return d.width;})
  vis.loaddata(params);
}
vis.loaddata = function(params) {
  if (!params) {params = {};}
  d3.csv((params.data || &quot;data.csv&quot;) + (params.refresh ? (&quot;#&quot; + Math.random()) : &quot;&quot;), function(error, csv) {
    vis.csv = csv;
    vis.draw(params);
  })
}
vis.draw = function(params) {
  // code for drawing stuff ...
}
})();
</pre>
<p>Now we&#8217;re much closer to how it actually works. After we create our publicly accessible object vis, we create a bunch of local variables. Again, these can be used freely by the functions within our anonymous function, but not outside of it (notably in the console). I&#8217;m assuming that the code can be called without passing parameters, in which case within the functions I am testing if params actually exists, failing that I give it an empty object value. This is because down the road, if it is undefined and I try to access its properties, that would cause a reference error. If params has a value, even that of an empty object, if a property is not assigned, its value is &#8220;undefined&#8221;. So let&#8217;s take a look at the first 2 lines of vis.init:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
if(!params) {params = {};}
chart = d3.select(params.chart || &quot;#chart&quot;);
</pre>
<p>if params is not passed to vis.init, it gets an empty object value (that&#8217;s the first line). So, all of its properties have an undefined value. So the value of (params.chart || &#8220;#chart&#8221;) will be &#8220;#chart&#8221;. Likewise, if params is passed to vis.init, but without a chart property, params.chart will also be undefined, and (params.chart || &#8220;#chart&#8221;) will also be &#8220;#chart&#8221;. However, if params is passed to vis.init and a chart property is defined (i.e. vis.init({chart: &#8220;#mychart&#8221;}), then params.chart will be worth &#8220;#mychart&#8221; and (params.chart || &#8220;#chart&#8221;) will also be &#8220;#mychart&#8221;.<br />
So that construct of assigning an empty object value to params then using || is like giving default values which can be overridden.</p>
<p>Within vis.init, we use local variables for things like height, width etc. so we can redefine them with parameters, and they can be easily accessed by anything within the anonymous function, but not outside of it.<br />
I&#8217;ve also fleshed out the vis.loaddata function.<br />
Likewise, we use the same construct as above: instead of hardcoding a data file name, we allow it to be overridden by a parameter, but if none is specified, then we can use a default name.<br />
The part with params.refresh is a little trick.<br />
When developing/debugging, if your data is stored in a file, you are going to load that file many times. Soon enough your browser will use the cached version and not reload it each time. That&#8217;s great for speed, but not so great if you edit your file as part as your debugging process: changes would be ignored! By adding a hash and a random string of character at the end of the file name, you are effectively telling your browser to get your file from a different url, although it is the same file. What this does is that it will force your browser to reload the file each time. Once you&#8217;re happy with the shape of your file, you can stop doing that (by omitting the refresh parameter) and the browser may use a cached version of your file.<br />
In the vis.loaddata function, the most important part is that d3.csv method. As you may remember this is what loads your csv file (and btw if your data is not in csv form, d3 provides <a href="https://github.com/mbostock/d3/wiki/Requests">other methods to load external files</a> &#8211; d3.json, d3.text etc.). How this method works is that the associated function (i.e the bit that goes: function(error, csv) {}) is executed [em]once the file is loaded[/em].<br />
So since loading the file, even from cache, always take some time, what&#8217;s inside that function will be executed [em]after[/em] whatever could be written after the d3.csv method. This is why in the loaddata function, nothing is written after the d3.csv method, as there is no reliable way of knowing when that would be executed. The code continues inside the function. At the very end of that function, we call vis.draw, passing parameters along.<br />
If I need to load several files, I would nest the d3.csv functions like this:</p>
<pre class="brush: jscript; title: ; notranslate" title="">
d3.csv((params.data || &quot;data.csv&quot;), function(error, csv) {
  // .. do things with this first file
  d3.csv((params.otherfile || &quot;otherfile.csv&quot;), function (error, csv) {
    // .. and then things with that other file. repeat if necessary..

    // the end of the innermost function is when all files are loaded, so this is when we pass control to vis.draw
    vis.draw(params);
  })
})
</pre>
<p>Another way to do this is using <a href="https://github.com/mbostock/d3/wiki/Upgrading-to-3.0">queue.js</a> which I would recommend if the nesting becomes too crazy. For just 2 small files it&#8217;s a matter of personal preferences.</p>
<p>It&#8217;s difficult to write anything inside the code of vis.draw in a template, because this will have to be overwritten for every project. But here is the general idea though.<br />
vis.draw can be called initially to, well, draw the visualization a first time when nothing exists but an empty svg element. But it can also be called further down the road, if the user presses a button that changes how it should be displayed, etc.<br />
So, if the external context doesn&#8217;t change, running vis.draw once more should do nothing. As such, I avoid using constructs like &#8220;svg.append(&#8220;rect&#8221;) &#8221; and instead use &#8220;svg.selectAll(&#8220;rect&#8221;).data(vis.data).enter().append(&#8220;rect&#8221;)&#8221; systematically.<br />
The difference between the two is that using append without enter will add elements unconditionally. Using it after enter would only add new elements if there are new data items.<br />
But what if I need to draw just one element? well, instead of writing &#8220;svg.append(&#8220;rect&#8221;)&#8221;, I would write something like &#8220;svg.selectAll(&#8220;rect.main&#8221;).data([{}]).enter().append(&#8220;rect&#8221;).classed(&#8220;main&#8221;, 1)&#8221;.<br />
Let me explain what&#8217;s happening there.<br />
What I want is the function to create one single rectangle if it doesn&#8217;t exist already. To differentiate that rectangle from any other possible rectangles I am going to give it a class: &#8220;main&#8221;. Why a class and not an id if it is unique to my visualization? Well, I may want to have several of these visualizations in my page and ids should really be unique. So I never use ids in selections, to the exception of specifying the div where the svg element will sit.<br />
If there is already one rect element with the class &#8220;main&#8221;, svg.selectAll(&#8220;rect.main&#8221;).data([{}]).enter() will return an empty selection and so nothing will happen. No new rect element will be appended. This is great because we can run this as often as we want and what&#8217;s supposed not to change will not change.<br />
However, if there is no such rect element, since there is one item in the array that I pass via data, svg.selectAll(&#8220;rect.main&#8221;).data([{}]).enter().append(&#8220;rect&#8221;) will create one single rect element. The classed(&#8220;main&#8221;, 1) at the end will give it the &#8220;main&#8221; class, so that running that statement again will not create new rectangles. Using [{}] as default, one-item array is a convention, but it&#8217;s better than using, say [0] or [&#8220;&#8221;] because when manipulating our newly-created element, we can add properties to the data element (i.e. d3.selectAll(&#8220;rect.main&#8221;).attr(&#8220;width&#8221;, function(d) {d.width = 100; return d.width;}) ) which you couldn&#8217;t do if the data elements were not objects. (try this for yourself).</p>
<p>That being said, the general outline of the vis.draw function is so:</p>
<ul>
<li>remove all elements that need to be deleted,</li>
<li>create all elements that need to be added, including a bunch of one-off elements that will only be created once (ie legend, gridlines&#8230;)</li>
<li>select all remaining elements and update them (using transitions as needed).</li>
</ul>
<p>One last thing: how to call vis.init() in the first place? Well, the call would have to happen in the HTML file.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
&lt;script&gt;
var params = {data: &quot;data.csv&quot;, width:1400,height:800};
var query = window.location.search.substring(1);

var vars = query.split(&quot;&amp;&quot;);
vars.forEach(function(v) {
	var p = v.split(&quot;=&quot;);
	params[p[0]] = p[1]
})
vis.init(params);
&lt;/script&gt;
</pre>
<p>What&#8217;s going on there?<br />
First, I initiate the params variable with some values I want to pass in most cases.<br />
Then, the next line is going to look at the url of the page, and more specifically at the search part, that is, whatever happens after the ?. (I use .substring(1) as to not include the &#8220;?&#8221;).<br />
The idea is that when I would like to pass parameters via the browser, like so: &#8230;/vis.html?mode=1&#038;height=500&#038;data=&#8221;anotherfile.csv&#8221;<br />
The two splits (first by &#038;, then by =) allow to get the parameters passed by url, and add them to params, possibly overriding the existing ones.<br />
Then we pass the resulting params variable to vis.init. </p>
<p>Wihtout further ado, here are the two files in their entirety. </p>
<pre class="brush: xml; title: ; notranslate" title="">
&lt;!DOCTYPE html&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;
&lt;head&gt;
	&lt;title&gt;&lt;/title&gt;
	&lt;style&gt;

	&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;script src=&quot;http://d3js.org/d3.v3.min.js&quot;&gt;
&lt;/script&gt;
&lt;div id=&quot;chart&quot;&gt;&lt;/div&gt;
&lt;script src=&quot;template.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
var params = {data: &quot;data.csv&quot;, width:960,height:500};
var query = window.location.search.substring(1);

var vars = query.split(&quot;&amp;&quot;);
vars.forEach(function(v) {
	p=v.split(&quot;=&quot;);
	params[p[0]]=p[1]
})
vis.init(params);
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<pre class="brush: jscript; title: ; notranslate" title="">
(function() {
	vis={};
	var width,height;
	var chart,svg;
	var defs, style;
	var slider, step, maxStep, running;
	var button;

	vis.init=function(params) {
		if (!params) {params = {}}
		chart = d3.select(params.chart||&quot;#chart&quot;); // placeholder div for svg
		width = params.width || 960;
		height = params.height || 500;
		chart.selectAll(&quot;svg&quot;)
			.data([{width:width,height:height}]).enter()
			.append(&quot;svg&quot;);
		svg = d3.select(&quot;svg&quot;).attr({
			width:function(d) {return d.width},
			height:function(d) {return d.height}
		}); 
		// vis.init can be re-ran to pass different height/width values 
		// to the svg. this doesn't create new svg elements. 

		style = svg.selectAll(&quot;style&quot;).data([{}]).enter() 
			.append(&quot;style&quot;)
			.attr(&quot;type&quot;,&quot;text/css&quot;); 
		// this is where we can insert style that will affect the svg directly.

		defs = svg.selectAll(&quot;defs&quot;).data([{}]).enter()
			.append(&quot;defs&quot;); 
		// this is used if it's necessary to define gradients, patterns etc.

		// the following will implement interaction around a slider and a 
		// button. repeat/remove as needed. 
		// note that this code won't cause errors if the corresponding elements 
		// do not exist in the HTML.  
		
		slider = d3.select(params.slider || &quot;.slider&quot;);
		
		if (slider[0][0]) {
			maxStep = slider.property(&quot;max&quot;);
			step = slider.property(&quot;value&quot;);
			slider.on(&quot;change&quot;, function() {
				vis.stop(); 
				step = this.value; 
				vis.draw(params);})
			running = params.running || 0; // autorunning off or manually set on
		} else {
			running = -1; // never attempt auto-running
		}
		button = d3.select(params.button || &quot;.button&quot;);
		if(button[0][0] &amp;&amp; running&gt; -1) {
			button.on(&quot;click&quot;, function() {
				if (running) {
					vis.stop();
				} else {
					vis.start();
				}
			})
		};
		vis.loaddata(params);
	}
		
	vis.loaddata = function(params) {
		if(!params) {params = {}}
		d3.text(params.style||&quot;style.txt&quot;, function (error,txt) {
			// note that execution won't be stopped if a style file isn't found
			style.text(txt); // but if found, it can be embedded in the svg. 
			d3.csv(params.data || &quot;data.csv&quot;, function(error,csv) {
				vis.data = csv;
				if(running &gt; 0) {vis.start();} else {vis.draw(params);}
			})
		})
	}
	
	vis.play = function() {
		if(i === maxStep &amp;&amp; !running){
			step = -1; 
			vis.stop();
		}
		if(i &lt; maxStep) {
			step = step + 1; 
			running = 1;
			d3.select(&quot;.stop&quot;).html(&quot;Pause&quot;).on(&quot;click&quot;, vis.stop(params));
			slider.property(&quot;value&quot;,i);
		vis.draw(params);} else {vis.stop();}	
	}

	vis.start = function(params) {
		timer = setInterval(function() {vis.play(params)}, 50);
	}

	vis.stop = function (params) {
		clearInterval(timer);
		running = 0;
		d3.select(&quot;.stop&quot;).html(&quot;Play&quot;).on(&quot;click&quot;, vis.start(params));
	}

	vis.draw = function(params) {
		// make stuff here! 
	}
})();
</pre>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1524" class="post-1524 post type-post status-publish format-standard hentry category-d3 category-data-visualization">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2013/05/13/making-the-game-of-thrones-visualization/" rel="bookmark"><time class="entry-date published" datetime="2013-05-13T09:07:37+00:00">May 13, 2013</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>			</span>
		        <h1 class="post-title"><a href="/2013/05/13/making-the-game-of-thrones-visualization/" rel="bookmark">Making the game of thrones visualization</a></h1>
         
    </header>
	<section class="post-content">

		<p>So I made this <a href="http://www.jeromecukier.net/projects/agot/events.html">interactive visualization</a> about the 5 Game of Thrones books. How?</p>
<h2>The project</h2>
<p>The visualization is based on the events which happen to the main characters of the books. With over 2000 characters and close to 5000 pages over 343 chapters, it&#8217;s not possible to show everything, so I took about 300 characters and restricted to a small selection of events, such as characters killing each other. Also, I regrouped characters in a 2-level hierarchy so that it would be easier to find them and see what happens at a higher level.</p>
<h2>Data</h2>
<p>Data is the first word in data visualization, and in order to visualize one must collect data.<br />
this has not been a small task. When I read the books, which was a while back (before a Dance with Dragons was published), I had already half a mind to make a visualization, so I jotted down some notes but I had no clear idea of how it would look like. But I started writing down when in the books characters did die. Eventually I realized that if I wanted to prioritize characters I had to find a way to discriminate between those who appeared infrequently and could be left out, and those who were recurring. So, I had to find a way to determine when did the various characters appeared and what happened to them.</p>
<p>To achieve that I had the five books in printed version, which is definitely not the best way to approach this. So I tried to find something to scrape. So I approached this on two fronts. On one hand, I got a raw text version of the books. But they were very hard to scrape. For instance, there are at least 11 different characters named Pate (just Pate), and 23 called Jon something. Besides, many have aliases, titles and other names so a query to find all instances of &#8220;Jon&#8221; won&#8217;t capture all mentions of, say, Jon Snow, but will also return appearances of the Jon Conningtons, Jon Arryns and the like. To make matter worse, my text file was scanned from the book and was of less than optimal quality, with many typos on names.</p>
<p>The other source were the two fan-maintained ressources on the series, <a href="http://towerofthehand.com/">Tower of the Hand</a> and <a href="http://awoiaf.westeros.org/">a Wiki of Ice and Fire</a>, which both contain summaries of the chapters and information on the characters. Some chapters were described in meticulous detail with all the characters that appear specified, and a description of all that happens then. But others are more loosely narrated. That said, both sites propose an exhaustive list of characters of the books which were extremely useful.</p>
<p>So I first scraped a wiki of Ice and Fire to know which characters were mentioned in each chapter, then read the summaries to get a feel from the events happening, which I maintainted by hand.</p>
<p>With that first level of material, I decided to keep characters mentioned at least 5 times, or the named character who had been killed by another named character (as opposed to &#8220;a guard&#8221; being killed by &#8220;a soldier&#8221;). That left me with about 250 characters (out of slightly over 2000). Later, when the visualization became usable, playing with it I found some inconsistencies &#8211; how come this character is not dead yet in that book? That was because some characters were missing from my roster. So by checking in the original books, I increased the roster to about 300 (296 precisely). Also for most (and not all) characters, using the text file, I was able to get all the mentions of a given character in all the books.</p>
<h2>Data analysis</h2>
<p>I wanted to do something around the relationships among characters and I soon noticed that there are many cliques, that is groups of characters where every one of them trust every other one. This is the case of most families of organizations. When there is one character that defects, this is clearly signalled. You never get a situation where A trusts B but not C, B trusts C and not A and C trusts A and not B, or anything complex really.</p>
<p>But still, that&#8217;s many, many groups.</p>
<p>While in the books, families and groups are presented as independent entities, they almost always align on a larger, more powerful one. So it was interesting to regroup the smaller groups in larger alliances, especially if the focus was to represent kills</p>
<p>In the books most characters belong to or serve noble houses, and those who don&#8217;t belong to well-identified groups. There are very few characters who just mind their own business. There is a plethora of such Houses which can make things confusing (and again: 2000 characters). After several attempts I concluded it&#8217;s neither possible nor a good idea to represent this diversity visually. Instead, I tried to &#8220;group the groups&#8221; and to create higher-level aggregates.</p>
<p>Eventually (and I did that fairly late in the process, after few tries on the visualization) I created 5 groups. One for the Starks and the Lannisters, which are the families which receive the most attention during the book, as 70%  of the chapters are written from the point of view of a member of either family.Also, contrary to the Targaryen house whose point of view accounts for about 10% of the book, Starks and Lannisters have many allies and followers. So, as a consistent group they are larger and more interesting.</p>
<p>The other 3 groups are as follows: antagonists, that is aggressive characters (including monsters) who may attack any other; neutral characters, who tend to stay out of conflict, and opportunists, who look for more power.</p>
<p>Each of the 5 groups exhibits different patterns when it comes to killing: Starks (&#8220;the good guys&#8221;) don&#8217;t kill their own or neutral characters, but may have to fight characters from the other groups; conversely, some characters in the Lannister clan or among opportunists may carry out assassinations where anyone can be targeted. Neutral characters don&#8217;t fight except against antagonists, and the latter may fight characters from any group.</p>
<h2>Drawing the visualization</h2>
<p>I started thinking of that project a long time ago, and I&#8217;ve made experiments taking many forms. One of such form was a previous visualization on the <a href="http://www.jeromecukier.net/projects/agot/places.html">places in Games of Thrones</a>. That one visualization was the low-hanging fruit of the dataset I was building and refining. I knew I wanted to show events happening to the characters. Originally I thought of something linear, like a gantt chart, possibly grouping the characters by families which would be collapsable. But even in the broad sense that&#8217;s a lot of families, it wouldn&#8217;t make the visualization very legible.</p>
<p>What I had in mind then was to find a way to represent the status of the characters over time, who got killed, who got crippled, that sort of thing.</p>
<p>Eventually, I thought it was more interesting to represent the relationships of characters among themselves, so I started to take notice of all the interactions between characters, such as: who kills whom, who captures whom, who marries whom, etc. There were many which didn&#8217;t make it in the final visualization which is already complex enough as is.</p>
<p>I thought of the chord form early because it&#8217;s possible to use it to represent a lot of nodes and a lot of relationships among them even and even if it&#8217;s difficult to see one individual node expect the most important ones, and even more difficult to see one individual relationship, it&#8217;s possible to get a vague idea of mass. So I thought of representing characters as circles around a main circle coloring them by family or something. But doesn&#8217;t work, there are just too many different families. By so doing I was just plotting complexity.</p>
<p>Then, I realized that one very important aspect of the story, that is, one way in which a visualization could actually help understand what&#8217;s going on in the books, is that of trust. Within a group, all characters trust each other. Actually, this is much simpler than in real life: Westeros families are very close-knit; there are no murders among siblings or even though such things were commonplace in History! In network parlance, a group of entities which are all connected among each other is called a clique. And Game of Thrones is really a game of cliques. In all key moments of the book, one character of the clique will change sides. So all other characters of that clique continue to trust him, without realizing that he is setting them up, and a string of murders usually ensues.</p>
<p>So I decided to show action only at the clique level (families, organizations&#8230;). The problem I had was that once a character dies the representation of the clique won&#8217;t change much, whereas if I represented characters individually I could reflect that state of affairs.</p>
<p>So I thought of drawing one circle per clique around the main circle, and to represent characters individually within those circles using the packed circle method.</p>
<p>The method I chose was good (but not completely accurate) at preserving the relative importance of one clique compared to all the others, but just barely ok at preserving the relative importance of one given character.</p>
<p>I would take all the mentions of all the characters, tally that by clique, then take the square roots of that for each clique. Then, for each clique I compute the ratio of that square root to the sum of all the other square roots.</p>
<p>I multiply that by 2π and that&#8217;s an angle, that&#8217;s the &#8220;slice&#8221; of the main circle that will be occupied by the circle corresponding to that clique. Picture:<br />
<iframe src="http://www.jeromecukier.net/projects/agot/littleChords.html" frameborder="0" width="800px" height="500px"></iframe></p>
<p>(btw click on the circle on the left to regenerate the data points)</p>
<p>So while those proportions don&#8217;t exactly match they are very very close. That doesn&#8217;t hold at the character level, because the sum of the areas of the character circles can occupy anywhere between 50% and 100% of the areas of the larger circle. But that&#8217;s not important. Accuracy is not important, as long as it is sufficient to say: this character appears often and this one doesn&#8217;t.</p>
<p>Two other technical points about the making of the viz.<br />
All positions for all possible time periods had to be computed ahead of time.<br />
In d3, it is natural to add, add, add stuff over time without worrying so much. More data? we&#8217;ll just add more datapoints.<br />
Here I couldn&#8217;t really do that because I allowed the user to go back and forth in time. So a user could set the visualization in autoplay and go from time 0 to time 50, for instance, then pause and jump to time 200 and then back to time 25.<br />
So it wasn&#8217;t possible to read the datafile in sequence and to draw some additional data points at each step. In the above exemple, all that happens between time 50 and time 200 has to be shown <em>at once</em>, and then all that happened between time 25 and time 200 has to be hidden <em>at once</em>.</p>
<p>so it&#8217;s just a matter of separating the code that calculates all the positions from the one that draws the viz, two operations which more often than not are intertwined.</p>
<p>Last, in the visualization I get to write group names in a circle around the main circle. How is this done?</p>
<p>Well, in svg, you can&#8217;t write &#8220;on a circle&#8221;. You can write on a path, which can be anything, a circular arc for instance. In this case it&#8217;s a bit more complicated because I wanted to make sure that the writing would not be upside down. So I actually used two arcs.</p>
<p><iframe src="http://www.jeromecukier.net/projects/agot/littleTextPaths.html" width="500px" height="500px" frameborder=0></iframe></p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				
<article id="post-1548" class="post-1548 post type-post status-publish format-standard hentry category-d3 category-data-visualization category-tips tag-append tag-d3 tag-enter tag-exit tag-insert tag-remove tag-select tag-selectall tag-selections tag-tutorial">
		    <header class="post-header">
        			<span class="post-meta">
				<span class="posted-on"><a href="/2013/03/05/d3-tutorial-at-strata-redux/" rel="bookmark"><time class="entry-date published" datetime="2013-03-05T12:20:55+00:00">March 5, 2013</time></a></span><span class="byline"> by <span class="author vcard"><a class="url fn n" href="/author/jerome/">jerome</a></span></span> on <a href="/category/d3/" rel="category tag">d3</a>, <a href="/category/data-visualization/" rel="category tag">data visualization</a>, <a href="/category/tips/" rel="category tag">tips</a>			</span>
		        <h1 class="post-title"><a href="/2013/03/05/d3-tutorial-at-strata-redux/" rel="bookmark">Selections in d3 &#8211; the long story</a></h1>
         
    </header>
	<section class="post-content">

		<p>This past week, Scott Murray and I presented a tutorial at Strata on d3 (of all things!)<br />
First things first, you probably want to get <a href="http://amzn.com/1449339735">Scott&#8217;s book on the subject</a> when it&#8217;s out. I should be translating it into French eventually.<br />
You&#8217;re also welcome to the slides and examples of the tutorial which can be found on <a href="https://github.com/alignedleft/strata-d3-tutorial">https://github.com/alignedleft/strata-d3-tutorial</a>. That include my <a href="https://github.com/alignedleft/strata-d3-tutorial/blob/master/d3%20Cheat%20Sheet.pdf">d3 cheat sheet</a>.</p>
<p>We had done a d3 workshop a few months back at Visweek with Jeff Heer. This time around, we changed our approach: we covered less ground, went at a slower pace, but targeted what is in our opinion the most troublesome aspects of learning d3: selecting, creating and removing elements. </p>
<p>I have learned d3 from deciphering script examples and in the earliest ones one ubiquitous construct was this sequence : select / selectAll / data / enter / append.<br />
It does the work, so like everyone else I&#8217;ve copied it and reused very often. It happens to be the most proper way of adding new elements in most cases, but the point is, while learning d3, I (and many people before and after me) have copy/pasted it without understanding it deeply. Though, copy pasting something you don&#8217;t understand thoroughly is the best way to get errors you don&#8217;t understand any better, and it would prevent you from accessing the rest of the potential of the library. Conversely, once this is cleared, you can be &#8220;thinking in d3&#8221; and easily do many things you might have thought impossible before.</p>
<p>We did the tutorial hands-on, live coding most of the time. To follow through, I invite you to create or open an empty page with d3 loaded (such as <a href="http://www.jeromecukier.net/projects/template.html" title="d3 template" target="_blank">this one</a> &#8211; the link opens a new tab) and then open the &#8220;console&#8221; or &#8220;web developer tools&#8221; which allow you to type javascript statements directly, without having to write and load scripts. Here are the shortcuts to the console: </p>
<ul>
<li>Chrome: Ctrl-J (windows), ⌥ ⌘+j (Mac)</li>
<li>Firefox: Ctrl+Shift+k (windows), ⌥ ⌘+k (Mac)</li>
<li>Safari: Ctrl+Alt+c (windows), ⌥ ⌘+c (Mac)</li>
<li>IE9+: F12</li>
</ul>
<p>To make the best of this tutorial, please type the examples. Some tutorials show you impressive stuff and show you step by step how to do it. That&#8217;s not one of them. I&#8217;ve sticked to very, very basic and mundane things. We&#8217;ll be only manipulating HTML elements such as paragraphs, which I assume you have seen earlier (plot twist: you are reading one at this very moment)<br />
Some of the code snippets don&#8217;t work. That&#8217;s the idea! I think you can&#8217;t progress by merely copying code that works. It&#8217;s important that you try out code that looks reasonable but that doesn&#8217;t produce the expected result or that causes an error, but then understand why. </p>
<h2>Adding simple stuff</h2>
<h3>Creating elements</h3>
<p>Our empty page is, well, empty, so we are going to add stuff.<br />
to create elements, we need the <strong>append</strong> method in d3, which takes as an argument the type of element that needs to be created, while the <strong>html</strong> method at the end allow us to specify a text.</p>
<p>so let&#8217;s go ahead and type: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.append(&quot;h1&quot;).html(&quot;My beautiful text&quot;)</pre>
<p> and see what happens.</p>
<p>what do we get? and why is that?<br />
In d3, every element which is created cannot appear out of thin air, and must be <strong>added to a container</strong>. If we don&#8217;t specify a container element, we just can&#8217;t create anything.<br />
In HTML, most elements can be containers, that is, it&#8217;s usually possible to add elements to almost everything. Then again, our template is fairly empty, so we can select the <body> tag and take it from there.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).append(&quot;h1&quot;).html(&quot;My beautiful text&quot;)</pre>
<p>we&#8217;re in business! as long as there is a sensible place to put them, you can create as much stuff as you like. Since we&#8217;re on a roll, why won&#8217;t we throw in a few paragraphs (<strong>p</strong> element in HTML):</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).append(&quot;p&quot;).html(&quot;Look at me, I'm a paragraph.&quot;)
d3.select(&quot;body&quot;).append(&quot;p&quot;).html(&quot;And I'm another paragraph!&quot;)
d3.select(&quot;body&quot;).append(&quot;p&quot;).html(&quot;Woohoo! number 3 baby&quot;)</pre>
<p>and lo and behold, all our paragraphs appear in sequence. Simply beautiful.<br />
But wait! paragraphs are containers, too. Why don&#8217;t we try to add a <strong>span</strong> element to one paragraph? For those of you with no HTML knowledge, span elements are like paragraphs, except there is no line break by default at the end. </p>
<p>So let&#8217;s try this:</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;p&quot;).append(&quot;span&quot;).html(&quot;and I'm a span!&quot;)</pre>
<p>Before typing it, take a minute to think where you expect it to go.<br />
Then go ahead and type it.</p>
<p>Surprised?<br />
you may have guessed that our new bit of text could go on a line of its own at the end of the document, or at the end of the last paragraph. But instead, it goes at the end of the first paragraph.<br />
Why is that? well, our select method stops the first instance of whatever it tries to find. In our case, since we asked it to find paragraphs &#8211; p, it stopped at the first p element it found, and added the span at the end of it (app<em>end</em>).</p>
<h3>Beyond creating new things</h3>
<p>adding new elements to a page programmatically is kind of useful, but if d3 stopped at that you probably wouldn&#8217;t be so interested in this tutorial to begin with. You can also modify and manipulate elements. We&#8217;ve done that to some extent with the html method. But we can also modify the <em>style</em> of the elements, their <em>attributes</em> and their <em>properties</em>. For the time being, don&#8217;t bother too much about the difference between these three things. Style refers to the appearance of elements, attributes, to their structure, and properties, to what can be changed in realtime, like values in a form. But again, let&#8217;s not worry about that for now and let&#8217;s just follow along. Look at this code snippet:</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;p&quot;).style(&quot;color&quot;,&quot;red&quot;)</pre>
<p>this will select the first paragraph and change its style, so that the text color is changed to red.<br />
But wait! our first paragraph, isn&#8217;t that the one with a span at the end of it? What will happen to that bit of text? Well, type the statement to find out.<br />
All the paragraph, including its children (that is, everything added to it, in our case the span) is turned to red.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;span&quot;).style(&quot;color&quot;,&quot;blue&quot;)</pre>
<p>That singles out our span and writes it in blue. Can this be overturned?</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;p&quot;).style(&quot;color&quot;,&quot;red&quot;)</pre>
<p>That won&#8217;t change a thing. Our first paragraph is, in fact, already red. But its child, the span, has a style which overrides that of its parent. To have it behave like the rest, we can remove its style like so: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;span&quot;).style(&quot;color&quot;,null)</pre>
<p>then </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;p&quot;).style(&quot;color&quot;,&quot;green&quot;)</pre>
<p>it will behave like its parent, the paragraph.<br />
But let&#8217;s try something else: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;span&quot;).style(&quot;color&quot;,&quot;blue&quot;)</pre>
<p>we write our span in blue, </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;span&quot;).style(&quot;color&quot;,&quot;green&quot;)</pre>
<p>and now back in green, like its parent.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;p&quot;).style(&quot;color&quot;,&quot;red&quot;)</pre>
<p>What will happen?<br />
well, the paragraph turns red, but the span doesn&#8217;t. It&#8217;s still following its specific instruction to be written in green.</p>
<p>That goes to illustrate that children behave like their parents, unless they are given specific instructions. </p>
<p>For HTML elements, we can play with styles, not so much with attributes or properties. One thing worth noting though is that an element can be given a class or an id.</p>
<p>Classes and ids can be used to style elements using a cascading style sheet (CSS). Knowing how CSS works is entirely facultative in learning d3, since d3 by itself can take care of all styling needs. Though, knowing basic CSS is not the most useless of endeavors, and some sensible CSS statements can save a lot of tedious manipulation in d3.<br />
The other use of classes and ids is that they can be used to select elements.</p>
<p>Let&#8217;s reload our page so we start from scratch.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).append(&quot;p&quot;).html(&quot;First paragraph&quot;);
d3.select(&quot;body&quot;).append(&quot;p&quot;).html(&quot;Second paragraph&quot;).attr(&quot;class&quot;,&quot;p2&quot;);
d3.select(&quot;body&quot;).append(&quot;p&quot;).html(&quot;Third paragraph&quot;).attr(&quot;id&quot;,&quot;p3&quot;);
</pre>
<p>without the use of classes and ids, it&#8217;s still possible to select and manipulate the 2nd or 3rd instance of an element, but it&#8217;s a chore. You have to use <em>pseudo-classes</em> like d3.select(&#8220;p:nth-of-type(2)&#8221;) to select the 2nd instance of a paragraph, for instance.<br />
Personally, I&#8217;d rather avoid this and prefer using simpler statements. With classes and IDs set, we can write instead: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;.p2&quot;).html(&quot;I'm classy&quot;);
d3.select(&quot;#p3&quot;).html(&quot;I've got ideas&quot;);</pre>
<p>To select things of a given class, you must use a period before the name of the class. To select things of a certain id, you must use the hash sign.<br />
Here, we are looking for the first element of the p2 class. This happens to be our 2nd paragraph. When you know you will have to manipulate elements which are not easily accessible, you may as well give them classes which will make this easier down the road.</p>
<p>In theory, there should only be one element of a given ID in one page, so I recommend not using them dynamically unless you can be 100% sure that there will not be duplicates. And, in case you were wandering, one element can have several (even many) classes. </p>
<h2>Two birds, one stone</h2>
<h3>Introducing selectAll</h3>
<p>So far, we&#8217;ve changed properties of one element at a time. The exception was when we changed the colors of both a paragraph and a span, but even then, we were still technically only changing the characteristics of one paragraph, which its child, the span, just happened to inherit. </p>
<p>For a complex document, that can be super tedious, especially since we&#8217;ve seen that it&#8217;s not easy to retrieve an element which is not the first of its kind.</p>
<p>so let&#8217;s go ahead and type:</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).style(&quot;font-weight&quot;,&quot;bold&quot;);</pre>
<p>(for a little variety. I mean, changing text color is so 1994.)<br />
What was that? Everything turned to bold!</p>
<p>Indeed: while the select method returns the first element that matches the clause, selectAll matches them all.<br />
Let&#8217;s do more.<br />
We&#8217;re going to add a span to our first paragraph. </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;p&quot;).append(&quot;span&quot;)
.html(&quot;I'm a rebel child.&quot;)
.style(&quot;background-color&quot;,&quot;firebrick&quot;)</pre>
<p>we&#8217;re adding a gratuitous styling command.<br />
Now, let&#8217;s change the background color of all the paragraphs.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).style(&quot;background-color&quot;,&quot;aliceblue&quot;)</pre>
<p>As could be expected, the span doesn&#8217;t change its background color, and so it appears differently from its parent (which could be a desired effect &#8211; this gives us flexibility).<br />
but what if we wanted to change the background color of everything? can we do better?</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;*&quot;).style(&quot;background-color&quot;,&quot;whitesmoke&quot;)</pre>
<p> (quite fitting in these times of papal conclave)</p>
<p>Well &#8211; everything gets a background color of &#8220;white smoke&#8221; (which is a fine background color btw.). Including the &#8220;body&#8221; element &#8211; that is, everything on the page!<br />
selectAll(&#8220;*&#8221;) matches everything. With it, you can grab all the children, their children etc. (&#8220;descendants&#8221;. I know&#8230;) of a selection, or, if used directly like so: d3.selectAll(&#8220;*&#8221;), everything on the page.<br />
So we&#8217;ve seen we can select moaar. But can we be finer? Can we select the paragraphs and the spans only, without touching the rest?</p>
<p>we sure can!</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p, span&quot;).style(&quot;background-color&quot;,&quot;lawngreen&quot;)</pre>
<p>The outcome of that one statement probably won&#8217;t make it to our web design portfolio, but it does the trick: you can select as much as you like, or as little as you like. </p>
<h3>Nested selections</h3>
<p>To illustrate the next situation, let&#8217;s add a span to our document.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).append(&quot;span&quot;).html(&quot;select me if you can&quot;)</pre>
<p>Well, just like there is a way to select directly the 2nd paragraph using pseudo classes, there&#8217;s also a (complicated) way to select directly that last span (namely: selectAll(&#8220;span:not(p)&#8221;) )<br />
there&#8217;s also a simpler way which is what we&#8217;re interested in.<br />
let&#8217;s suppose we want to turn it to bold:<br />
we can just do</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;span&quot;).style(&quot;font-weight&quot;,&quot;bold&quot;);</pre>
<p>then change the first one: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;p&quot;).select(&quot;span&quot;).style(&quot;font-weight&quot;,null);</pre>
<p>Admittedly, the complicated way is more compact. But conceptually, the &#8220;simple&#8221; way is easier to follow: we can do a selection, and within that selection perform a newer selection, and so on and so forth. That way, we can get away with just using super simple selectors, as opposed to master the intricacies of CSS3 syntax. Do it for the people who will read your source code 🙂</p>
<p><strong>At this point: </strong></p>
<ul>
<li>You know how to dynamically create content. Pretty cool!</li>
<li>More! you can dynamically change every property of every element of the page. woot!</li>
<li>Bonus! you&#8217;re equipped with tactics to easily reach any element you want to change.</li>
</ul>
<p>You should also have a good grasp of d3.select, d3.selectAll and the difference between the two.<br />
what more could you possibly want? Well, since this is about data visualization, how about a way to tie our elements to data? This is what d3 is really about.</p>
<h2>Putting the data in data visualization</h2>
<h3>Introducing data: passing values to many elements at once</h3>
<p>So far, we&#8217;ve entered &#8220;hard coded&#8221; values for all of our variables. That&#8217;s fine, but we can&#8217;t really set our elements one by one. I mean, we could, but it&#8217;s no way to &#8220;industrialize&#8221; the way elements are created.<br />
Fortunately, d3 provides. Its more interesting characteristic is the ability to &#8220;bind&#8221; elements with data.</p>
<p>If you&#8217;ve followed the instructions step by step, you should have 3 paragraphs in the page. Plus a span afterwards, but whatever.<br />
Let&#8217;s introduce the data method. This will match an array of values to a selection of elements in the page. Let&#8217;s go: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var fs=[&quot;10px&quot;,&quot;20px&quot;,&quot;30px&quot;];
d3.selectAll(&quot;p&quot;).data(fs).style(&quot;font-size&quot;,function(d) {return d;})
</pre>
<p>wow wow wow what just happened?<br />
First, we create an array of values which we intelligently call fs (for font size).<br />
Then, right after the selectAll(&#8220;p&#8221;) which gathers a selection of elements (3 &#8220;p&#8221; elements to be exact), we specify a dataset using the data method.<br />
It just happens that our dataset has just the same number of items as our selection of elements!</p>
<p>finally, we use style, like we used to, with a twist: instead of providing one fixed value, which would affect our 3 p elements in the same way, we specify a function.<br />
This function will parse the dataset, and for each element, it will return the result of an operation in the corresponding data point: the result of the function on the first item for the first p element, the result on the 2nd item for our 2nd paragraph, and lastly the result on the last item for our last paragraph.<br />
We write the function with an argument: d. What is d? it&#8217;s nothing but a convention. We can call it anything. d is standard fare in d3 code because that&#8217;s the writing style of Mike Bostock, the author of the framework and of many of its examples.<br />
This function is nothing special, it returns the element itself, so we are passing &#8220;10px&#8221; for the font-size of our first paragraph, and so on and so forth (20px, 30px).<br />
As an aside, we can use the String function, which converts any element into a string, instead of writing function(d) {return d;}. So: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).data(fs).style(&quot;font-size&quot;,String)</pre>
<p> would also work and is shorter to write.</p>
<p>Let&#8217;s recap what just happened here, because this is important.<br />
We want to apply a dynamic transformation to a bunch of existing elements, as opposed to finding a way to select each individual element, and passing it a hard-coded value.<br />
What&#8217;s more, we want to apply a transformation of the same nature, but of a different magnitude, on each of these items. </p>
<p>How to proceed?<br />
well, first we create an array of values. That&#8217;s our fs boy over there.</p>
<pre class="brush: jscript; title: ; notranslate" title="">var fs=[&quot;10px&quot;,&quot;20px&quot;,&quot;30px&quot;];</pre>
<p>Then, we will first select all of the elements we want to modify, then we&#8217;ll tie our dataset to that selection. This is what selectAll, then data does.</p>
<pre class="brush: jscript; title: ; notranslate" title="">var selection=d3.selectAll(&quot;p&quot;).data(fs);</pre>
<p>By the way, I&#8217;ve stored the result of the selectAll then data in a variable. In the original example, I just &#8220;chained&#8221; the methods, that is, I followed each method by a period and another one. The two syntaxes are equivalent. Chaining works, because each of these methods returns a value which is itself a selection on which further operations can be done. This syntax works well through most of d3 with some exceptions which will be duly noted.</p>
<p>Then, we are going to change the style of the selection, using a function on our data.</p>
<pre class="brush: jscript; title: ; notranslate" title="">selection.style(&quot;font-size&quot;,function(d) {return d;})</pre>
<p> (or
<pre class="brush: jscript; title: ; notranslate" title="">selection.style(&quot;font-size&quot;,String)</pre>
<p>That function will run on each value of our dataset, and return one result per value, which will be passed to all elements in sequence.</p>
<p>At this stage you may have two questions:</p>
<ul>
<li>Can we use more sophisticated functions, because this one is kind of meh?</li>
<li>What happens if there is not the same number of items in the dataset and of elements?</li>
</ul>
<p>The second question is actually more complicated than the first, but we&#8217;ll answer it in painstaking detail.<br />
So let&#8217;s take care of the question on functions first.<br />
Yes, obviously, we can use the function not just to return the element, but to do any kind of calculation that a language such as javascript is capable of, which is nearly everything.<br />
To illustrate that, here are some variations of our initial code which will return the same result, but with a different form.</p>
<pre class="brush: jscript; title: ; notranslate" title="">
var fs=[10,20,30]; // no more px
d3.selectAll(&quot;p&quot;).data(fs).style(&quot;font-size&quot;,function(d) {return d+&quot;px&quot;;})
</pre>
<p>Here, instead of returning just the element, we append &#8220;px&#8221; at its end. Sadly, style(&#8220;font-size&#8221;,10) doesn&#8217;t work, but style(&#8220;font-size&#8221;,10+&#8221;px&#8221;) &#8211; which is the same as style(&#8220;font-size&#8221;,&#8221;10px&#8221;) is valid. </p>
<p>Here is yet another way.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).style(&quot;font-size&quot;,function(d,i) {return 10*(i+1)+&quot;px&quot;;})</pre>
<p>function(d,i) ? what is this devilry?<br />
Here, i (or anything we want to call it, as long as it&#8217;s the 2nd argument of this function) represents the order of the element in the selection, so the first gets a 0, the second a 1, etc. (well, in our example it goes to 3 elements, so the last one gets a 2).<br />
This may be a bit abstract to say here, but even if we haven&#8217;t passed data, this would still work &#8211; i represent the order of the element, not the data item. so, if no data had been passed, within this function call, d would be undefined, but i would still be equal to 0,1,2, &#8230; </p>
<p>The answer to the second question is the last great mystery of d3. Once you get this, you&#8217;re golden.</p>
<h3>Creating or removing the right number of elements depending on data</h3>
<p>Before we get further, let&#8217;s quickly introduce append&#8217;s reckless cousin, remove(). Writing remove at the end of a selection deletes all the corresponding elements from the document object model.<br />
so,
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).remove()</pre>
<p> would remove our 3 paragraphs. Let&#8217;s do it and get rid of our paragraphs.<br />
Actually, let&#8217;s do
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).selectAll(&quot;*&quot;).remove()</pre>
<p> and remove everything below the body.</p>
<p>Now, earlier, we were alluding to what could happen if we didn&#8217;t have the same number of elements as of items in our dataset.</p>
<p>That means that we should be able to do the following: </p>
<ul>
<li>If there are fewer elements than items in a dataset, create the missing elements</li>
<li>If there are fewer elements than items in a dataset, disregard the extra data items</li>
<li>If there are more elements than items in a dataset, remove the extra elements</li>
<li>If there are more elements than items in a dataset, don&#8217;t change the extra elements/li>
<li>As data are updated, keep some elements, remove some, add some</li>
</ul>
<p>Why would we want to do all of this?<br />
The first case is the most common. When we start a data visualization script, chances are that there are no elements yet but there is data, so you&#8217;ll want to add elements based on the data.<br />
Then, if you have interaction or animation, your dataset may be updated, and depending on what you intend to do you may just want to update the existing elements, create new ones, remove old ones, etc. That&#8217;s when you may want to do 2, 3 or 4.<br />
The last (5th case) is more complicated, but don&#8217;t worry, we&#8217;ve got you covered.</p>
<p>Right now, we should have 0 p elements on our page (and if for some reason this is not the case, feel free to reload it).</p>
<p>let&#8217;s create a variable like so: </p>
<pre class="brush: jscript; title: ; notranslate" title="">var text=[&quot;first paragraph&quot;,&quot;second paragraph&quot;,&quot;third paragraph&quot;];</pre>
<p>somewhat uninspired, I know, but let&#8217;s keep typing to a minimum, if you want to go all lyrical please go ahead.</p>
<p>We are smack in case 1: we&#8217;d like to create 3 paragraphs, we have 3 items in our dataset, but 0 elements yet.<br />
Here&#8217;s what we&#8217;ll type: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).selectAll(&quot;p&quot;).data(text).enter().append(&quot;p&quot;).html(String)</pre>
<p>A-ha! we meet again, select selectAll data enter append.<br />
After all we&#8217;ve done, select selectAll should make some sense, even though, at this stage, this selection returns 0 p elements. There are none yet.<br />
Then we pass data as we&#8217;ve done before. Note that there are 3 items in our dataset.</p>
<p>Then, we use the enter() statement. What it does is that it prepares one new element for every unmatched data item. We&#8217;ll expand a bit later on the true meaning of unmatched, but for the time being, let&#8217;s focus on the difference. We have 0 elements, but 3 data items. 3 &#8211; 0 = 3, so the enter() selection will prepare 3 new elements.<br />
What does prepare means? the elements are not created yet at this stage, but they will with the next command. Right after enter(), think of what&#8217;s created as placeholders for future element (Scott&#8217;s vocabulary), or buds that will eventually blossom into full-fledge elements (mine).<br />
After enter(), we specify an append(&#8220;p&#8221;) command. Previously, when we had used the append method, we created one element at a time. But in this case, we are going to create as many as there are placeholders returned by enter(). So, in our case, 3.<br />
You may legitimately wonder why we needed a select statement to begin with &#8211; after all, enter() works on the difference between selectAll and data. But when we are going to append elements, we will need to create them somewhere, to build them upon a container. This is what the first select does. Omit it, and you&#8217;ll have an error, because the system will be asked to create something without knowing where.<br />
The final method, html, will populate our paragraphs with text. The String function, which we have already seen, simply returns the content of each item in our dataset. </p>
<p>We&#8217;re using select > selectAll > data > enter > append, but hopefully you will see why (and if you don&#8217;t, hang on to the end of the article, and feel free to ask questions).</p>
<p>But let&#8217;s recap once more. Actually, let&#8217;s see the many ways to get this wrong (or, surprisingly, right)</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).data(text).enter().append(&quot;p&quot;).html(String)</pre>
<p>We&#8217;ve alluded to that: without a container to put them in, p elements can&#8217;t be created. This will result in a DOM error.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).selectAll(&quot;p&quot;).data(text).append(&quot;p&quot;).html(String)</pre>
<p>No enter statement. After the selectAll, the selection has 0 items. This doesn&#8217;t change after the data method. As such, append creates 0 new elements, and nothing changes in the document. (but no error though)</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).data(text).selectAll(&quot;p&quot;).enter().append(&quot;p&quot;).html(String)</pre>
<p>In many cases in d3, it&#8217;s ok to switch the order of chained methods, but that&#8217;s not true here. selectAll must come before data. We bind data to elements. The other way round would have made sense, but that&#8217;s the way it is. First selectAll, then data. Here, we get an error, because enter() can&#8217;t be fired directly from selectAll. </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).selectAll(&quot;wootwoot&quot;)
.data(text).enter().append(&quot;p&quot;).html(String)</pre>
<p>This actually works. Why?<br />
There are actually 0 elements of type &#8220;wootwoot&#8221; in our document, which may or may not surprise you. There are still 3 items in the dataset, so enter() returns space for 3 new elements. the next append subsequently creates 3 p elements, which are populated by the html method.<br />
It usually makes more sense to use the same selector in the selectAll and the append methods, but that&#8217;s not always the case. Sometimes, you will be selecting elements of a specific class, but in an append method, you have to specify the name of an element, not any selector. So you&#8217;d go </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).selectAll(&quot;.myClass&quot;)
.data(text).enter().append(&quot;p&quot;).html(String).attr(&quot;class&quot;,&quot;myClass&quot;)</pre>
<p>Now that we&#8217;ve seen a few variations on the subject, here is a really cool use of enter. Check this out: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.select(&quot;body&quot;).selectAll(&quot;h1&quot;).data([{}]).enter().insert(&quot;h1&quot;).html(&quot;My title&quot;)</pre>
<p>ok there are 3 things here worth mentioning. 2 are just for show, though it doesn&#8217;t hurt to know them, but the 3rd one is really neat and useful.<br />
In data, we&#8217;ve passed: [{}]. This is an array of one object which is empty. There are two interesting things with that construct, one is that there&#8217;s only one element, the other one is that it&#8217;s an object. When you pass objects, the functions you run on them (like in the attr or style methods) can be used to add properties to them or change them. If that doesn&#8217;t make sense yet, just accept for now that it gives you more flexibility than using, say, [0].<br />
We&#8217;ve used insert instead of append. What this means is that we&#8217;re adding things before the first child of our container, not at the end (ie after the last child). In other words, our h1 (a title) will go at the top of the body element &#8211; fitting.</p>
<p>But what&#8217;s really interesting is what would happen if you were to run that statement again &#8211; nothing. try it. See?<br />
Why is that? Well, on your first go, at a point where there are no h1 elements yet, it works the standard way &#8211; you do a selectAll that returns nothing, you bind a dataset with more elements, then enter prepares space for the unmatched elements &#8211; 1 in our case &#8211; and then append creates that element. You may notice that the html part doesn&#8217;t use the data.<br />
When you run it again, the selectAll finds one h1 element, there&#8217;s still one item in the dataset, so enter won&#8217;t find any unmatched element, so the subsequent append is ignored. </p>
<p>So, you can run this kind of thing in a loop safely, it will only do what it&#8217;s supposed to do on the first go, it will be ignored afterwards. Don&#8217;t be afraid to use this construct for all the unique parts of your visualization, so you won&#8217;t have to worry about creating them multiple times.</p>
<h3>Other cases of mismatch between data items and elements</h3>
<p>All right, so now we have 3 p elements and 3 items in our dataset.<br />
What happens if we do this: </p>
<pre class="brush: jscript; title: ; notranslate" title="">text2=[&quot;hello world&quot;]
d3.selectAll(&quot;p&quot;).data(text2).html(String)</pre>
<p> ?</p>
<p>There is now one item in the data set, versus 3 p elements. Try to make a guess before you type this in. At the tutorial, the audience made a few reasonable guesses, namely: the last 2 paragraphs will be removed, only &#8220;hello world&#8221; will remain. Or: all paragraphs will be changed to &#8220;hello world&#8221;.<br />
Either could happen if d3 was trying to be smart and guess your intent. Fortunately, d3 is no excel here and behaves consistently even if that means extra work for you. When you do that (and please try this now) what happens is that the first paragraph of text is changed and the other two are untouched.</p>
<p>We are in the case, change the matched elements, ignore the others. </p>
<p>By the way, by now you should be able to guess what would have happened if there had been an enter() right after the data. Do I hear&#8230; nothing? almost! There would be no unmatched data element, so enter() would not return anything. Besides, enter() would require an append afterwards to make anything. This is why you&#8217;ll get an error: html can&#8217;t work directly after enter(). you would need an append. </p>
<p>Now what if we want to remove the extra 2 elements? This is where the exit() method comes into play.<br />
exit() is pretty much to enter() what remove() is to append(). Kind of.</p>
<p>let&#8217;s see how this work by example.</p>
<p>let&#8217;s recreate our 3 p paragraphs just in case: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).remove();
d3.select(&quot;body&quot;).selectAll(&quot;p&quot;).data(text).enter().append(&quot;p&quot;).html(String);</pre>
<p>Now we pass the new dataset:</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).data(text2).html(String)</pre>
<p> &#8211; remember that only the first paragraph has changed, the other two are untouched.<br />
Now, while all the items in the dataset are matched with elements, there are elements which are not matched with an item in the dataset: the last two. This is where exit() comes into play. exit() will select those two paragraphs, so they can be manipulated. Typically, what happens then is a remove(), but you could think of other options.</p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).data(text2).exit().style(&quot;color&quot;,&quot;red&quot;);</pre>
<p>That will flag them instead of removing them.<br />
But typically, you do: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).data(text2).exit().remove();</pre>
<p>. </p>
<p>note that even though you have already matched a one item dataset to that selection, to use exit(), you will need to use data before. selectAll(&#8220;p&#8221;).exit() won&#8217;t work. You&#8217;ll have to re-specify the data match. </p>
<p>So that takes care of the case when you want to remove extraneous data items.<br />
This leaves us with only one simple case: where you have more items in your dataset than you have elements and you don&#8217;t want to create elements for the extra data items.<br />
That&#8217;s the simplest syntax, really.</p>
<p>Here, for instance, we have only one paragraph left, but there are 3 items in the text variable.<br />
so let&#8217;s do: </p>
<pre class="brush: jscript; title: ; notranslate" title="">d3.selectAll(&quot;p&quot;).data(text).html(String)</pre>
<p> (no enter, no exit, no append).<br />
The paragraph text will now come from the new dataset (from its first item to be precise), no extra paragraphs will be created, none will be deleted.</p>
<h3>Data joins</h3>
<p>the last case (pass a new dataset, create new elements as needed, make some elements stay and make some elements go) requires more complexity and actually I won&#8217;t cover it in detail here, instead I will explain the principle and refer you to this tutorial on <a href="http://bost.ocks.org/mike/constancy/">object constancy</a> by Mike Bostock.<br />
In the general case, when you try to match your dataset to your elements, you count them and deal with the difference. So you have 5 data items and 3 elements: you can make 2 extra elements appear by using enter. With the concept of data joins, you can assign precisely each data item to one given element, so the first data item doesn&#8217;t have to be that of the first element, etc. Well, the first time it will be, and each element will receive a key, a unique identifier from the dataset. If the dataset is subsequently updated, the element will only be matched if there is an item in the dataset with the same key. Else, it will be found by an exit() method. </p>
<p>And that&#8217;s the general gist of it.<br />
At Strata, we went further &#8211; we discussed interaction and transition, but that is downward trivial once you have understood &#8211; and by that, really understood, with all the implications and nuances &#8211; the selections.</p>
	    		<div class="clear">&nbsp;</div>
	</section>
</article><!-- #post-## -->
			
				<nav class="pagination navigation paging-navigation" role="navigation">
		<div class="nav-links">
						<div class="older-posts"><a href="/category/d3/page/2/" >Older Posts <span class="meta-nav">&rarr;</span></a></div>
							<div class="page-number">Page 1 of 3</div>
			
		</div><!-- .nav-links -->
	</nav><!-- .navigation -->
	
		
		</main><!-- #main -->
	</section><!-- #primary -->

	<div id="secondary" class="widget-area" role="complementary">
		<aside id="search-2" class="widget widget_search"><form role="search" method="get" class="search-form" action="/">
				<label>
					<span class="screen-reader-text">Search for:</span>
					<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
				</label>
				<input type="submit" class="search-submit" value="Search" />
			</form></aside>		<aside id="recent-posts-2" class="widget widget_recent_entries">		<h1 class="widget-title">Recent Posts</h1>		<ul>
					<li>
				<a href="/2018/04/09/hello-world/">Hello world!</a>
						</li>
					<li>
				<a href="/2016/08/17/the-big-leagues/">The big leagues</a>
						</li>
					<li>
				<a href="/2016/08/17/creating-a-react-visualization-web-app/">Creating a React visualization web app</a>
						</li>
					<li>
				<a href="/2016/08/13/beyond-rendering/">Beyond rendering</a>
						</li>
					<li>
				<a href="/2016/08/11/react-components/">React components</a>
						</li>
				</ul>
		</aside>		<aside id="recent-comments-2" class="widget widget_recent_comments"><h1 class="widget-title">Recent Comments</h1><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a href='https://wordpress.org/' rel='external nofollow' class='url'>A WordPress Commenter</a></span> on <a href="/2018/04/09/hello-world/#comment-1">Hello world!</a></li><li class="recentcomments"><span class="comment-author-link"><a href='http://omeraz.wordpress.com/' rel='external nofollow' class='url'>עומר עזריאל</a></span> on <a href="/2016/08/17/the-big-leagues/#comment-567">The big leagues</a></li><li class="recentcomments"><span class="comment-author-link">Carlos Ayres</span> on <a href="/2012/05/28/manipulating-data-like-a-boss-with-d3/#comment-312">Manipulating data like a boss with d3</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://migrate.powertripanalytics.com/game-of-thrones-interactions-among-the-top-30-characters/' rel='external nofollow' class='url'>Game of ThronesInteractions Among the Top 30 Characters &#8211; PowerTrip Analytics</a></span> on <a href="/2013/05/13/making-the-game-of-thrones-visualization/#comment-466">Making the game of thrones visualization</a></li><li class="recentcomments"><span class="comment-author-link"><a href='https://abgoswam.wordpress.com/2016/10/08/d3-getting-started/' rel='external nofollow' class='url'>D3 &#8211; Getting Started | abgoswam&#039;s tech blog</a></span> on <a href="/2012/09/04/getting-to-hello-world-with-d3/#comment-419">Getting to &#8220;Hello world&#8221; with d3</a></li></ul></aside><aside id="archives-2" class="widget widget_archive"><h1 class="widget-title">Archives</h1>		<ul>
			<li><a href='/2018/04/'>April 2018</a></li>
	<li><a href='/2016/08/'>August 2016</a></li>
	<li><a href='/2015/05/'>May 2015</a></li>
	<li><a href='/2015/02/'>February 2015</a></li>
	<li><a href='/2014/10/'>October 2014</a></li>
	<li><a href='/2013/11/'>November 2013</a></li>
	<li><a href='/2013/05/'>May 2013</a></li>
	<li><a href='/2013/03/'>March 2013</a></li>
	<li><a href='/2013/01/'>January 2013</a></li>
	<li><a href='/2012/12/'>December 2012</a></li>
	<li><a href='/2012/11/'>November 2012</a></li>
	<li><a href='/2012/10/'>October 2012</a></li>
	<li><a href='/2012/09/'>September 2012</a></li>
	<li><a href='/2012/07/'>July 2012</a></li>
	<li><a href='/2012/06/'>June 2012</a></li>
	<li><a href='/2012/05/'>May 2012</a></li>
	<li><a href='/2012/04/'>April 2012</a></li>
	<li><a href='/2012/01/'>January 2012</a></li>
	<li><a href='/2011/11/'>November 2011</a></li>
	<li><a href='/2011/10/'>October 2011</a></li>
	<li><a href='/2011/09/'>September 2011</a></li>
	<li><a href='/2011/08/'>August 2011</a></li>
	<li><a href='/2011/07/'>July 2011</a></li>
	<li><a href='/2011/06/'>June 2011</a></li>
	<li><a href='/2011/05/'>May 2011</a></li>
	<li><a href='/2011/04/'>April 2011</a></li>
	<li><a href='/2011/03/'>March 2011</a></li>
	<li><a href='/2011/02/'>February 2011</a></li>
	<li><a href='/2011/01/'>January 2011</a></li>
	<li><a href='/2010/11/'>November 2010</a></li>
	<li><a href='/2010/04/'>April 2010</a></li>
	<li><a href='/2010/03/'>March 2010</a></li>
	<li><a href='/2010/02/'>February 2010</a></li>
	<li><a href='/2010/01/'>January 2010</a></li>
	<li><a href='/2009/12/'>December 2009</a></li>
	<li><a href='/2009/10/'>October 2009</a></li>
	<li><a href='/2009/09/'>September 2009</a></li>
	<li><a href='/2009/08/'>August 2009</a></li>
	<li><a href='/2009/07/'>July 2009</a></li>
	<li><a href='/2009/06/'>June 2009</a></li>
	<li><a href='/2009/05/'>May 2009</a></li>
	<li><a href='/2008/12/'>December 2008</a></li>
	<li><a href='/2008/11/'>November 2008</a></li>
	<li><a href='/2008/10/'>October 2008</a></li>
		</ul>
		</aside><aside id="categories-2" class="widget widget_categories"><h1 class="widget-title">Categories</h1>		<ul>
	<li class="cat-item cat-item-2"><a href="/category/book-review/" >book review</a>
</li>
	<li class="cat-item cat-item-3"><a href="/category/charts/" >charts</a>
</li>
	<li class="cat-item cat-item-4"><a href="/category/conferences/" >conferences</a>
</li>
	<li class="cat-item cat-item-5 current-cat"><a href="/category/d3/" >d3</a>
</li>
	<li class="cat-item cat-item-6"><a href="/category/dashboards/" >dashboards</a>
</li>
	<li class="cat-item cat-item-7"><a href="/category/data-publishing/" >data publishing</a>
</li>
	<li class="cat-item cat-item-8"><a href="/category/data-visualization/" >data visualization</a>
</li>
	<li class="cat-item cat-item-9"><a href="/category/francais/" >français</a>
</li>
	<li class="cat-item cat-item-10"><a href="/category/javascript/" >javascript</a>
</li>
	<li class="cat-item cat-item-11"><a href="/category/presentation/" >presentation</a>
</li>
	<li class="cat-item cat-item-12"><a href="/category/protovis/" >protovis</a>
</li>
	<li class="cat-item cat-item-13"><a href="/category/react/" >react</a>
</li>
	<li class="cat-item cat-item-14"><a href="/category/tips/" >tips</a>
</li>
	<li class="cat-item cat-item-1"><a href="/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-15"><a href="/category/web-sites/" >web sites</a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta"><h1 class="widget-title">Meta</h1>			<ul>
						<li><a href="/wp-login.php">Log in</a></li>
			<li><a href="/feed/">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="/comments/feed/">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
			</aside>		<div class="clear">&nbsp;</div>
	</div><!-- #secondary -->
	<footer id="colophon" class="site-footer" role="contentinfo">
	    <a class="subscribe icon-feed" href="/feed/"><span class="tooltip">Subscribe!</span></a>
		<div class="site-info inner">
		    <section class="copyright">
		    			    		<a href="https://github.com/lacymorrow/casper" rel="home">Casper WP</a> by Lacy Morrow		    			    </section>
		</div><!-- .site-info -->
	</footer><!-- #colophon -->
</main><!-- /#content -->

<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.9b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPlain.js?ver=3.0.9b'></script>
<script type='text/javascript' src='/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.9b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://localhost:8888/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://localhost:8888/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='/wp-content/themes/casper/js/main.js?ver=1.0.0'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.10'></script>
<!--stats_footer_test--></body>
</html>
